<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniOrbit OS</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: #001b3d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Courier New", Courier, monospace;
            color: #fff;
        }

        .desktop {
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            max-width: 1100px;
            max-height: 700px;
            background: #003a8c;
            position: relative;
            overflow: hidden;
            border: 2px solid #00aaff;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
        }

        .desktop::before {
            content: "";
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.75);
            pointer-events: none;
        }

        .desktop::after {
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.18),
                rgba(0, 0, 0, 0.18) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }

        .wallpaper {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            bottom: 44px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" fill="%23003a8c"/><circle cx="20" cy="20" r="4" fill="%2300aaff"/><circle cx="60" cy="50" r="6" fill="%230088ee"/><circle cx="100" cy="80" r="3" fill="%23ffffff" fill-opacity="0.5"/><path d="M10 100 L40 70 L70 110" stroke="%2300ccff" stroke-width="2" fill="none"/></svg>');
            opacity: 0.25;
            pointer-events: none;
            z-index: 1;
        }

        .menu-bar {
            height: 24px;
            background: linear-gradient(to bottom, #0066cc, #004499);
            border-bottom: 1px solid #00c3ff;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 14px;
            font-size: 16px;
            position: relative;
            z-index: 5;
        }

        .menu-item {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            position: relative;
            user-select: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .dropdown {
            position: absolute;
            top: 22px;
            left: 0;
            min-width: 160px;
            background: #d0d0d0;
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
            display: none;
            z-index: 40;
        }

        .dropdown-item {
            padding: 6px 10px;
            color: #000;
            font-size: 15px;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #005bbb;
            color: #fff;
        }

        .clock {
            margin-left: auto;
            font-size: 16px;
            text-shadow: 1px 1px 0 #001f44;
            cursor: pointer;
        }

        .desktop-icons {
            position: relative;
            z-index: 3;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 32px;
            padding: 28px;
            max-width: 360px;
        }

        .icon {
            width: 72px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.18s ease;
        }

        .icon:hover {
            transform: translateY(-4px);
        }

        .icon-image {
            width: 56px;
            height: 56px;
            margin: 0 auto;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.8), rgba(0, 120, 255, 0.9));
            display: grid;
            place-items: center;
            font-size: 30px;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.5);
        }

        .icon-label {
            margin-top: 8px;
            padding: 2px 4px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.35);
            border-radius: 4px;
        }

        .window {
            position: absolute;
            display: flex;
            flex-direction: column;
            min-width: 280px;
            min-height: 200px;
            background: linear-gradient(to bottom, #c8c8c8, #9c9c9c);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #444;
            border-bottom-color: #444;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.5);
            z-index: 10;
            transform-style: preserve-3d;
            animation: zoom-in 220ms ease;
        }

        @keyframes zoom-in {
            from {
                opacity: 0;
                transform: perspective(800px) translateZ(-220px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }

        .window-header {
            height: 26px;
            background: linear-gradient(to right, #001a66, #0033aa);
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 10px;
            color: #fff;
            cursor: grab;
            user-select: none;
        }

        .window-title {
            flex: 1;
            font-weight: bold;
            text-shadow: 1px 1px 0 #001037;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-btn {
            width: 18px;
            height: 18px;
            background: linear-gradient(to bottom, #f0f0f0, #b8b8b8);
            border: 1px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #333;
            border-bottom-color: #333;
            display: grid;
            place-items: center;
            color: #111;
            font-size: 14px;
            cursor: pointer;
        }

        .window-btn:active {
            border-top-color: #333;
            border-left-color: #333;
            border-right-color: #fff;
            border-bottom-color: #fff;
        }

        .window-content {
            flex: 1;
            background: #d6d6d6;
            padding: 16px;
            overflow: auto;
            color: #000;
            font-size: 16px;
        }

        .disk-drive {
            position: absolute;
            bottom: 54px;
            right: 18px;
            width: 130px;
            height: 86px;
            background: linear-gradient(to bottom, #e0e0e0, #b3b3b3);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #666;
            border-bottom-color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 10px;
            gap: 8px;
            z-index: 3;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.5);
        }

        .drive-slot {
            width: 90px;
            height: 20px;
            background: #1c1c1c;
            position: relative;
        }

        .drive-light {
            position: absolute;
            width: 10px;
            height: 10px;
            right: 5px;
            top: 5px;
            border-radius: 50%;
            background: #ff3636;
            animation: drive-blink 1.6s infinite;
        }

        @keyframes drive-blink {
            0%, 100% {
                opacity: 0.35;
            }
            50% {
                opacity: 1;
            }
        }

        .task-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            padding: 0 10px;
            background: linear-gradient(to bottom, #0060c0, #003c86);
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 6;
        }

        .task-btn {
            padding: 4px 12px;
            background: linear-gradient(to bottom, #d0d0d0, #9a9a9a);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #444;
            border-bottom-color: #444;
            font-size: 14px;
            cursor: pointer;
        }

        .task-btn.active {
            background: linear-gradient(to bottom, #005bbb, #004092);
            color: #fff;
        }

        .status-bar {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 30px;
            height: 24px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.35);
            font-size: 14px;
            z-index: 5;
        }

        .dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(to bottom, #c0c0c0, #8c8c8c);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #444;
            border-bottom-color: #444;
            min-width: 320px;
            display: none;
            z-index: 50;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.5);
        }

        .dialog .window-header {
            cursor: default;
        }

        .dialog-content {
            padding: 20px;
            text-align: center;
            color: #000;
            background: #dcdcdc;
        }

        .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-top: 16px;
        }

        .dialog-btn {
            padding: 6px 18px;
            background: linear-gradient(to bottom, #f0f0f0, #bababa);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #444;
            border-bottom-color: #444;
            cursor: pointer;
            font-size: 15px;
        }

        .terminal-output {
            font-size: 15px;
            color: #0f0;
            background: #000;
            padding: 12px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .terminal-input {
            display: flex;
            gap: 8px;
        }

        .terminal-input input {
            flex: 1;
            font-size: 15px;
            padding: 6px 8px;
            border: 1px solid #555;
            font-family: inherit;
        }

        .terminal-input button {
            padding: 6px 12px;
            font-size: 15px;
            cursor: pointer;
            border: 1px solid #555;
            background: #0f0;
            color: #000;
            font-weight: bold;
        }

        .editor-toolbar,
        .notes-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .editor-toolbar button,
        .notes-toolbar button,
        .joke-actions button,
        .activity-actions button,
        .puzzle-actions button {
            padding: 6px 12px;
            font-size: 15px;
            border: 1px solid #555;
            background: linear-gradient(to bottom, #f5f5f5, #cfcfcf);
            cursor: pointer;
        }

        textarea,
        .text-editor-area {
            width: 100%;
            height: 100%;
            min-height: 200px;
            border: 1px solid #777;
            padding: 10px;
            font-family: inherit;
            font-size: 15px;
            resize: none;
        }

        .calc-display {
            width: 100%;
            height: 50px;
            border: 2px solid #444;
            margin-bottom: 10px;
            background: #111;
            color: #0f0;
            font-size: 28px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 12px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 12px 0;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid #444;
            background: linear-gradient(to bottom, #fafafa, #c8c8c8);
        }

        .calc-btn.operator {
            background: linear-gradient(to bottom, #007ad6, #0059a6);
            color: #fff;
        }

        .calendar {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-header button {
            border: 1px solid #333;
            padding: 4px 10px;
            cursor: pointer;
            background: #005bbb;
            color: #fff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            text-align: center;
            padding: 6px 0;
            border: 1px solid #999;
            background: rgba(255, 255, 255, 0.7);
            min-height: 32px;
        }

        .calendar-day.header {
            background: #005bbb;
            color: #fff;
            font-weight: bold;
        }

        .calendar-day.today {
            background: #ffbf47;
        }

        .game-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .game-tile {
            width: 58px;
            height: 58px;
            display: grid;
            place-items: center;
            font-size: 22px;
            border: 2px solid #003a8c;
            background: linear-gradient(135deg, #ffd966, #ff8a33);
            color: #000;
            cursor: pointer;
            user-select: none;
        }

        .game-tile.empty {
            background: rgba(0, 0, 0, 0.2);
            border-style: dashed;
        }

        .clock-display {
            font-size: 36px;
            text-align: center;
            margin-bottom: 10px;
        }

        .clock-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .joke-text,
        .activity-text {
            min-height: 100px;
            padding: 12px;
            border: 1px solid #777;
            background: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 900px) {
            .desktop {
                max-width: 100vw;
                max-height: 100vh;
            }

            .desktop-icons {
                padding: 18px;
                gap: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="desktop" id="desktop">
        <div class="wallpaper"></div>
        <div class="menu-bar" id="menu-bar">
            <div class="clock" id="clock">--:--:--</div>
        </div>
        <div class="desktop-icons" id="desktop-icons"></div>
        <div class="disk-drive">
            <div>Storage</div>
            <div class="drive-slot">
                <div class="drive-light"></div>
            </div>
            <small>MiniOrbit</small>
        </div>
        <div class="status-bar" id="status-bar">Booting MiniOrbit OS...</div>
        <div class="task-bar" id="task-bar"></div>
        <div class="dialog" id="welcome-dialog">
            <div class="window-header">
                <div class="window-title">MiniOrbit OS</div>
            </div>
            <div class="dialog-content"></div>
        </div>
    </div>
    <script>
        (() => {
            const state = {
                windows: [],
                zIndex: 10,
                windowCount: 0,
                cleanup: {}
            };

            const desktop = document.getElementById('desktop');
            const menuBar = document.getElementById('menu-bar');
            const clockEl = document.getElementById('clock');
            const iconsContainer = document.getElementById('desktop-icons');
            const statusBar = document.getElementById('status-bar');
            const taskBar = document.getElementById('task-bar');
            const welcomeDialog = document.getElementById('welcome-dialog');

            const jokeBank = [
                'Why do programmers prefer dark mode? Because light attracts bugs!',
                'How many bugs does it take to change a lightbulb? That\'s a hardware problem.',
                'I told my computer I needed a break, and it said "No problem, I\'ll go to sleep."',
                'The best thing about a Boolean is even if you\'re wrong, you\'re only off by a bit.',
                'Why do Java developers wear glasses? Because they don\'t see sharp.'
            ];

            const activityBank = [
                'Write a haiku about your current project.',
                'Sketch the UI of your dream app in a notebook.',
                'Take a quick stretch and roll your shoulders.',
                'List three things you learned this week.',
                'Refactor a function you wrote a month ago.'
            ];

            const appData = {
                status: 'Ready.',
                welcome: {
                    title: 'MiniOrbit OS',
                    lines: [
                        'Welcome to the compact edition of Orbit OS.',
                        'All apps live in this single HTML file.',
                        'Enjoy the retro workspace!'
                    ],
                    button: 'Let\'s Go'
                },
                menus: [
                    {
                        label: 'Project',
                        items: [
                            { label: 'System Info', type: 'system-info' },
                            { label: 'Terminal', type: 'terminal' },
                            { label: 'Notes', type: 'notes' },
                            { label: 'Reset Layout', action: resetLayout }
                        ]
                    },
                    {
                        label: 'Tools',
                        items: [
                            { label: 'Text Editor', type: 'text-editor' },
                            { label: 'Calculator', type: 'calculator' },
                            { label: 'Calendar', type: 'calendar' },
                            { label: 'Puzzle Game', type: 'puzzle-game' },
                            { label: 'Clock', type: 'clock' },
                            { label: 'Random Joke', type: 'jokes' },
                            { label: 'Random Activity', type: 'activity' }
                        ]
                    }
                ],
                icons: [
                    { type: 'terminal', emoji: '⌨️', label: 'Terminal' },
                    { type: 'text-editor', emoji: '📝', label: 'TextEdit' },
                    { type: 'notes', emoji: '🗒️', label: 'Notes' },
                    { type: 'calculator', emoji: '🧮', label: 'Calculator' },
                    { type: 'calendar', emoji: '📅', label: 'Calendar' },
                    { type: 'puzzle-game', emoji: '🧩', label: 'Puzzle' },
                    { type: 'clock', emoji: '⏰', label: 'Clock' },
                    { type: 'jokes', emoji: '😂', label: 'Jokes' },
                    { type: 'activity', emoji: '🎲', label: 'Activity' }
                ],
                windows: {
                    'system-info': {
                        title: 'System Information',
                        width: 320,
                        height: 280,
                        init(content) {
                            const now = new Date();
                            const info = [
                                ['MiniOrbit Version', 'v1.0'],
                                ['User Agent', navigator.userAgent],
                                ['Language', navigator.language],
                                ['Screen', `${window.screen.width}×${window.screen.height}`],
                                ['Viewport', `${window.innerWidth}×${window.innerHeight}`],
                                ['Time', now.toLocaleTimeString()],
                                ['Date', now.toLocaleDateString()]
                            ];
                            const list = info.map(([label, value]) => `<p><strong>${label}:</strong> ${value}</p>`).join('');
                            content.innerHTML = `<h2 style="margin-top:0">MiniOrbit Hardware Profile</h2>${list}`;
                        }
                    },
                    'terminal': {
                        title: 'CLI',
                        width: 460,
                        height: 320,
                        init(content, winId) {
                            const output = document.createElement('div');
                            output.className = 'terminal-output';
                            const form = document.createElement('form');
                            form.className = 'terminal-input';
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.placeholder = 'Type "help" for commands';
                            const submit = document.createElement('button');
                            submit.type = 'submit';
                            submit.textContent = 'Run';
                            form.append(input, submit);
                            content.append(output, form);

                            const history = [];
                            let historyIndex = 0;
                            function log(text) {
                                const line = document.createElement('div');
                                line.textContent = text;
                                output.appendChild(line);
                                output.scrollTop = output.scrollHeight;
                            }

                            const commands = {
                                help() {
                                    log('Available commands: help, clear, date, time, about, status');
                                },
                                clear() {
                                    output.innerHTML = '';
                                },
                                date() {
                                    log(new Date().toLocaleDateString());
                                },
                                time() {
                                    log(new Date().toLocaleTimeString());
                                },
                                about() {
                                    log('MiniOrbit OS — a single-file retro desktop demo.');
                                },
                                status() {
                                    log(statusBar.textContent);
                                }
                            };

                            log('MiniOrbit terminal ready. Type "help" to list commands.');

                            form.addEventListener('submit', event => {
                                event.preventDefault();
                                const cmd = input.value.trim();
                                if (!cmd) return;
                                log(`> ${cmd}`);
                                history.push(cmd);
                                historyIndex = history.length;
                                input.value = '';
                                const base = cmd.split(' ')[0].toLowerCase();
                                if (commands[base]) {
                                    commands[base]();
                                } else {
                                    log('Command not found. Try "help".');
                                }
                            });

                            input.addEventListener('keydown', event => {
                                if (!history.length) return;
                                if (event.key === 'ArrowUp') {
                                    event.preventDefault();
                                    historyIndex = Math.max(historyIndex - 1, 0);
                                    input.value = history[historyIndex] || '';
                                } else if (event.key === 'ArrowDown') {
                                    event.preventDefault();
                                    historyIndex = Math.min(historyIndex + 1, history.length);
                                    input.value = history[historyIndex] || '';
                                }
                            });
                        }
                    },
                    'text-editor': {
                        title: 'Text Editor',
                        width: 520,
                        height: 360,
                        init(content) {
                            const toolbar = document.createElement('div');
                            toolbar.className = 'editor-toolbar';
                            const saveBtn = document.createElement('button');
                            saveBtn.textContent = 'Download TXT';
                            const clearBtn = document.createElement('button');
                            clearBtn.textContent = 'Clear';
                            const textArea = document.createElement('textarea');
                            textArea.className = 'text-editor-area';
                            textArea.value = 'Welcome to MiniOrbit OS!\n\nTake notes, experiment and build.';
                            toolbar.append(saveBtn, clearBtn);
                            content.append(toolbar, textArea);

                            saveBtn.addEventListener('click', () => {
                                const blob = new Blob([textArea.value], { type: 'text/plain' });
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = 'miniorbit-note.txt';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                                setStatus('Text exported as file.');
                            });

                            clearBtn.addEventListener('click', () => {
                                textArea.value = '';
                                setStatus('Editor cleared.');
                            });
                        }
                    },
                    'notes': {
                        title: 'Notes',
                        width: 420,
                        height: 320,
                        init(content, windowId) {
                            const toolbar = document.createElement('div');
                            toolbar.className = 'notes-toolbar';
                            const info = document.createElement('span');
                            info.textContent = 'Autosaves to browser storage';
                            info.style.flex = '1';
                            const clearBtn = document.createElement('button');
                            clearBtn.textContent = 'Clear';
                            toolbar.append(info, clearBtn);

                            const textArea = document.createElement('textarea');
                            const storageKey = 'miniorbit-notes';
                            textArea.value = localStorage.getItem(storageKey) || '';

                            content.append(toolbar, textArea);

                            const save = () => {
                                localStorage.setItem(storageKey, textArea.value);
                                setStatus('Notes saved.');
                            };

                            textArea.addEventListener('input', () => {
                                save();
                            });

                            clearBtn.addEventListener('click', () => {
                                textArea.value = '';
                                save();
                            });

                            state.cleanup[windowId] = () => {
                                localStorage.setItem(storageKey, textArea.value);
                            };
                        }
                    },
                    'calculator': {
                        title: 'Calculator',
                        width: 260,
                        height: 340,
                        init(content) {
                            const display = document.createElement('div');
                            display.className = 'calc-display';
                            display.textContent = '0';
                            const grid = document.createElement('div');
                            grid.className = 'calc-grid';
                            const buttons = [
                                'C', '±', '%', '/',
                                '7', '8', '9', '*',
                                '4', '5', '6', '-',
                                '1', '2', '3', '+',
                                '0', '.', '=',
                            ];

                            let current = '0';
                            let stored = null;
                            let operation = null;
                            let resetOnNext = false;

                            function updateDisplay(value) {
                                display.textContent = value;
                            }

                            function calculate() {
                                const a = parseFloat(stored ?? '0');
                                const b = parseFloat(current);
                                switch (operation) {
                                    case '+':
                                        return a + b;
                                    case '-':
                                        return a - b;
                                    case '*':
                                        return a * b;
                                    case '/':
                                        return b === 0 ? '∞' : a / b;
                                    case '%':
                                        return a % b;
                                    default:
                                        return b;
                                }
                            }

                            buttons.forEach(symbol => {
                                const btn = document.createElement('button');
                                btn.className = 'calc-btn';
                                if ('/*-+=%'.includes(symbol)) btn.classList.add('operator');
                                btn.textContent = symbol;
                                grid.appendChild(btn);

                                btn.addEventListener('click', () => {
                                    if (!isNaN(Number(symbol)) || symbol === '.') {
                                        if (resetOnNext) {
                                            current = symbol === '.' ? '0.' : symbol;
                                            resetOnNext = false;
                                        } else {
                                            if (symbol === '.' && current.includes('.')) return;
                                            current = current === '0' && symbol !== '.' ? symbol : current + symbol;
                                        }
                                        updateDisplay(current);
                                        return;
                                    }

                                    if (symbol === 'C') {
                                        current = '0';
                                        stored = null;
                                        operation = null;
                                        resetOnNext = false;
                                        updateDisplay(current);
                                        return;
                                    }

                                    if (symbol === '±') {
                                        current = String(parseFloat(current) * -1 || 0);
                                        updateDisplay(current);
                                        return;
                                    }

                                    if (symbol === '=') {
                                        if (operation) {
                                            const result = calculate();
                                            updateDisplay(String(result));
                                            current = String(result);
                                            stored = null;
                                            operation = null;
                                            resetOnNext = true;
                                        }
                                        return;
                                    }

                                    if (symbol === '%') {
                                        current = String(parseFloat(current) / 100);
                                        updateDisplay(current);
                                        return;
                                    }

                                    if (['+', '-', '*', '/'].includes(symbol)) {
                                        if (operation && !resetOnNext) {
                                            const result = calculate();
                                            current = String(result);
                                            updateDisplay(current);
                                        }
                                        stored = current;
                                        operation = symbol;
                                        resetOnNext = true;
                                        return;
                                    }
                                });
                            });

                            content.append(display, grid);
                        }
                    },
                    'calendar': {
                        title: 'Calendar',
                        width: 340,
                        height: 360,
                        init(content, windowId) {
                            let referenceDate = new Date();
                            const calendar = document.createElement('div');
                            calendar.className = 'calendar';
                            const header = document.createElement('div');
                            header.className = 'calendar-header';
                            const prev = document.createElement('button');
                            prev.textContent = '◀';
                            const title = document.createElement('h3');
                            title.style.margin = '0';
                            const next = document.createElement('button');
                            next.textContent = '▶';
                            header.append(prev, title, next);
                            const grid = document.createElement('div');
                            grid.className = 'calendar-grid';
                            calendar.append(header, grid);
                            content.append(calendar);

                            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                            function render() {
                                grid.innerHTML = '';
                                const displayDate = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
                                title.textContent = displayDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                                weekdays.forEach(day => {
                                    const cell = document.createElement('div');
                                    cell.className = 'calendar-day header';
                                    cell.textContent = day;
                                    grid.appendChild(cell);
                                });

                                const startDay = displayDate.getDay();
                                const daysInMonth = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 0).getDate();
                                for (let i = 0; i < startDay; i++) {
                                    const filler = document.createElement('div');
                                    filler.className = 'calendar-day';
                                    filler.innerHTML = '&nbsp;';
                                    filler.style.visibility = 'hidden';
                                    grid.appendChild(filler);
                                }

                                const today = new Date();
                                for (let day = 1; day <= daysInMonth; day++) {
                                    const cell = document.createElement('div');
                                    cell.className = 'calendar-day';
                                    cell.textContent = String(day);
                                    if (
                                        day === today.getDate() &&
                                        displayDate.getMonth() === today.getMonth() &&
                                        displayDate.getFullYear() === today.getFullYear()
                                    ) {
                                        cell.classList.add('today');
                                    }
                                    grid.appendChild(cell);
                                }
                            }

                            prev.addEventListener('click', () => {
                                referenceDate = new Date(referenceDate.getFullYear(), referenceDate.getMonth() - 1, 1);
                                render();
                            });

                            next.addEventListener('click', () => {
                                referenceDate = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 1);
                                render();
                            });

                            render();
                        }
                    },
                    'puzzle-game': {
                        title: '15 Puzzle',
                        width: 320,
                        height: 420,
                        init(content) {
                            const container = document.createElement('div');
                            container.className = 'game-container';
                            const heading = document.createElement('h3');
                            heading.textContent = 'Arrange the tiles';
                            const board = document.createElement('div');
                            board.className = 'game-board';
                            const actions = document.createElement('div');
                            actions.className = 'puzzle-actions';
                            const shuffleBtn = document.createElement('button');
                            shuffleBtn.textContent = 'New Game';
                            actions.append(shuffleBtn);
                            container.append(heading, board, actions);
                            content.append(container);

                            let tiles = [];

                            function isSolvable(arr) {
                                let inversions = 0;
                                for (let i = 0; i < arr.length; i++) {
                                    for (let j = i + 1; j < arr.length; j++) {
                                        if (arr[i] && arr[j] && arr[i] > arr[j]) inversions++;
                                    }
                                }
                                const emptyRowFromBottom = 3 - Math.floor(arr.indexOf(0) / 4);
                                return (inversions + emptyRowFromBottom) % 2 === 0;
                            }

                            function shuffle() {
                                do {
                                    tiles = Array.from({ length: 16 }, (_, i) => i);
                                    for (let i = tiles.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
                                    }
                                } while (!isSolvable(tiles));
                                render();
                            }

                            function render() {
                                board.innerHTML = '';
                                tiles.forEach((value, index) => {
                                    const tile = document.createElement('div');
                                    tile.className = 'game-tile';
                                    tile.dataset.index = index;
                                    if (value === 0) {
                                        tile.classList.add('empty');
                                        tile.textContent = '';
                                    } else {
                                        tile.textContent = String(value);
                                    }
                                    tile.addEventListener('click', () => move(index));
                                    board.appendChild(tile);
                                });
                            }

                            function move(index) {
                                const emptyIndex = tiles.indexOf(0);
                                const validMoves = [
                                    emptyIndex - 1,
                                    emptyIndex + 1,
                                    emptyIndex - 4,
                                    emptyIndex + 4
                                ];

                                if (!validMoves.includes(index)) return;
                                const row = Math.floor(index / 4);
                                const emptyRow = Math.floor(emptyIndex / 4);
                                if (row === emptyRow || index === emptyIndex - 4 || index === emptyIndex + 4) {
                                    [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
                                    render();
                                    checkWin();
                                }
                            }

                            function checkWin() {
                                const solved = tiles.slice(0, 15).every((value, i) => value === i + 1);
                                if (solved && tiles[15] === 0) {
                                    setStatus('Puzzle solved! Great job.');
                                }
                            }

                            shuffleBtn.addEventListener('click', shuffle);
                            shuffle();
                        }
                    },
                    'clock': {
                        title: 'Clock',
                        width: 260,
                        height: 220,
                        init(content, windowId) {
                            let use24h = false;
                            const display = document.createElement('div');
                            display.className = 'clock-display';
                            const controls = document.createElement('div');
                            controls.className = 'clock-controls';
                            const toggle = document.createElement('button');
                            toggle.textContent = 'Toggle 24h';
                            controls.append(toggle);
                            content.append(display, controls);

                            const update = () => {
                                const now = new Date();
                                const options = { hour12: !use24h, hour: '2-digit', minute: '2-digit', second: '2-digit' };
                                display.textContent = now.toLocaleTimeString(undefined, options);
                            };
                            const interval = setInterval(update, 1000);
                            update();

                            toggle.addEventListener('click', () => {
                                use24h = !use24h;
                                update();
                            });

                            state.cleanup[windowId] = () => clearInterval(interval);
                        }
                    },
                    'jokes': {
                        title: 'Random Joke',
                        width: 360,
                        height: 260,
                        init(content) {
                            const text = document.createElement('div');
                            text.className = 'joke-text';
                            const actions = document.createElement('div');
                            actions.className = 'joke-actions';
                            const button = document.createElement('button');
                            button.textContent = 'New Joke';
                            actions.append(button);
                            content.append(text, actions);

                            function showJoke() {
                                const joke = jokeBank[Math.floor(Math.random() * jokeBank.length)];
                                text.textContent = joke;
                                setStatus('Delivered a fresh joke.');
                            }

                            button.addEventListener('click', showJoke);
                            showJoke();
                        }
                    },
                    'activity': {
                        title: 'Random Activity',
                        width: 360,
                        height: 240,
                        init(content) {
                            const text = document.createElement('div');
                            text.className = 'activity-text';
                            const actions = document.createElement('div');
                            actions.className = 'activity-actions';
                            const button = document.createElement('button');
                            button.textContent = 'Suggest One';
                            actions.append(button);
                            content.append(text, actions);

                            function showActivity() {
                                const idea = activityBank[Math.floor(Math.random() * activityBank.length)];
                                text.textContent = idea;
                                setStatus('New activity suggestion ready.');
                            }

                            button.addEventListener('click', showActivity);
                            showActivity();
                        }
                    }
                }
            };

            function setStatus(text) {
                statusBar.textContent = text;
            }

            function resetLayout() {
                const open = [...state.windows];
                open.forEach(closeWindow);
                setStatus('Layout reset to defaults.');
            }

            function buildMenus() {
                const existingClock = clockEl;
                menuBar.innerHTML = '';
                appData.menus.forEach(menu => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.textContent = menu.label;
                    const dropdown = document.createElement('div');
                    dropdown.className = 'dropdown';
                    menu.items.forEach(entry => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.textContent = entry.label;
                        div.addEventListener('click', event => {
                            event.stopPropagation();
                            dropdown.style.display = 'none';
                            if (entry.type) {
                                openWindow(entry.type);
                            } else if (typeof entry.action === 'function') {
                                entry.action();
                            }
                        });
                        dropdown.appendChild(div);
                    });
                    item.appendChild(dropdown);
                    item.addEventListener('click', event => {
                        event.stopPropagation();
                        document.querySelectorAll('.dropdown').forEach(d => {
                            if (d !== dropdown) d.style.display = 'none';
                        });
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });
                    menuBar.appendChild(item);
                });
                menuBar.appendChild(existingClock);

                document.addEventListener('click', () => {
                    document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
                });
            }

            function buildIcons() {
                iconsContainer.innerHTML = '';
                appData.icons.forEach(icon => {
                    const el = document.createElement('div');
                    el.className = 'icon';
                    el.innerHTML = `<div class="icon-image">${icon.emoji}</div><div class="icon-label">${icon.label}</div>`;
                    el.addEventListener('click', () => openWindow(icon.type));
                    iconsContainer.appendChild(el);
                });
            }

            function bringToFront(windowEl) {
                windowEl.style.zIndex = ++state.zIndex;
                state.windows = state.windows.filter(id => id !== windowEl.id);
                state.windows.push(windowEl.id);
                updateTaskBar();
            }

            function openWindow(type) {
                const config = appData.windows[type];
                if (!config) return;
                const id = `window-${++state.windowCount}`;
                const win = document.createElement('div');
                win.className = 'window';
                win.id = id;
                win.dataset.windowType = type;
                win.style.width = `${config.width}px`;
                win.style.height = `${config.height}px`;
                const offset = 40 + (state.windowCount * 18) % 120;
                win.style.top = `${offset}px`;
                win.style.left = `${offset}px`;

                const header = document.createElement('div');
                header.className = 'window-header';
                const title = document.createElement('div');
                title.className = 'window-title';
                title.textContent = config.title;
                const controls = document.createElement('div');
                controls.className = 'window-controls';
                const minBtn = document.createElement('div');
                minBtn.className = 'window-btn';
                minBtn.textContent = '_';
                const maxBtn = document.createElement('div');
                maxBtn.className = 'window-btn';
                maxBtn.textContent = '□';
                const closeBtn = document.createElement('div');
                closeBtn.className = 'window-btn';
                closeBtn.textContent = '×';
                controls.append(minBtn, maxBtn, closeBtn);
                header.append(title, controls);
                const content = document.createElement('div');
                content.className = 'window-content';
                win.append(header, content);
                desktop.appendChild(win);

                state.windows.push(id);
                bringToFront(win);
                makeDraggable(win, header);

                closeBtn.addEventListener('click', () => closeWindow(id));
                minBtn.addEventListener('click', () => minimizeWindow(id));
                maxBtn.addEventListener('click', () => maximizeWindow(id));

                if (typeof config.init === 'function') {
                    config.init(content, id);
                }

                updateTaskBar();
                setStatus(`${config.title} opened.`);
            }

            function closeWindow(id) {
                const win = document.getElementById(id);
                if (!win) return;
                if (typeof state.cleanup[id] === 'function') {
                    try {
                        state.cleanup[id]();
                    } finally {
                        delete state.cleanup[id];
                    }
                }
                win.remove();
                state.windows = state.windows.filter(winId => winId !== id);
                updateTaskBar();
            }

            function minimizeWindow(id) {
                const win = document.getElementById(id);
                if (!win) return;
                win.dataset.display = win.style.display;
                win.style.display = 'none';
                updateTaskBar();
            }

            function maximizeWindow(id) {
                const win = document.getElementById(id);
                if (!win) return;
                if (win.dataset.maximized === 'true') {
                    win.style.width = win.dataset.restoreWidth;
                    win.style.height = win.dataset.restoreHeight;
                    win.style.top = win.dataset.restoreTop;
                    win.style.left = win.dataset.restoreLeft;
                    win.dataset.maximized = 'false';
                } else {
                    win.dataset.restoreWidth = win.style.width;
                    win.dataset.restoreHeight = win.style.height;
                    win.dataset.restoreTop = win.style.top;
                    win.dataset.restoreLeft = win.style.left;
                    win.style.top = '32px';
                    win.style.left = '12px';
                    win.style.width = 'calc(100% - 40px)';
                    win.style.height = 'calc(100% - 96px)';
                    win.dataset.maximized = 'true';
                }
                bringToFront(win);
            }

            function makeDraggable(win, handle) {
                let startX = 0;
                let startY = 0;
                let originX = 0;
                let originY = 0;

                const pointerDown = event => {
                    if (win.dataset.maximized === 'true') return;
                    if (event.target.closest('.window-controls')) return;
                    event.preventDefault();
                    bringToFront(win);
                    startX = event.clientX;
                    startY = event.clientY;
                    originX = parseInt(win.style.left || '0', 10);
                    originY = parseInt(win.style.top || '0', 10);
                    document.addEventListener('pointermove', pointerMove);
                    document.addEventListener('pointerup', pointerUp);
                };

                const pointerMove = event => {
                    const dx = event.clientX - startX;
                    const dy = event.clientY - startY;
                    win.style.left = `${originX + dx}px`;
                    win.style.top = `${originY + dy}px`;
                };

                const pointerUp = () => {
                    document.removeEventListener('pointermove', pointerMove);
                    document.removeEventListener('pointerup', pointerUp);
                };

                handle.addEventListener('pointerdown', pointerDown);
            }

            function updateTaskBar() {
                taskBar.innerHTML = '';
                state.windows.forEach(id => {
                    const win = document.getElementById(id);
                    if (!win) return;
                    const btn = document.createElement('div');
                    btn.className = 'task-btn';
                    if (win.style.display !== 'none') btn.classList.add('active');
                    btn.textContent = win.querySelector('.window-title').textContent;
                    btn.addEventListener('click', () => {
                        if (win.style.display === 'none') {
                            win.style.display = 'flex';
                        }
                        bringToFront(win);
                    });
                    taskBar.appendChild(btn);
                });
            }

            function showWelcome() {
                const { title, lines, button } = appData.welcome;
                welcomeDialog.querySelector('.window-title').textContent = title;
                const content = welcomeDialog.querySelector('.dialog-content');
                content.innerHTML = `${lines.map(line => `<p>${line}</p>`).join('')}<div class="dialog-buttons"><div class="dialog-btn" id="welcome-ok">${button}</div></div>`;
                welcomeDialog.style.display = 'block';
                const ok = document.getElementById('welcome-ok');
                ok.addEventListener('click', () => {
                    welcomeDialog.style.display = 'none';
                    openWindow('terminal');
                }, { once: true });
            }

            function initClock() {
                let use24 = false;
                clockEl.addEventListener('click', () => {
                    use24 = !use24;
                    update();
                });
                const update = () => {
                    const now = new Date();
                    clockEl.textContent = now.toLocaleTimeString(undefined, { hour12: !use24 });
                };
                setInterval(update, 1000);
                update();
            }

            function updateViewportHeight() {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            }

            function init() {
                buildMenus();
                buildIcons();
                initClock();
                updateViewportHeight();
                window.addEventListener('resize', updateViewportHeight);
                setStatus(appData.status);
                showWelcome();
            }

            init();
        })();
    </script>
</body>
</html>
