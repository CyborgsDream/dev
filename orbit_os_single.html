<!--
 * @version   v1.9.1
 * @codename  "ZoomWin"
 * @author    Prof. Adrian Zephyr
 * @date      2025-08-12
 * @log       Add 3D zoom animations for windows
 * @changelog
 *   - [2025-08-12] Implemented 3D open/close zoom effects.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit OS v 0.2.0</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'VT323', monospace;
        }
        
        body {
            background: #005;
            min-height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
        }
        
        .desktop {
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background: #0055aa;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.5);
            border: 2px solid #00aaff;
        }
        
        /* CRT scanlines effect */
        .desktop::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 100;
        }
        
        /* CRT curvature effect */
        .desktop::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            z-index: 101;
            border-radius: 5px;
        }
        
        .menu-bar {
            height: 24px;
            background: linear-gradient(to bottom, #0066cc, #004499);
            border-bottom: 1px solid #00aaff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 18px;
            color: #fff;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .menu-item {
            margin-right: 15px;
            cursor: pointer;
            text-shadow: 1px 1px 1px #000;
            position: relative;
            padding: 0 5px;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .dropdown {
            position: absolute;
            top: 24px;
            left: 0;
            background: linear-gradient(to bottom, #a0a0a0, #808080);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            min-width: 180px;
            display: none;
            z-index: 100;
        }
        
        .dropdown-item {
            padding: 5px 10px;
            cursor: pointer;
            border-bottom: 1px solid #999;
        }
        
        .dropdown-item:hover {
            background: rgba(0, 0, 255, 0.4);
            color: #fff;
        }
        
        .clock {
            margin-left: auto;
            text-shadow: 1px 1px 1px #000;
            font-size: 18px;
        }
        
        .desktop-icons {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 30px;
            position: relative;
            z-index: 3; /* Ensure icons are above wallpaper */
        }
        
        .icon {
            width: 64px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .icon:hover {
            transform: translateY(-3px);
        }
        
        .icon-image {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #ff9900, #ff6600);
            border: 1px solid #ffcc00;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 24px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .icon-label {
            margin-top: 5px;
            font-size: 14px;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 4px;
        }
        
        .window {
            position: absolute;
            background: linear-gradient(to bottom, #a0a0a0, #808080);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);
            min-width: 300px;
            min-height: 200px;
            z-index: 5;
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            transform-style: preserve-3d;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .window.zoom-init,
        .window.zoom-out {
            transform: perspective(800px) translateZ(-400px) scale(0.8);
            opacity: 0;
        }
        
        .window-header {
            height: 24px;
            background: linear-gradient(to right, #0000aa, #000088);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 5px;
            cursor: move;
            font-size: 18px;
        }
        
        .window-title {
            flex: 1;
            text-shadow: 1px 1px 1px #000;
        }
        
        .window-controls {
            display: flex;
            gap: 5px;
        }
        
        .window-btn {
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(to bottom, #c0c0c0, #a0a0a0);
            border: 1px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        .window-btn:active {
            border-top-color: #555;
            border-left-color: #555;
            border-right-color: #fff;
            border-bottom-color: #fff;
        }
        
        .window-content {
            padding: 10px;
            flex: 1;
            overflow: auto;
            color: #000;
            font-size: 18px;
            line-height: 1.4;
            background: #c0c0c0;
            position: relative;
        }

        .window-content--framed {
            padding: 0;
            overflow: hidden;
            display: flex;
        }

        .window-content--framed > iframe {
            flex: 1;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            color: #fff;
            z-index: 5;
            font-family: 'IBM Plex Mono', 'Courier New', monospace;
            letter-spacing: 0.08em;
        }

        .boot-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, rgba(0, 30, 120, 0.92), rgba(0, 0, 0, 0.95));
            z-index: 2000;
            transition: opacity 0.35s ease;
            --boot-progress: 0;
        }

        .boot-loader.boot-loader--hidden {
            opacity: 0;
            pointer-events: none;
        }

        .boot-loader.boot-loader--hidden .zx-loader {
            opacity: 0;
            transform: translateY(-12px);
        }

        .boot-loader .zx-loader {
            transition: opacity 0.35s ease, transform 0.35s ease;
        }

        .loading-overlay .zx-loader,
        .boot-loader .zx-loader {
            width: min(360px, 80%);
            border: 4px solid #fff;
            box-shadow:
                0 0 0 4px #00a8f0 inset,
                0 0 0 8px #000,
                0 0 32px rgba(0, 168, 240, 0.55);
            padding: 18px 16px 22px;
            background: #000;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .zx-loader-title {
            text-align: center;
            font-size: 0.95rem;
            color: #ffe600;
        }

        .zx-loader-bar {
            position: relative;
            height: 26px;
            border: 3px solid #fff;
            padding: 2px;
            overflow: hidden;
            background: #000;
        }

        .zx-loader-fill {
            position: absolute;
            inset: 2px;
            background: repeating-linear-gradient(90deg,
                    #ff004d 0 18px,
                    #ffe600 18px 36px,
                    #00b543 36px 54px,
                    #0099ff 54px 72px,
                    #7d00ff 72px 90px,
                    #ff7800 90px 108px);
            transform-origin: left center;
            animation: zx-progress 2.8s steps(28) infinite;
        }

        .boot-loader .zx-loader-fill {
            animation: none;
            transform: scaleX(var(--boot-progress, 0));
            transform-origin: left center;
            transition: transform 0.4s cubic-bezier(0.22, 0.61, 0.36, 1);
        }

        .zx-loader-glow {
            position: absolute;
            inset: 0;
            mix-blend-mode: screen;
            background: repeating-linear-gradient(0deg,
                    rgba(255, 255, 255, 0.12) 0 2px,
                    transparent 2px 4px);
            opacity: 0.35;
            animation: zx-scan 0.45s steps(3) infinite;
        }

        .zx-loader-status {
            text-align: center;
            font-size: 0.8rem;
            color: #00f0ff;
            animation: zx-blink 1.2s steps(2) infinite;
        }

        .boot-loader .zx-loader-status {
            animation: none;
        }

        @keyframes zx-progress {
            0% { transform: scaleX(0); }
            100% { transform: scaleX(1); }
        }

        @keyframes zx-scan {
            0% { opacity: 0.25; }
            50% { opacity: 0.55; }
            100% { opacity: 0.25; }
        }

        @keyframes zx-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .terminal {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: radial-gradient(circle at top, #0a0a0a, #020202 70%);
            border: 2px solid #0f0;
            border-radius: 6px;
            box-shadow: inset 0 0 12px rgba(0, 255, 170, 0.25);
            font-family: 'VT323', monospace;
            color: #0f0;
        }

        .terminal-screen {
            flex: 1;
            overflow: auto;
            padding: 10px;
            outline: none;
        }

        .terminal-screen:focus {
            box-shadow: inset 0 0 0 2px rgba(0, 255, 170, 0.4);
        }

        .terminal-output {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .terminal-row {
            white-space: pre-wrap;
            letter-spacing: 1px;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 6px;
        }

        .terminal-prompt {
            color: #5dff89;
        }

        .terminal-input {
            min-width: 2px;
        }

        .terminal-cursor {
            animation: terminal-blink 1s step-end infinite;
        }

        @keyframes terminal-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .terminal-hints {
            padding: 6px 12px;
            font-size: 14px;
            background: linear-gradient(90deg, rgba(0, 255, 170, 0.15), transparent);
            border-top: 1px solid rgba(0, 255, 170, 0.3);
        }

        .terminal-hints strong {
            color: #9bffba;
        }
        
        .disk-drive {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 120px;
            height: 80px;
            background: linear-gradient(to bottom, #d0d0d0, #a0a0a0);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 4;
        }

        .text-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fdfdfd;
            border: 1px solid #bbb;
            border-radius: 4px;
            overflow: hidden;
            font-family: var(--text-editor-body-font, 'Atkinson Hyperlegible', sans-serif);
        }

        .text-editor--mono,
        .text-editor--mono .text-editor-area {
            font-family: 'VT323', monospace;
        }

        .text-editor-menu {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .text-editor-options {
            display: none;
            background: #f7f7f7;
            border-bottom: 1px solid #c9c9c9;
            padding: 10px;
            gap: 8px;
            grid-template-columns: 1fr;
        }

        .text-editor-options[aria-hidden="false"] {
            display: grid;
        }

        .text-editor-option {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #333;
            flex-wrap: wrap;
        }

        .text-editor-option span {
            flex: 1;
            color: #2a2a2a;
        }

        .text-editor-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #1c6ad6;
        }

        .text-editor-option--filename input {
            flex: 1 0 190px;
            padding: 4px 6px;
            border: 1px solid #aaa;
            border-radius: 3px;
            font-size: 14px;
            font-family: inherit;
            background: #fff;
        }

        .text-editor-option--actions {
            justify-content: space-between;
        }

        .text-editor-option--actions span {
            color: #555;
        }

        .text-editor-option--actions .text-editor-btn {
            margin-left: auto;
        }

        .text-editor-btn.subtle {
            border-color: #999;
            background: linear-gradient(to bottom, #f0f0f0, #dcdcdc);
            color: #333;
        }

        .text-editor-btn.subtle:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .text-editor-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: linear-gradient(to bottom, #ececec, #d8d8d8);
            border-bottom: 1px solid #b3b3b3;
        }

        .text-editor-btn {
            border: 1px solid #888;
            background: linear-gradient(to bottom, #ffffff, #d9d9d9);
            padding: 4px 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .text-editor-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .text-editor-btn.primary {
            border-color: #0056b3;
            background: linear-gradient(to bottom, #4aa3ff, #1c6ad6);
            color: #fff;
        }

        .text-editor-spacer {
            flex: 1;
        }

        .text-editor-status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f0f0f0;
            font-size: 14px;
            border-bottom: 1px solid #c9c9c9;
        }

        #text-editor-status[data-state="warning"] {
            color: #c67d00;
        }

        #text-editor-status[data-state="success"] {
            color: #0a8a37;
        }

        .text-editor-area {
            flex: 1;
            border: none;
            padding: 12px;
            font-size: 18px;
            font-family: inherit;
            outline: none;
            resize: none;
            background: #ffffff;
            line-height: 1.6;
        }

        .text-editor--wrap .text-editor-area {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: hidden;
        }

        .text-editor:not(.text-editor--wrap) .text-editor-area {
            white-space: pre;
            overflow-x: auto;
        }

        .text-editor-area:focus {
            box-shadow: inset 0 0 0 2px rgba(0, 123, 255, 0.2);
        }
        
        .drive-slot {
            width: 80px;
            height: 20px;
            background: #222;
            margin-top: 10px;
            position: relative;
        }
        
        .drive-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f00;
            position: absolute;
            right: 5px;
            top: 5px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        .gshock-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding: 12px;
            background: radial-gradient(circle at 20% 20%, #30343b, #0c0e12 70%);
            border: 4px solid #050607;
            border-radius: 16px;
            color: #d8f9ff;
            font-family: 'VT323', monospace;
        }

        .gshock-bezel {
            text-align: center;
            font-size: 18px;
            letter-spacing: 2px;
            color: #ffdf3f;
        }

        .gshock-bezel span {
            display: block;
            font-size: 12px;
            color: #f33535;
            letter-spacing: 4px;
        }

        .gshock-inner {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #101820;
            border: 2px solid #2f3b44;
            border-radius: 10px;
            padding: 12px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.6);
        }

        .gshock-header,
        .gshock-footer {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #8cd9ff;
        }

        .gshock-time {
            font-size: 36px;
            text-align: center;
            color: #9bf7ff;
            text-shadow: 0 0 10px rgba(155, 247, 255, 0.6);
        }

        .gshock-signal {
            color: #ffdf3f;
        }

        .gshock-buttons {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .gshock-btn {
            background: linear-gradient(to bottom, #20242b, #13161c);
            border: 1px solid #515862;
            color: #d8f9ff;
            padding: 4px 12px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            letter-spacing: 2px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .gshock-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        }

        .gshock-btn.active {
            background: linear-gradient(to bottom, #ffdf3f, #f2b705);
            color: #101820;
        }
        
        .task-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: linear-gradient(to bottom, #0066cc, #004499);
            border-top: 1px solid #00aaff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 18px;
            color: #fff;
            z-index: 10;
        }
        
        .task-btn {
            padding: 0 10px;
            height: 20px;
            background: linear-gradient(to bottom, #a0a0a0, #808080);
            border: 1px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            margin-right: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .task-btn.active {
            background: linear-gradient(to bottom, #0066cc, #004499);
            color: #fff;
        }

        .taskbar-menu {
            position: absolute;
            background: #ccc;
            border: 1px solid #555;
            color: #000;
            bottom: 26px;
            z-index: 200;
            display: none;
        }

        .taskbar-menu div {
            padding: 5px 15px;
            white-space: nowrap;
            cursor: pointer;
        }

        .taskbar-menu div:hover {
            background: #0066cc;
            color: #fff;
        }

        .dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(to bottom, #a0a0a0, #808080);
            border: 2px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            min-width: 300px;
            z-index: 20;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.7);
        }
        
        .dialog-content {
            padding: 20px;
            text-align: center;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .dialog-btn {
            padding: 5px 15px;
            background: linear-gradient(to bottom, #c0c0c0, #a0a0a0);
            border: 1px solid;
            border-top-color: #fff;
            border-left-color: #fff;
            border-right-color: #555;
            border-bottom-color: #555;
            cursor: pointer;
            min-width: 80px;
            font-size: 18px;
        }
        
        .dialog-btn:active {
            border-top-color: #555;
            border-left-color: #555;
            border-right-color: #fff;
            border-bottom-color: #fff;
        }
        
        /* Calculator styles */
        .calculator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            width: 200px;
            margin: 0 auto;
        }
        
        .calc-display {
            grid-column: span 4;
            height: 40px;
            background: #000;
            color: #0f0;
            text-align: right;
            padding: 5px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            border: 1px solid #555;
            margin-bottom: 5px;
        }
        
        .calc-btn {
            height: 30px;
            background: linear-gradient(to bottom, #c0c0c0, #a0a0a0);
            border: 1px solid #555;
            cursor: pointer;
            font-size: 18px;
        }
        
        .calc-btn:active {
            background: linear-gradient(to bottom, #a0a0a0, #808080);
        }
        
        .calc-btn.operator {
            background: linear-gradient(to bottom, #ff9900, #ff6600);
            color: #fff;
        }
        
        /* Calendar styles */
        .calendar {
            width: 100%;
            text-align: center;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            background: #ddd;
            padding: 5px;
            border: 1px solid #aaa;
            font-size: 16px;
        }
        
        .calendar-day.header {
            background: #aaa;
            font-weight: bold;
        }
        
        .calendar-day.today {
            background: #ffcc00;
            font-weight: bold;
        }
        
        /* Game styles */
        .game-container {
            text-align: center;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 10px auto;
            width: 240px;
        }
        
        .game-tile {
            width: 50px;
            height: 50px;
            background: #ff9900;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border: 1px solid #ff6600;
            user-select: none;
        }
        
        .game-tile.empty {
            background: #c0c0c0;
            border: 1px solid #aaa;
        }
        
        /* Retro wallpaper */
        .wallpaper {
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            bottom: 24px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230055aa"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%230077cc" stroke-width="0.5"/></svg>');
            opacity: 0.2;
            z-index: 1;
            pointer-events: none; /* Fix for click-through issue */
        }
        
        /* Status bar */
        .status-bar {
            position: absolute;
            bottom: 24px;
            left: 0;
            right: 0;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            z-index: 2;
        }
        
        /* Icons are now clickable! */
    </style>
    <link id="theme-link" rel="stylesheet">
</head>
<body>
    <div class="boot-loader" id="boot-loader" role="alert" aria-live="assertive">
        <div class="zx-loader">
            <div class="zx-loader-title" id="boot-title">Orbit OS is booting‚Ä¶</div>
            <div class="zx-loader-bar">
                <div class="zx-loader-fill"></div>
                <div class="zx-loader-glow"></div>
            </div>
            <div class="zx-loader-status" id="boot-status">Initializing subsystems‚Ä¶</div>
        </div>
    </div>
    <div class="desktop" id="desktop">
        <!-- Retro wallpaper -->
        <div class="wallpaper"></div>
        
        <!-- Menu bar -->
        <div class="menu-bar" id="menu-bar">
            <div class="clock" id="clock">12:00:00 PM</div>
        </div>
        
        <!-- Desktop icons -->
        <div class="desktop-icons" id="desktop-icons"></div>
        
        <!-- Storage indicator -->
        <div class="disk-drive">
            <div>Storage:</div>
            <div class="drive-slot">
                <div class="drive-light"></div>
            </div>
        </div>
        
        <!-- Status bar -->
        <div class="status-bar" id="status-bar"></div>

        <!-- Task bar -->
        <div class="task-bar" id="task-bar"></div>
        <div class="taskbar-menu" id="taskbar-menu" style="display:none;"></div>
        
        <!-- Welcome dialog -->
        <div class="dialog" id="welcome-dialog" style="display:none;">
            <div class="window-header">
                <div class="window-title"></div>
            </div>
            <div class="dialog-content"></div>
        </div>
    </div>

    <script>
// Simple in-browser console log monitor
let installed = false;
let containers = [];
let history = [];
let logFilter = null; // Set of log levels to display
const methods = ['log', 'info', 'warn', 'error'];
const original = {};

function appendLine(type, msg, el) {
  const line = document.createElement('div');
  line.className = `console-line ${type}`;
  line.textContent = `[${type}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
  return line;
}

function initConsoleLogs({ container, removeAfter = 3000, filter } = {}) {
  if (!container) {
    container = document.createElement('div');
    container.id = 'console-log';
    Object.assign(container.style, {
      position: 'absolute', bottom: '0', left: '0', width: '100%',
      maxHeight: '100px', overflowY: 'auto', color: '#0f0',
      background: 'none', fontFamily: 'monospace', fontSize: '0.65rem',
      padding: '2px 4px', pointerEvents: 'none', zIndex: 30
    });
    document.body.appendChild(container);
  }

  if (filter && Array.isArray(filter) && filter.length) {
    logFilter = new Set(filter);
  }

  containers.push({ el: container, removeAfter });
  history.forEach(({ type, msg }) => {
    if (logFilter && !logFilter.has(type)) return;
    appendLine(type, msg, container);
  });

  if (!installed) {
    installed = true;
    methods.forEach(m => {
      original[m] = console[m].bind(console);
      console[m] = (...args) => {
        original[m](...args);
        const msg = args
          .map(a => {
            try {
              return typeof a === 'object' ? JSON.stringify(a) : String(a);
            } catch {
              return String(a);
            }
          })
          .join(' ');
        history.push({ type: m, msg });
        if (logFilter && !logFilter.has(m)) return;
        containers.forEach(({ el, removeAfter: rm }) => {
          const line = appendLine(m, msg, el);
          if (rm) setTimeout(() => line.remove(), rm);
        });
      };
    });
  }

  function setFilter(types) {
    logFilter = types && types.length ? new Set(types) : null;
    containers.forEach(({ el }) => {
      el.innerHTML = '';
      history.forEach(({ type, msg }) => {
        if (logFilter && !logFilter.has(type)) return;
        appendLine(type, msg, el);
      });
    });
  }

  function clear() {
    history = [];
    containers.forEach(({ el }) => (el.innerHTML = ''));
  }

  function restore() {
    // revert console methods and clear state
    methods.forEach(m => (console[m] = original[m]));
    installed = false;
    containers = [];
    history = [];
    logFilter = null;
  }

  return { container, restore, setFilter, clear };
}

    </script>

    <script id="orbit-app-data" type="application/json">
{
  "menus": [
    {
      "label": "Project",
      "items": [
        {
          "label": "System Info",
          "type": "system-info"
        },
        {
          "label": "CLI Terminal",
          "type": "terminal"
        },
        {
          "label": "File Manager",
          "type": "file-manager"
        },
        {
          "label": "Exit Orbit OS v 0.2.0"
        }
      ]
    },
    {
      "label": "Edit",
      "items": [
        {
          "label": "Undo"
        },
        {
          "label": "Redo"
        },
        {
          "label": "Cut"
        },
        {
          "label": "Copy"
        },
        {
          "label": "Paste"
        }
      ]
    },
    {
      "label": "Tools",
      "items": [
        {
          "label": "Calculator",
          "type": "calculator"
        },
        {
          "label": "Calendar",
          "type": "calendar"
        },
        {
          "label": "Console Log",
          "type": "console-log"
        },
        {
          "label": "Show Loading Demo",
          "action": "show-boot-loader"
        },
        {
          "label": "Docu Monster Studio Pro",
          "type": "document-editor"
        },
        {
          "label": "Orbit Comics Editor",
          "type": "comic-forge"
        },
        {
          "label": "ScanX Analyzer",
          "type": "scanx"
        }
      ]
    },
    {
      "label": "Windows",
      "items": [
        {
          "label": "Tile Windows"
        },
        {
          "label": "Cascade Windows"
        },
        {
          "label": "Arrange Icons"
        },
        {
          "label": "Close All"
        }
      ]
    },
    {
      "label": "Theme",
      "items": [
        { "label": "Retro", "action": "set-theme", "theme": "retro" },
        { "label": "Futuristic", "action": "set-theme", "theme": "futuristic" }
      ]
    }
  ],
  "status": "Orbit OS v 0.2.0 optimized and ready.",
  "terminal": {
    "banner": [
      "Orbit OS v{version} CLI",
      "(c) 2025 CyborgsDream",
      "System date: {date}",
      "System time: {time}",
      ""
    ],
    "hint": "Type <strong>help</strong> or try <code>status</code>.",
    "responses": {
      "status": [
        "Core services: ONLINE",
        "Creative drives mounted successfully.",
        "Build version: v{version}"
      ],
      "whoami": "orbit-user",
      "ls apps": [
        "cloud-storage.html",
        "documonster.html",
        "comic-issue-forge.html",
        "scanx.html"
      ]
    },
    "fallback": {
      "type": "info",
      "message": "Command \"{command}\" executed."
    }
  },
  "welcome": {
    "title": "Orbit OS v 0.2.0",
    "lines": [
      "Welcome to Orbit OS v 0.2.0.",
      "Streamlined for faster window recovery and smoother boot.",
      "(c) 2025 CyborgsDream"
    ],
    "button": "OK"
  },
  "icons": [
    {
      "type": "terminal",
      "emoji": "‚å®Ô∏è",
      "label": "Terminal"
    },
    {
      "type": "text-editor",
      "emoji": "üìù",
      "label": "TextEdit"
    },
    {
      "type": "document-editor",
      "emoji": "üìÑ",
      "label": "Docu Monster Studio Pro"
    },
    {
      "type": "comic-forge",
      "emoji": "ü¶∏",
      "label": "Orbit Comics Editor"
    },
    {
      "type": "scanx",
      "emoji": "üñ®Ô∏è",
      "label": "ScanX"
    },
    {
      "type": "calculator",
      "emoji": "üßÆ",
      "label": "Calculator"
    },
    {
      "type": "calendar",
      "emoji": "üìÖ",
      "label": "Calendar"
    },
    {
      "type": "clock",
      "emoji": "‚è∞",
      "label": "Clock"
    },
    {
      "type": "console-log",
      "emoji": "üìú",
      "label": "Console"
    },
    {
      "type": "html-studio",
      "emoji": "üåê",
      "label": "HTML Studio"
    }
  ],
  "windows": {
    "system-info": {
      "title": "System Information",
      "content": "<h2>Orbit OS v 0.2.0 Demo Machine</h2><p>Motorola 68030 @ 25MHz</p><p>2MB Chip RAM + 8MB Fast RAM</p><p>Kickstart 2.04</p><p>Orbit OS v 0.2.0</p><p>Display: 640x512 (ECS)</p><p>Floppy: 880KB 3.5\"</p><p>HD: 120MB SCSI</p><div style=\"margin-top: 20px; text-align: center;\"><div style=\"display: inline-block; padding: 10px; background: #0000aa; color: white;\">Creative Control</div></div>",
      "width": 320,
      "height": 300
    },
    "terminal": {
      "title": "CLI",
      "content": "<div class=\"terminal\" role=\"application\"><div class=\"terminal-screen\" tabindex=\"0\" aria-label=\"Orbit OS command line\"><div class=\"terminal-output\"></div><div class=\"terminal-input-line\"><span class=\"terminal-prompt\">orbit&gt;</span><span class=\"terminal-input\" aria-live=\"polite\"></span><span class=\"terminal-cursor\">‚ñà</span></div></div><div class=\"terminal-hints\">Type <strong>help</strong> or try <code>status</code>.</div></div>",
      "width": 520,
      "height": 320
    },
    "text-editor": {
      "title": "Text Editor",
      "content": "<div class=\"text-editor text-editor--wrap text-editor--mono\"><div class=\"text-editor-toolbar\"><div class=\"text-editor-menu\"><button type=\"button\" data-action=\"options\" class=\"text-editor-btn\" aria-expanded=\"false\">Options</button><button type=\"button\" data-action=\"new\" class=\"text-editor-btn\">New</button><button type=\"button\" data-action=\"save\" class=\"text-editor-btn\">Save</button><button type=\"button\" data-action=\"load\" class=\"text-editor-btn\">Load</button><button type=\"button\" data-action=\"word-count\" class=\"text-editor-btn\">Word Count</button><input type=\"file\" id=\"text-editor-file\" accept=\".txt,.md,.json,text/plain\" hidden></div><div class=\"text-editor-spacer\"></div><button type=\"button\" id=\"text-editor-export\" class=\"text-editor-btn primary\">Export PDF</button></div><div class=\"text-editor-options\" id=\"text-editor-options\" aria-hidden=\"true\"><label class=\"text-editor-option\"><span>Soft wrap text</span><input type=\"checkbox\" id=\"text-editor-option-wrap\" checked></label><label class=\"text-editor-option\"><span>Monospace mode</span><input type=\"checkbox\" id=\"text-editor-option-mono\" checked></label><label class=\"text-editor-option\"><span>Auto-save drafts</span><input type=\"checkbox\" id=\"text-editor-option-autosave\" checked></label><label class=\"text-editor-option text-editor-option--filename\"><span>Default filename</span><input type=\"text\" id=\"text-editor-option-filename\" value=\"orbit-notes.txt\" spellcheck=\"false\"></label><div class=\"text-editor-option text-editor-option--actions\"><span>Need your last copy?</span><button type=\"button\" id=\"text-editor-restore\" class=\"text-editor-btn subtle\">Restore Last Draft</button></div></div><div class=\"text-editor-status-row\"><div id=\"text-editor-status\">Ready.</div><div id=\"text-editor-stats\"></div></div><textarea id=\"text-editor-area\" class=\"text-editor-area\" autocomplete=\"off\">Welcome to Orbit OS v 0.2.0!\n\n‚Ä¢ Crafted for focused creative work.\n‚Ä¢ Windows snap, remember their state, and respect your layout.\n‚Ä¢ Use the menu above to manage drafts.\n\nStay tuned for additional native tools in upcoming builds.</textarea></div>",
      "width": 560,
      "height": 420
    },
    "calculator": {
        "title": "Calculator",
        "content": "<div class=\"calculator\"><div class=\"calc-display\" id=\"calc-display\">0</div><button class=\"calc-btn\" onclick=\"clearCalc()\">C</button><button class=\"calc-btn\" onclick=\"appendCalc('%')\">%</button><button class=\"calc-btn\" onclick=\"appendCalc('‚Üê')\">‚Üê</button><button class=\"calc-btn operator\" onclick=\"appendCalc('/')\">√ó</button><button class=\"calc-btn\" onclick=\"appendCalc('7')\">7</button><button class=\"calc-btn\" onclick=\"appendCalc('8')\">8</button><button class=\"calc-btn\" onclick=\"appendCalc('9')\">9</button><button class=\"calc-btn operator\" onclick=\"appendCalc('*')\">√ó</button><button class=\"calc-btn\" onclick=\"appendCalc('4')\">4</button><button class=\"calc-btn\" onclick=\"appendCalc('5')\">5</button><button class=\"calc-btn\" onclick=\"appendCalc('6')\">6</button><button class=\"calc-btn operator\" onclick=\"appendCalc('-')\">-</button><button class=\"calc-btn\" onclick=\"appendCalc('1')\">1</button><button class=\"calc-btn\" onclick=\"appendCalc('2')\">2</button><button class=\"calc-btn\" onclick=\"appendCalc('3')\">3</button><button class=\"calc-btn operator\" onclick=\"appendCalc('+')\">+</button><button class=\"calc-btn\" onclick=\"appendCalc('0')\">0</button><button class=\"calc-btn\" onclick=\"appendCalc('.')\">.</button><button class=\"calc-btn operator\" onclick=\"calculate()\">=</button></div>",
        "width": 250,
        "height": 300
      },
    "calendar": {
      "title": "Calendar",
      "content": "<div class=\"calendar\"><div class=\"calendar-header\"><button onclick=\"changeMonth(-1)\" style=\"font-size: 18px;\">‚Üê</button><h3 id=\"calendar-month-year\">{MONTH_YEAR}</h3><button onclick=\"changeMonth(1)\" style=\"font-size: 18px;\">‚Üí</button></div><div class=\"calendar-grid\"><div class=\"calendar-day header\">Sun</div><div class=\"calendar-day header\">Mon</div><div class=\"calendar-day header\">Tue</div><div class=\"calendar-day header\">Wed</div><div class=\"calendar-day header\">Thu</div><div class=\"calendar-day header\">Fri</div><div class=\"calendar-day header\">Sat</div>{CALENDAR_DAYS}</div></div>",
      "width": 350,
      "height": 300
    },
    "clock": {
      "title": "Clock",
      "content": "<div class=\"gshock-clock\" role=\"img\" aria-label=\"CASHIO G-Shock inspired digital clock\"><div class=\"gshock-bezel\">CASHIO<br><span>G-SHOCK</span></div><div class=\"gshock-inner\"><div class=\"gshock-header\"><span id=\"gshock-day\">SUN</span><span class=\"gshock-signal\">SIG</span><span id=\"gshock-mode\">24H</span></div><div class=\"gshock-time\" id=\"gshock-time\">{TIME}</div><div class=\"gshock-footer\"><span id=\"gshock-date\">JAN 01</span><span id=\"gshock-ampm\">AM</span></div></div><div class=\"gshock-buttons\"><button id=\"gshock-toggle\" class=\"gshock-btn\" aria-label=\"Toggle 12 and 24 hour time\">MODE</button></div></div>",
      "width": 260,
      "height": 260
    },
    "console-log": {
      "title": "Console Logs",
      "content": "<div class=\"console-log-window\" style=\"width:100%;height:100%;background:#000;color:#fff;font-family:monospace;overflow:auto;font-size:16px;padding:4px;\"></div>",
      "width": 400,
      "height": 250
    },
    "html-studio": {
      "title": "HTML Studio",
      "content": "<iframe src=\"html-studio.html\" style=\"width:100%;height:100%;border:none;\"></iframe>",
      "width": 600,
      "height": 450
    },
    "document-editor": {
      "title": "Docu Monster Studio Pro A4",
      "content": "<iframe src=\"documonster.html\" style=\"width:100%;height:100%;border:none;background:#c0c0c0;\"></iframe>",
      "width": 1280,
      "height": 900
    },
    "comic-forge": {
      "title": "Orbit Comics Editor v0.0.2",
      "content": "<iframe src=\"comic-issue-forge.html\" style=\"width:100%;height:100%;border:none;background:#eef1ff;\"></iframe>",
      "width": 1280,
      "height": 860
    },
    "scanx": {
      "title": "ScanX Publishing Studio",
      "content": "<iframe src=\"scanx.html\" style=\"width:100%;height:100%;border:none;background:#f4f6ff;\"></iframe>",
      "width": 900,
      "height": 640
    },
    "mini-app": {
      "title": "Mini App",
      "content": "<p>Mini app pinned!</p>",
      "width": 160,
      "height": 120
    }
  },
  "settings": {
    "clockFormat": "en-US",
    "persistWindows": true
  }
}
    </script>
    <script id="orbit-iframe-data" type="application/json">
{
  "html-studio.html": "<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<title>HTML Studio</title>\n<script src=\"https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js\"><\/script>\n<style>\n:root{--desktop:#1e1e1e;--header:#007acc;--hover:#0091ff;--accent:#0091ff;--win-bg:#202020;--win-border:#555}\n*{box-sizing:border-box;margin:0}\nhtml,body{height:100%;background:var(--desktop);font-family:Segoe UI,Tahoma,sans-serif;color:#ddd;overflow:hidden}\nbody{display:flex;flex-direction:column;background:var(--win-bg)}\n.toolbar{display:flex;align-items:center;gap:.5rem;padding:.25rem .7rem;background:#222;font-size:.8rem}\n.btn,select{border:none;border-radius:3px;padding:.34rem .75rem;font-size:.78rem;background:#045a9e;color:#fff}\n.btn:hover,select:hover{background:var(--hover)}\n.viewBtn{font-size:1rem;padding:.2rem .6rem;background:#0a5d9f}.viewBtn.active{background:var(--header)}\n#wys{display:none;gap:.3rem;padding:.25rem .6rem;background:#e7e7e7;border-bottom:1px solid #ccc}\n#wys button{border:none;background:none;cursor:pointer;padding:.2rem .55rem;font-size:.85rem}\n#wys button:hover{background:#d0d0d0}\n#workspace{flex:1;display:grid;grid-template-columns:1.2fr 1fr}\n#editor,#ta{width:100%;height:100%}\n#preview{width:100%;height:100%;border:none;background:#fff}\n#console{background:#000;font-family:monospace;font-size:.72rem;max-height:70px;overflow-y:auto;white-space:pre-wrap;padding:.25rem .5rem}\n.log-line{padding:1px 0}.err{color:#f66}.warn{color:#f2b648}.info{color:#8ad}\n.status{height:24px;background:#111;font-size:.73rem;color:#888;display:flex;justify-content:space-between;align-items:center;padding:0 .6rem;font-family:monospace}\n</style>\n</head>\n<body>\n<div class=\"toolbar\">\n    <button id=\"codeBtn\"  class=\"viewBtn\">üñâ</button>\n    <button id=\"splitBtn\" class=\"viewBtn active\">‚áÜ</button>\n    <button id=\"wysBtn\"   class=\"viewBtn\">üëÅ</button>\n    <button class=\"btn\" id=\"saveBtn\">Save</button>\n    <select id=\"loadSel\"><option disabled selected>Load‚Ä¶</option></select>\n    <button class=\"btn\" id=\"dlBtn\">Download</button>\n  </div>\n  <div id=\"wys\">\n    <button data-cmd=\"bold\"><b>B</b></button>\n    <button data-cmd=\"italic\"><i>I</i></button>\n    <button data-cmd=\"formatBlock\" data-arg=\"h1\">H1</button>\n    <button data-cmd=\"createLink\">Link</button>\n  </div>\n  <div id=\"workspace\"><div id=\"editor\"></div><iframe id=\"preview\"></iframe></div>\n  <pre id=\"console\"></pre><div class=\"status\"><span id=\"verInfo\">ver:0</span><span id=\"sizeInfo\">size:0</span></div>\n<script>\nconst $=id=>document.getElementById(id);\nconst log=(m,t='info')=>{$('console').appendChild(Object.assign(document.createElement('div'),{className:'log-line '+t,textContent:m}));$('console').scrollTop=$('console').scrollHeight;};\nwindow.onerror=m=>log('Error: '+m,'err');\nconst pretty=html=>html.replace(/></g,\">\\n<\");\nlet editor;\nconst template=pretty(`<!doctype html><html><head><meta charset=\"utf-8\"><title>Demo</title><style>body{font-family:sans-serif;padding:2rem}</style></head><body><h1>Hello!</h1><p>Edit code or <em>WYSIWYG</em>.</p></body></html>`);\nconst LS='studio-snaps',load=()=>JSON.parse(localStorage.getItem(LS)||'[]'),save=a=>localStorage.setItem(LS,JSON.stringify(a));\nfunction setupPreview(){\n  const doc=$('preview').contentDocument;\n  if(!doc||doc.__init)return;\n  doc.designMode='on';\n  $('wys').onclick=e=>{const cmd=e.target.dataset.cmd;if(!cmd)return;const arg=cmd==='createLink'?prompt('URL','https://'):e.target.dataset.arg||null;doc.execCommand(cmd,false,arg);};\n  doc.addEventListener('input',()=>{editor.setValue(pretty(doc.documentElement.outerHTML));sync(false);});\n  doc.__init=true;\n}\nfunction sync(update=true){const c=editor.getValue();if(update){$('preview').srcdoc=c;setTimeout(setupPreview);}$('sizeInfo').textContent='size:'+c.length+'c';}\nrequire.config({paths:{vs:'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs'}});\nlet fallbackTO=setTimeout(useTA,5000);\nrequire(['vs/editor/editor.main'],()=>{clearTimeout(fallbackTO);editor=monaco.editor.create($('editor'),{value:template,language:'html',theme:'vs-dark',automaticLayout:true,minimap:{enabled:false}});editor.onDidChangeModelContent(sync);sync();ui();log('Monaco ready');});\nfunction useTA(){const ta=document.createElement('textarea');ta.id='ta';ta.value=template;ta.style.cssText='width:100%;height:100%;resize:none;background:#111;color:#eee;border:none;padding:8px;font-family:monospace';$('editor').replaceWith(ta);editor={getValue:()=>ta.value,setValue:v=>ta.value=v};ta.addEventListener('input',sync);sync();ui();log('Textarea','warn');}\nfunction ui(){\n  const setView=id=>{['codeBtn','splitBtn','wysBtn'].forEach(b=>$(b).classList.remove('active'));$(id).classList.add('active');\n    $('editor').parentElement.style.display=id==='wysBtn'?'none':'block';\n    $('preview').parentElement.style.display=id==='codeBtn'?'none':'block';\n    $('wys').style.display=id==='wysBtn'||id==='splitBtn'?'flex':'none';\n    if(id!=='codeBtn')$('preview').contentDocument?.body.focus();\n    if(id==='codeBtn')editor.setValue(pretty(editor.getValue()));};\n  $('codeBtn').onclick =()=>setView('codeBtn');\n  $('splitBtn').onclick=()=>setView('splitBtn');\n  $('wysBtn').onclick  =()=>setView('wysBtn');\n  setupPreview();\n  const refill=()=>{$('verInfo').textContent='ver:'+load().length;$('loadSel').innerHTML='<option disabled selected>Load‚Ä¶</option>';load().slice().reverse().forEach(v=>{const o=document.createElement('option');o.value=v.id;o.textContent=new Date(v.id).toLocaleString();$('loadSel').appendChild(o);});};\n  $('saveBtn').onclick=()=>{const a=load();a.push({id:Date.now(),code:editor.getValue()});save(a);refill();log('saved');};\n  $('loadSel').onchange=e=>{const s=load().find(v=>v.id==e.target.value);if(s){editor.setValue(pretty(s.code));sync();}e.target.value='';};\n  refill();\n  $('dlBtn').onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([editor.getValue()],{type:'text/html'}));a.download='index.html';a.click();URL.revokeObjectURL(a.href);};\n  document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='s'){e.preventDefault();$('saveBtn').click();}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='p'){editor.setValue(pretty(editor.getValue()));sync();log('pretty-printed');}});\n}\n<\/script>\n</body>\n</html>\n",
  "documonster.html": "<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\" />\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n<meta http-equiv=\"Content-Language\" content=\"en\" />\n<title>Docu Monster Studio Pro ‚Äî Orbit OS v 0.2.0</title>\n<style>\n  /* ===== Base ===== */\n  *,*::before,*::after{ box-sizing:border-box; }\n  html,body{ margin:0; padding:0; }\n  :root{\n    --bleed:3mm;\n    --page-w:210mm; --page-h:297mm;\n    --sheet-w:calc(var(--page-w) + 2*var(--bleed));\n    --sheet-h:calc(var(--page-h) + 2*var(--bleed));\n    --m-top:15mm; --m-out:17mm; --m-bot:20mm; --m-in:17mm;\n    --col-gap:6mm;\n    --accent:#0b84ff;\n    --ink:#101217; --ink-soft:#454853; --rule:#d7d9df; --paper:#fff; --thumb-bg:#eef0f6;\n    --chrome-bg:#f4f5f9; --chrome-border:#d3d6de; --chrome-border-strong:#b7bbc7;\n    --font-ui:\"Tahoma\",\"Segoe UI\",\"MS Sans Serif\",ui-sans-serif,system-ui,sans-serif;\n    --font-body:\"Times New Roman\",\"Noto Serif\",ui-serif,serif;\n    --menu-h:26px; --sidebar-w:216px; --measure-w:232px; --workspace-pad:72px;\n    --crop-l:7mm; --crop-w:0.25mm;\n  }\n\n  body{ background:linear-gradient(135deg, #ede8dc 0%, #f6f3eb 55%, #e9e4d8 100%); font:12px var(--font-body); color:var(--ink); }\n  body.dirty #status{ background:#dede57; }\n  a{ color:inherit; }\n\n  .mobile-only{ display:none; }\n  body.mobile-layout{ --workspace-pad:36px; }\n  body.mobile-layout #menubar{ flex-wrap:wrap; gap:4px; padding:6px 10px; overflow-x:auto; justify-content:flex-start; box-shadow:none; }\n  body.mobile-layout .menu-root{ flex:0 1 auto; min-width:96px; }\n  body.mobile-layout .mobile-only{ display:inline-flex; }\n  body.mobile-layout #ui{\n    position:static;\n    top:auto;\n    left:auto;\n    bottom:auto;\n    width:100%;\n    max-height:none;\n    border-right:none;\n    border-bottom:1px solid var(--chrome-border);\n    overflow:visible;\n    padding:14px 12px;\n    background:#fdfdff;\n  }\n  body.mobile-layout #ui .win-group{ width:100%; }\n  body.mobile-layout #sidebar{\n    position:static;\n    top:auto;\n    left:auto;\n    bottom:auto;\n    width:100%;\n    max-height:none;\n    border-right:none;\n    border-bottom:1px solid var(--chrome-border);\n    padding:16px 14px;\n    background:#f9f9fb;\n  }\n  body.mobile-layout #pageViewport{\n    margin-left:0;\n    padding:32px 12px 120px;\n    max-width:100%;\n    overflow-x:auto;\n  }\n  body.mobile-layout #viewportZoomControls{\n    right:16px;\n    bottom:16px;\n  }\n  body.mobile-layout #viewportZoomControls button{\n    width:36px;\n    height:36px;\n  }\n  body.mobile-layout #rulerTop,\n  body.mobile-layout #rulerLeft{\n    display:none;\n  }\n  body.mobile-layout #thumbs .thumb{\n    max-width:320px;\n    margin-left:auto;\n    margin-right:auto;\n  }\n  body.mobile-ui-hidden #ui{ display:none !important; }\n  body.mobile-sidebar-hidden #sidebar{ display:none !important; }\n\n  /* ===== Menubar ===== */\n  #menubar{ position:sticky; top:0; z-index:1200; height:var(--menu-h); display:flex; align-items:center; gap:6px; padding:4px 14px; background:#fff; border-bottom:1px solid var(--chrome-border); box-shadow:0 1px 2px rgba(16,18,23,0.04); }\n  .menu-root{ font:11px var(--font-ui); border:1px solid transparent; background:transparent; padding:4px 8px; min-width:56px; text-align:left; color:var(--ink); border-radius:5px; cursor:pointer; transition:background 0.15s ease, color 0.15s ease, border-color 0.15s ease; }\n  .menu-root:focus-visible{ outline:2px solid var(--accent); outline-offset:1px; }\n  .menu-root.open, .menu-root:hover{ background:rgba(11,132,255,0.12); border-color:rgba(11,132,255,0.3); color:#0b3d91; }\n  .menu-dropdown{ position:absolute; background:#fff; border:1px solid var(--chrome-border); border-radius:8px; padding:6px 0; display:none; min-width:190px; box-shadow:0 12px 32px rgba(16,18,23,0.18); z-index:1300; }\n  .menu-dropdown.open{ display:block; }\n  .menu-dropdown button{ width:100%; text-align:left; background:transparent; border:none; font:11px var(--font-ui); padding:6px 16px; color:var(--ink); cursor:pointer; transition:background 0.15s ease, color 0.15s ease; }\n  .menu-dropdown button:hover{ background:rgba(11,132,255,0.1); color:#0b3d91; }\n  .menu-sep{ border-top:1px solid var(--chrome-border); margin:6px 0; }\n\n  /* ===== Toolbar ===== */\n  #ui{ position:fixed; top:var(--menu-h); left:0; bottom:0; width:var(--measure-w); z-index:1100; background:#fdfdff; padding:14px 12px; border-right:1px solid var(--chrome-border); display:flex; flex-direction:column; align-items:stretch; gap:12px; overflow:auto; }\n  .win-group{ padding:10px; background:#fff; border:1px solid var(--chrome-border); border-radius:10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; width:100%; box-shadow:0 1px 2px rgba(16,18,23,0.05); }\n  .win-btn{ padding:5px 10px; min-width:28px; background:linear-gradient(to bottom, #ffffff 0%, #f3f6fc 100%); border:1px solid #c8cfdb; border-radius:6px; cursor:pointer; font:11px var(--font-ui); color:var(--ink); transition:background 0.15s ease, border-color 0.15s ease, color 0.15s ease; }\n  .win-btn:hover{ background:linear-gradient(to bottom, #f6f9ff 0%, #e8f1ff 100%); border-color:#9fbef7; color:#0b3d91; }\n  .win-btn:active{ background:#dbe7ff; border-color:#7ea7ff; color:#0b3d91; }\n  .win-check{ display:inline-flex; align-items:center; gap:6px; font:11px var(--font-ui); color:var(--ink); }\n  .win-check input{ width:14px; height:14px; accent-color:var(--accent); }\n  .win-stat{ font:11px var(--font-ui); padding:4px 8px; background:#f3f5fb; border:1px solid var(--chrome-border); border-radius:6px; display:inline-flex; gap:6px; align-items:center; color:var(--ink-soft); }\n  input[type=\"number\"], select, input[type=\"text\"]{ font:11px var(--font-ui); padding:5px 8px; background:#fff; border:1px solid var(--chrome-border); border-radius:6px; color:var(--ink); min-height:28px; }\n  #status{ min-width:140px; }\n  .spacer{ flex:1 1 auto; }\n\n  /* Inspector */\n  #frameInspector{ display:none; flex-direction:column; align-items:flex-start; gap:4px; }\n  #frameInspector.active{ display:flex; }\n  #frameInspector .ins-grid{ display:grid; grid-template-columns:repeat(2, auto); gap:6px 12px; align-items:center; }\n  #frameInspector label{ font:11px var(--font-ui); display:flex; flex-direction:column; gap:3px; color:var(--ink); }\n  #frameInspector input[type=\"number\"], #frameInspector input[type=\"text\"], #frameInspector select{ min-width:72px; }\n  #frameInspector small{ font-size:10px; color:var(--ink-soft); }\n\n  /* ===== Sidebar ===== */\n  #sidebar{ position:fixed; top:var(--menu-h); left:var(--measure-w); bottom:0; width:var(--sidebar-w); background:#f9f9fb; border-right:1px solid var(--chrome-border); overflow:auto; padding:16px 14px; z-index:1000; display:flex; flex-direction:column; gap:16px; }\n  #releaseCard{ background:#fff; border:1px solid var(--chrome-border); border-radius:10px; padding:12px; font:11px var(--font-ui); color:var(--ink); box-shadow:0 1px 2px rgba(16,18,23,0.05); }\n  #releaseCard h2{ font:12px var(--font-ui); margin:0 0 8px 0; color:#0b3d91; letter-spacing:0.01em; text-transform:uppercase; }\n  #releaseCard p{ margin:0 0 6px 0; color:var(--ink-soft); }\n  #releaseCard ul{ margin:0; padding-left:18px; color:var(--ink-soft); }\n  #thumbs .thumb{ padding:8px; margin:8px 0; background:#fff; border:1px solid var(--chrome-border); border-radius:10px; cursor:pointer; transition:box-shadow 0.15s ease, border-color 0.15s ease; }\n  #thumbs .thumb:hover{ border-color:#9fbef7; box-shadow:0 6px 16px rgba(16,18,23,0.08); }\n  #thumbs .thumb.active{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(11,132,255,0.2); }\n  .mini-wrap{ width:160px; height:230px; overflow:hidden; position:relative; margin:4px auto; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(16,18,23,0.08); }\n  .mini-wrap .sheet{ box-shadow:none; border:none; }\n  .mini-wrap .trim::before, .mini-wrap .crop, .mini-wrap .marks{ display:none; }\n  .mini-meta{ text-align:center; font:10px var(--font-ui); color:var(--ink-soft); margin-top:6px; }\n\n  /* ===== Rulers ===== */\n  #rulerTop, #rulerLeft{ position:fixed; background:#f7f8fb; color:#000; font:10px var(--font-ui); z-index:900; pointer-events:none; }\n  #rulerTop{ top:calc(var(--menu-h) + 12px); left:calc(var(--measure-w) + var(--sidebar-w) + 12px); height:28px; width:calc(var(--sheet-w) + 36px); border:1px solid #808080; border-left:none; display:block; }\n  #rulerLeft{ top:calc(var(--menu-h) + 40px); left:calc(var(--measure-w) + var(--sidebar-w) - 24px); width:36px; height:calc(var(--sheet-h) + var(--workspace-pad)); border:1px solid #808080; border-top:none; display:block; }\n  #rulerTop::before{ content:\"\"; position:absolute; inset:0; background:\n    repeating-linear-gradient(to right, rgba(0,0,0,0.3) 0, rgba(0,0,0,0.3) 1px, transparent 1px, transparent 3.7795px),\n    repeating-linear-gradient(to right, rgba(0,0,0,0.6) 0, rgba(0,0,0,0.6) 1.3px, transparent 1.3px, transparent 37.795px),\n    repeating-linear-gradient(to right, rgba(128,0,0,0.45) 0, rgba(128,0,0,0.45) 1.5px, transparent 1.5px, transparent 96px);\n    opacity:0.55;\n  }\n  #rulerLeft::before{ content:\"\"; position:absolute; inset:0; background:\n    repeating-linear-gradient(to bottom, rgba(0,0,0,0.3) 0, rgba(0,0,0,0.3) 1px, transparent 1px, transparent 3.7795px),\n    repeating-linear-gradient(to bottom, rgba(0,0,0,0.6) 0, rgba(0,0,0,0.6) 1.3px, transparent 1.3px, transparent 37.795px),\n    repeating-linear-gradient(to bottom, rgba(128,0,0,0.45) 0, rgba(128,0,0,0.45) 1.5px, transparent 1.5px, transparent 96px);\n    opacity:0.55;\n  }\n  .ruler-labels{ position:relative; width:100%; height:100%; }\n  .ruler-labels span{ position:absolute; transform:translate(-50%,0); font-size:10px; color:#000; }\n  #rulerTop .inch span{ color:#800000; top:14px; }\n  #rulerTop .cm span{ top:2px; }\n  #rulerLeft .inch span{ color:#800000; left:14px; transform:translate(0,-50%); }\n  #rulerLeft .cm span{ left:2px; transform:translate(0,-50%); }\n\n  /* ===== Pages ===== */\n  #pageViewport{ margin-left:calc(var(--measure-w) + var(--sidebar-w) + 36px); padding:var(--workspace-pad) 20px 40px; transform-origin:top left; }\n  body.print-export #pageViewport{ margin:0 auto !important; padding:0 !important; transform:none !important; max-width:100%; }\n  #pages{ margin:0; padding:0; }\n  body.print-export #pages{ display:block; margin:0 auto !important; padding:0 !important; transform:none !important; }\n  .sheet{ position:relative; width:var(--sheet-w); height:var(--sheet-h); background:radial-gradient(circle at 30% 20%, rgba(255,255,255,0.45) 0%, transparent 42%), radial-gradient(circle at 70% 80%, rgba(255,255,255,0.38) 0%, transparent 46%), var(--paper); color:var(--ink); box-shadow:0 22px 40px rgba(16,18,23,0.14), 0 0 0 1px rgba(16,18,23,0.08); margin:18px auto; border:1px solid rgba(16,18,23,0.08); border-radius:12px; scroll-margin-top:calc(var(--menu-h) + var(--workspace-pad)); overflow:hidden; }\n  .sheet{ --inPage:var(--m-in); --outPage:var(--m-out); }\n  .sheet.even{ --inPage:var(--m-out); --outPage:var(--m-in); }\n  #viewportZoomControls{ position:fixed; right:28px; bottom:28px; display:flex; gap:10px; z-index:950; pointer-events:auto; }\n  #viewportZoomControls button{ width:38px; height:38px; border:1px solid var(--chrome-border-strong); background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; border-radius:10px; box-shadow:0 4px 12px rgba(16,18,23,0.12); color:var(--ink); transition:transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease; }\n  #viewportZoomControls button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(16,18,23,0.16); border-color:#9fbef7; color:#0b3d91; }\n  #viewportZoomControls button:disabled{ opacity:0.45; cursor:not-allowed; box-shadow:none; transform:none; }\n  #viewportZoomControls button:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }\n  #viewportZoomControls button svg{ width:16px; height:16px; fill:currentColor; }\n  body.preview-open #viewportZoomControls{ display:none; }\n  .sheet.theme-standard{ --paper:#fff; --ink:#111; --ink-soft:#444; }\n  .sheet.theme-newsprint{ --paper:#fdf4e3; --ink:#352a1a; --ink-soft:#6a4f2d; }\n  .sheet.theme-midnight{ --paper:#151b2c; --ink:#f2f6ff; --ink-soft:#c8d4ff; }\n  .sheet.theme-midnight .subtitle{ color:rgba(200,212,255,0.78); }\n  .sheet.theme-newsprint .subtitle{ color:rgba(106,79,45,0.75); }\n\n  /* Crop marks */\n  .crop{ position:absolute; width:0; height:0; }\n  .crop::before, .crop::after{ content:\"\"; position:absolute; background:#000; }\n  .crop.tl{ left:var(--bleed); top:var(--bleed); }\n  .crop.tr{ right:var(--bleed); top:var(--bleed); }\n  .crop.bl{ left:var(--bleed); bottom:var(--bleed); }\n  .crop.br{ right:var(--bleed); bottom:var(--bleed); }\n  .crop.tl::after, .crop.tr::after, .crop.bl::after, .crop.br::after{ height:var(--crop-w); width:var(--crop-l); }\n  .crop.tl::after{ left:0; top:calc(var(--m-top) - var(--crop-w)); transform:translateX(calc(-1 * var(--crop-l))); }\n  .crop.tr::after{ right:0; top:calc(var(--m-top) - var(--crop-w)); }\n  .crop.bl::after{ left:0; bottom:calc(var(--m-bot) - var(--crop-w)); transform:translateX(calc(-1 * var(--crop-l))); }\n  .crop.br::after{ right:0; bottom:calc(var(--m-bot) - var(--crop-w)); }\n  .crop.tl::before, .crop.tr::before, .crop.bl::before, .crop.br::before{ width:var(--crop-w); height:var(--crop-l); }\n  .crop.tl::before{ top:0; left:calc(var(--inPage) - var(--crop-w)); transform:translateY(calc(-1 * var(--crop-l))); }\n  .crop.tr::before{ top:0; right:calc(var(--outPage) - var(--crop-w)); transform:translateY(calc(-1 * var(--crop-l))); }\n  .crop.bl::before{ bottom:0; left:calc(var(--inPage) - var(--crop-w)); }\n  .crop.br::before{ bottom:0; right:calc(var(--outPage) - var(--crop-w)); }\n\n  /* Trim + content */\n  .trim{ position:absolute; left:var(--bleed); top:var(--bleed); width:var(--page-w); height:var(--page-h); }\n  .trim::before{ content:\"\"; position:absolute; left:var(--inPage); right:var(--outPage); top:var(--m-top); bottom:var(--m-bot); border:1px dotted rgba(16,18,23,0.35); }\n  .content{ position:absolute; left:var(--inPage); right:var(--outPage); top:var(--m-top); bottom:var(--m-bot); padding:2mm 0; }\n\n  /* Marks */\n  .marks{ position:absolute; inset:0; pointer-events:none; }\n  .marks .colorbar{ position:absolute; left:var(--bleed); right:var(--bleed); bottom:0.8mm; height:6mm; display:flex; gap:0.6mm; align-items:stretch; }\n  .marks .patch{ flex:0 0 10mm; height:100%; border:0.2pt solid #ccc; }\n  .patch.c{ background:#00B5E2; } .patch.m{ background:#D5006D; } .patch.y{ background:#FFD400; } .patch.k{ background:#000; }\n  .patch.r{ background:#FF3B30; } .patch.g{ background:#34C759; } .patch.b{ background:#007AFF; }\n  .patch.w{ background:#fff; } .patch.g10{ background:#1a1a1a; } .patch.g20{ background:#333; } .patch.g30{ background:#4d4d4d; }\n  .patch.g40{ background:#666; } .patch.g50{ background:#808080; } .patch.g60{ background:#999; } .patch.g70{ background:#b3b3b3; }\n  .patch.g80{ background:#ccc; } .patch.g90{ background:#e6e6e6; }\n  .marks .info{ position:absolute; right:var(--bleed); top:0.8mm; font:11px var(--font-ui); color:#000; background:#fff; padding:2px 4px; border:1px solid #808080; }\n  .marks .reg{ position:absolute; width:7mm; height:7mm; border-radius:50%; border:1px solid #000; }\n  .marks .reg::before, .marks .reg::after{ content:\"\"; position:absolute; left:50%; top:50%; background:#000; transform:translate(-50%,-50%); }\n  .marks .reg::before{ width:6mm; height:0.25mm; }\n  .marks .reg::after{ width:0.25mm; height:6mm; }\n  .marks .reg.tl{ left:1mm; top:1mm; } .marks .reg.tr{ right:1mm; top:1mm; }\n  .marks .reg.bl{ left:1mm; bottom:1mm; } .marks .reg.br{ right:1mm; bottom:1mm; }\n  .marks .safe-area{ position:absolute; left:var(--bleed); right:var(--bleed); top:var(--bleed); bottom:var(--bleed); border:1px dotted #bbb; }\n  body.printshop .marks::after{ content:\"\"; position:absolute; inset:0; background:\n    repeating-linear-gradient(to bottom, rgba(0,0,0,.06), rgba(0,0,0,.06) 0.4mm, transparent 0.4mm, transparent 1.6mm),\n    repeating-linear-gradient(to right, rgba(0,0,0,.04), rgba(0,0,0,.04) 0.4mm, transparent 0.4mm, transparent 1.6mm);\n  }\n  body.printshop .marks .slur{ position:absolute; width:14mm; height:14mm; border:1px dashed #000; border-radius:50%; left:calc(50% - 7mm); top:1mm; }\n\n  /* Content blocks */\n  h1,h2,h3{ font-family:var(--font-ui); margin:0 0 3mm 0; line-height:1.2; letter-spacing:0.01em; }\n  h1.title{ font-size:22px; letter-spacing:0.06em; text-transform:uppercase; color:rgba(16,18,23,0.9); }\n  .subtitle{ font:14px/1.5 var(--font-ui); color:#3d3b37; margin:0 0 3mm 0; letter-spacing:0.08em; text-transform:uppercase; }\n  .deck{ font:13px/1.6 var(--font-body); color:#24221f; margin:0 0 5mm 0; text-align:justify; }\n  h2{ font-size:15px; }\n  h3{ font-size:13px; }\n  p{ margin:0 0 3.2mm 0; hyphens:auto; orphans:3; widows:3; }\n  ul.bullet{ margin:0 0 3mm 0; padding-left:18px; }\n  ul.bullet li{ margin:0 0 2mm 0; }\n  .news-kicker{ font:11px var(--font-ui); letter-spacing:0.32em; text-transform:uppercase; color:var(--ink-soft); margin:0 0 2mm 0; }\n  .news-banner{ font:18px var(--font-ui); letter-spacing:0.08em; text-transform:uppercase; margin:0 0 2mm 0; }\n  .dropcap{ float:left; font:700 28px/0.8 var(--font-ui); margin:0 6px 2px 0; text-transform:uppercase; }\n  .news-rail{ border-top:2px solid var(--ink); border-bottom:2px solid var(--ink); padding:2mm 0; font:11px var(--font-ui); letter-spacing:0.28em; text-transform:uppercase; text-align:center; }\n  .ad-box{ border:2px double var(--ink); padding:3mm; font:11px var(--font-ui); text-transform:uppercase; letter-spacing:0.18em; background:rgba(0,0,0,0.04); }\n  .head{ padding:6mm 0 3mm 0; border-bottom:1px solid #ddd; }\n  .column-window-stack{ display:flex; flex-wrap:wrap; gap:6mm; padding:4mm 0 0 0; align-items:flex-start; position:relative; }\n  .column-window-stack.split{ margin-bottom:6mm; }\n  .column-window-stack.selected{ outline:1px dashed var(--accent); outline-offset:2px; }\n  .column-window{ flex:0 0 auto; min-width:45mm; min-height:40mm; max-width:calc(100% - 2mm); background:linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(252,248,240,0.96) 100%); border:1px solid rgba(16,18,23,0.12); box-shadow:0 12px 26px rgba(16,18,23,0.14); display:flex; flex-direction:column; resize:both; overflow:auto; position:relative; border-radius:8px; }\n  .column-window.dragging{ opacity:0.4; }\n  .column-window-header{ font:11px var(--font-ui); background:linear-gradient(180deg, #f7f4ed 0%, #e7e0d2 100%); color:#1b1a17; padding:3px 8px; border-bottom:1px solid rgba(16,18,23,0.12); display:flex; justify-content:space-between; align-items:center; cursor:grab; border-top-left-radius:8px; border-top-right-radius:8px; }\n  .column-window-header .label{ font-weight:600; text-transform:uppercase; }\n  .column-window-header .size{ font-weight:500; font-size:10px; color:#333; }\n  .column-window-content{ flex:1 1 auto; padding:4mm 4.5mm; font-size:13px; line-height:1.6; outline:1px dashed transparent; transition:outline 0.12s ease, background 0.12s ease; color:#24221f; text-align:justify; letter-spacing:0.01em; }\n  .column-window-content p{ margin:0 0 3.6mm 0; text-indent:1.6em; }\n  .column-window-content p:first-of-type{ text-indent:0; }\n  .column-window-content:focus{ outline:1px dashed #008080; background:rgba(0,128,128,0.08); }\n  .column-window-drop-indicator{ position:absolute; inset:-2px; border:2px dashed rgba(0,128,128,0.65); pointer-events:none; }\n  .column-window-stack.style-accent .column-window-content{ background:rgba(0,128,128,0.08); border-left:3px solid var(--accent); }\n  .column-window-stack.style-note .column-window-content{ background:rgba(255,225,150,0.45); border:1px dashed #c58a00; }\n  .column-window-stack.style-inverse .column-window{ background:#0c3c52; color:#f5faff; border-color:#203a50; border-right-color:#405068; border-bottom-color:#405068; }\n  .column-window-stack.style-inverse .column-window-header{ background:#162a40; color:#f5faff; border-bottom-color:#203a50; }\n  .column-window-stack.style-inverse .column-window-content{ color:#f5faff; }\n  .column-window-stack.style-inverse .column-window-content h2,\n  .column-window-stack.style-inverse .column-window-content h3{ color:#f5faff; }\n  .span-all{ column-span:all; break-before:column; break-after:column; }\n  .split{ padding-bottom:6mm; }\n  .foot{ padding:3mm 0 4mm 0; border-top:1px solid #ddd; font:11px var(--font-ui); color:#333; display:flex; justify-content:space-between; gap:6mm; }\n  .foot span{ flex:1 1 auto; }\n  .foot span[contenteditable=\"true\"]:focus{ outline:1px dashed #008080; }\n  figure.frame{ margin:0; }\n  .frame{ border:1px solid rgba(0,0,0,0.35); background:#fff; box-shadow:3px 3px 0 rgba(0,0,0,0.2); position:absolute; display:flex; flex-direction:column; }\n  .frame.mode-float-left, .frame.mode-float-right, .frame.mode-block{ position:relative; box-shadow:2px 2px 0 rgba(0,0,0,0.2); }\n  .frame.mode-float-left{ float:left; margin:0 4mm 3mm 0; }\n  .frame.mode-float-right{ float:right; margin:0 0 3mm 4mm; }\n  .frame.mode-block{ float:none; margin:3mm auto; }\n  .frame.selected{ outline:2px dashed #008080; }\n  .frame-content{ flex:1 1 auto; padding:3mm; font-size:12px; line-height:1.4; }\n  .frame-content:focus{ outline:1px dashed #008080; }\n  .frame-image{ flex:1 1 auto; background:repeating-linear-gradient(135deg,#dde7ef,#dde7ef 12px,#c7d6e5 12px,#c7d6e5 24px); display:flex; align-items:center; justify-content:center; color:#344860; font:11px var(--font-ui); text-align:center; padding:4mm; }\n  .frame-image[data-src]{ background-size:cover; background-position:center; color:transparent; text-indent:-9999px; }\n  .frame figcaption{ font:11px var(--font-ui); color:#333; padding:2mm 3mm 3mm; }\n  .frame .resize-handle{ position:absolute; width:10px; height:10px; background:#000080; border:1px solid #fff; display:none; }\n  .frame .resize-handle.se{ right:-5px; bottom:-5px; cursor:se-resize; }\n  .frame .resize-handle.e{ right:-5px; top:50%; transform:translateY(-50%); cursor:e-resize; }\n  .frame .resize-handle.s{ bottom:-5px; left:50%; transform:translateX(-50%); cursor:s-resize; }\n  .frame.selected .resize-handle{ display:block; }\n  .frame.style-outline{ border:2px solid var(--accent); box-shadow:4px 4px 0 rgba(0,128,128,0.2); }\n\n  /* Zoom controls */\n  #zoomControls{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }\n  #zoomControls button{ padding:2px 6px; font:12px var(--font-ui); background:#c0c0c0; border:2px solid #fff; border-right-color:#000; border-bottom-color:#000; cursor:pointer; }\n  #zoomControls button:active{ border:2px solid #000; border-right-color:#fff; border-bottom-color:#fff; }\n  #zoomDisplay{ font:12px var(--font-ui); background:#fff; border:2px solid #000; border-right-color:#fff; border-bottom-color:#fff; padding:2px 10px; min-width:56px; text-align:center; }\n\n  /* Full page preview */\n  body.preview-open{ overflow:hidden; }\n  #pagePreviewModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:32px; background:rgba(8,12,22,0.82); z-index:3200; }\n  #pagePreviewModal.open{ display:flex; }\n  #pagePreviewModal .page-preview-card{ width:min(1100px, 100%); height:min(90vh, 760px); background:#0f1626; border:3px solid #0a4d9c; border-right-color:#58a6ff; border-bottom-color:#58a6ff; box-shadow:0 18px 48px rgba(0,0,0,0.55); display:flex; flex-direction:column; }\n  .page-preview-bar{ display:flex; align-items:center; justify-content:space-between; gap:18px; padding:14px 18px; background:linear-gradient(135deg,#15213b,#0d1628); color:#f5f9ff; font:13px var(--font-ui); text-transform:uppercase; letter-spacing:0.08em; }\n  .page-preview-heading{ display:flex; flex-direction:column; gap:6px; font-size:12px; text-transform:none; letter-spacing:normal; }\n  .page-preview-heading strong{ font-size:15px; text-transform:uppercase; letter-spacing:0.12em; }\n  .page-preview-controls{ display:flex; align-items:center; gap:10px; }\n  .page-preview-controls button{ padding:4px 12px; font:12px var(--font-ui); background:#1e2c45; color:#f5f9ff; border:2px solid #0a4d9c; border-right-color:#58a6ff; border-bottom-color:#58a6ff; cursor:pointer; }\n  .page-preview-controls button:disabled{ opacity:0.45; cursor:not-allowed; }\n  .page-preview-controls button:active{ border-color:#58a6ff; border-right-color:#0a4d9c; border-bottom-color:#0a4d9c; }\n  .page-preview-controls input[type=\"range\"]{ accent-color:#58a6ff; width:160px; }\n  .page-preview-body{ flex:1; display:flex; align-items:center; gap:18px; padding:18px; background:#0a111f; }\n  .page-preview-viewport{ flex:1; height:100%; overflow:auto; background:rgba(12,20,34,0.6); border:2px solid rgba(72,118,181,0.45); border-radius:14px; padding:18px 24px; display:flex; justify-content:center; align-items:flex-start; }\n  .page-preview-viewport::-webkit-scrollbar{ width:10px; height:10px; }\n  .page-preview-viewport::-webkit-scrollbar-thumb{ background:rgba(88,166,255,0.35); border-radius:8px; }\n  .page-preview-sheet{ min-width:0; display:flex; justify-content:center; }\n  .page-preview-sheet .sheet{ transform-origin:top center; pointer-events:none; margin:0 auto; box-shadow:0 16px 40px rgba(0,0,0,0.45); }\n  .page-preview-nav{ width:44px; height:44px; border-radius:50%; border:2px solid #58a6ff; background:#14203a; color:#f5f9ff; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; }\n  .page-preview-nav:disabled{ opacity:0.35; cursor:not-allowed; }\n  .page-preview-nav:active{ border-color:#0a4d9c; }\n\n  @media (max-width: 640px){\n    #pagePreviewModal{ padding:16px; }\n    #pagePreviewModal .page-preview-card{ height:min(92vh, 640px); }\n    .page-preview-bar{ flex-direction:column; align-items:flex-start; gap:12px; }\n    .page-preview-controls{ flex-wrap:wrap; justify-content:flex-start; }\n    .page-preview-body{ flex-direction:column; align-items:stretch; }\n    .page-preview-nav{ width:100%; height:40px; border-radius:12px; }\n    .page-preview-viewport{ width:100%; }\n  }\n\n  /* Template modal */\n  #templateModal{ position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; display:none; align-items:center; justify-content:center; padding:24px; }\n  #templateModal.open{ display:flex; }\n  .template-modal-card{ background:#f4f4f4; border:3px solid #000; border-right-color:#fff; border-bottom-color:#fff; box-shadow:6px 6px 0 rgba(0,0,0,0.35); width:min(680px, 100%); max-height:calc(100vh - 48px); overflow:hidden; display:flex; flex-direction:column; }\n  .template-modal-header{ background:#000080; color:#fff; padding:14px 18px; font:16px var(--font-ui); text-transform:uppercase; letter-spacing:0.08em; }\n  .template-modal-body{ padding:18px; display:flex; flex-direction:column; gap:16px; overflow:auto; }\n  .template-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:14px; }\n  .template-option{ background:#fff; border:2px solid #808080; border-right-color:#fff; border-bottom-color:#fff; padding:12px; cursor:pointer; display:flex; flex-direction:column; gap:8px; min-height:140px; }\n  .template-option:hover, .template-option:focus{ outline:2px dashed #000080; }\n  .template-option h3{ margin:0; font:14px var(--font-ui); text-transform:uppercase; }\n  .template-option p{ margin:0; font:12px var(--font-ui); color:#222; }\n  .template-actions{ display:flex; justify-content:flex-end; gap:12px; margin-top:8px; }\n  .template-actions button{ padding:6px 16px; font:12px var(--font-ui); background:#c0c0c0; border:2px solid #fff; border-right-color:#000; border-bottom-color:#000; cursor:pointer; }\n  .template-actions button:active{ border:2px solid #000; border-right-color:#fff; border-bottom-color:#fff; }\n\n  @media print{\n    .column-window-stack{ display:block; outline:none !important; }\n    .column-window{ page-break-inside:avoid; box-shadow:none; border:1px solid #ccc; resize:none; min-width:auto; min-height:auto; width:auto !important; height:auto !important; }\n    .column-window-header{ display:none; }\n    .column-window-content{ outline:none; background:transparent !important; padding:0; }\n    #templateModal{ display:none !important; }\n  }\n  .frame.style-shadow{ box-shadow:6px 6px 0 rgba(0,0,0,0.35); }\n  .frame.style-banner figcaption{ background:var(--accent); color:#fff; text-transform:uppercase; letter-spacing:0.12em; padding:3mm 4mm; }\n  .frame.style-banner .frame-content{ padding-top:4mm; }\n  .quote{ font-size:14px; line-height:1.3; }\n  .attribution{ font:11px var(--font-ui); text-transform:uppercase; letter-spacing:0.08em; }\n  .callout{ font:12px var(--font-ui); font-weight:bold; }\n  .note{ font:12px var(--font-ui); }\n\n  /* Toggles */\n  body.hide-guides .trim::before{ display:none !important; }\n  body.hide-crops .crop{ display:none !important; }\n  body.hide-colorbar .marks .colorbar{ display:none !important; }\n  body.hide-reg .marks .reg{ display:none !important; }\n  body.hide-safe .marks .safe-area{ opacity:0 !important; }\n\n  /* Print overrides */\n  @media print{\n    @page{ size:216mm 303mm; margin:0; }\n    html,body{ width:216mm; height:303mm; margin:0; padding:0; }\n    #menubar,#ui,#sidebar,#rulerTop,#rulerLeft{ display:none!important; }\n    #pages{ margin:0; padding:0; }\n    body, #pages{ position:static !important; }\n    .sheet{ position:relative !important; left:0!important; top:0!important; width:216mm!important; height:303mm!important; margin:0!important; box-shadow:none!important; border:none!important; page-break-after:always; page-break-inside:avoid; overflow:hidden; }\n    .sheet:last-child{ page-break-after:auto; }\n    .trim{ left:3mm!important; top:3mm!important; width:210mm!important; height:297mm!important; }\n    :root{ --m-top:12mm; --m-bot:12mm; --m-in:12mm; --m-out:12mm; }\n    body.pdf-mirror .sheet.even{ --m-in:20mm; --m-out:14mm; }\n    *{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }\n    .frame .resize-handle{ display:none !important; }\n  }\n</style>\n<body>\n  <div id=\"menubar\" role=\"menubar\">\n    <button class=\"menu-root\" data-menu=\"file\" type=\"button\">File</button>\n    <button class=\"menu-root\" data-menu=\"export\" type=\"button\">Export</button>\n    <button class=\"menu-root\" data-menu=\"edit\" type=\"button\">Edit</button>\n    <button class=\"menu-root mobile-only\" id=\"mobileToggleTools\" type=\"button\" aria-controls=\"ui\" aria-expanded=\"false\">Tools</button>\n    <button class=\"menu-root mobile-only\" id=\"mobileTogglePages\" type=\"button\" aria-controls=\"sidebar\" aria-expanded=\"false\">Pages</button>\n    <div class=\"menu-dropdown\" data-panel=\"file\" role=\"menu\">\n      <button type=\"button\" data-action=\"new-doc\">New</button>\n      <button type=\"button\" data-action=\"open-doc\">Open‚Ä¶</button>\n      <button type=\"button\" data-action=\"save-doc\">Save</button>\n      <button type=\"button\" data-action=\"save-as-doc\">Save As‚Ä¶</button>\n      <div class=\"menu-sep\"></div>\n      <button type=\"button\" data-action=\"load-autosave\">Load Autosave</button>\n    </div>\n    <div class=\"menu-dropdown\" data-panel=\"export\" role=\"menu\">\n      <button type=\"button\" data-action=\"export-bleed\">Print with Bleed PDF</button>\n      <button type=\"button\" data-action=\"export-trim\">Print Trimmed PDF</button>\n      <div class=\"menu-sep\"></div>\n      <button type=\"button\" data-action=\"toggle-mirror\">Toggle Mirrored Gutter</button>\n      <button type=\"button\" data-action=\"toggle-printshop\">Toggle Printshop Grid</button>\n    </div>\n    <div class=\"menu-dropdown\" data-panel=\"edit\" role=\"menu\">\n      <button type=\"button\" data-action=\"add-col-1\">Add 1 Column Block</button>\n      <button type=\"button\" data-action=\"add-col-2\">Add 2 Column Block</button>\n      <button type=\"button\" data-action=\"add-col-3\">Add 3 Column Block</button>\n      <div class=\"menu-sep\"></div>\n      <button type=\"button\" data-action=\"add-text-frame\">Add Text Frame</button>\n      <button type=\"button\" data-action=\"add-image-frame\">Add Image Frame</button>\n      <div class=\"menu-sep\"></div>\n      <button type=\"button\" data-action=\"new-page\">New Page After Current</button>\n      <button type=\"button\" data-action=\"duplicate-page\">Duplicate Current Page</button>\n      <div class=\"menu-sep\"></div>\n      <button type=\"button\" data-action=\"toggle-guides\">Toggle Guides</button>\n      <button type=\"button\" data-action=\"toggle-crops\">Toggle Marks</button>\n      <button type=\"button\" data-action=\"toggle-colorbar\">Toggle Color Bars</button>\n    </div>\n  </div>\n\n  <div id=\"ui\">\n    <div class=\"win-group\" id=\"navGroup\">\n      <button class=\"win-btn\" id=\"firstBtn\">|‚óÄ</button>\n      <button class=\"win-btn\" id=\"prevBtn\">‚óÄ</button>\n      <span class=\"win-stat\">Page <span id=\"cur\">1</span> / <span id=\"tot\">1</span></span>\n      <input type=\"number\" id=\"goto\" min=\"1\" value=\"1\" />\n      <button class=\"win-btn\" id=\"goBtn\">Go</button>\n      <button class=\"win-btn\" id=\"nextBtn\">‚ñ∂</button>\n      <button class=\"win-btn\" id=\"lastBtn\">‚ñ∂|</button>\n    </div>\n    <div class=\"win-group\" id=\"pageActions\">\n      <button class=\"win-btn\" id=\"newPageBtn\">+ Page</button>\n      <button class=\"win-btn\" id=\"duplicatePageBtn\">Duplicate</button>\n    </div>\n    <div class=\"win-group\" id=\"zoomControls\">\n      <button class=\"win-btn\" id=\"zoomOutBtn\">‚àí</button>\n      <button class=\"win-btn\" id=\"zoomInBtn\">+</button>\n      <button class=\"win-btn\" id=\"zoomResetBtn\">Reset</button>\n      <button class=\"win-btn\" id=\"zoomFullBtn\">Fit Page</button>\n      <button class=\"win-btn\" id=\"openPreviewBtn\">Full Page View</button>\n      <span id=\"zoomDisplay\">100%</span>\n    </div>\n    <div class=\"win-group\" id=\"styleControls\">\n      <label class=\"win-check\">Page Style:\n        <select id=\"pageThemeSelect\">\n          <option value=\"standard\">Standard</option>\n          <option value=\"newsprint\">Newsprint</option>\n          <option value=\"midnight\">Midnight Studio</option>\n        </select>\n      </label>\n      <label class=\"win-check\">Element Style:\n        <select id=\"elementStyleSelect\" disabled>\n          <option value=\"standard\">Standard</option>\n        </select>\n      </label>\n    </div>\n    <div class=\"win-group\" id=\"toggleGroup\">\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkGuides\" checked> Guides</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkCrops\" checked> Marks</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkColor\" checked> Color bars</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkReg\" checked> Registration</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkSafe\"> Safe</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkShop\"> Printshop grid</label>\n      <label class=\"win-check\"><input type=\"checkbox\" id=\"chkMirror\"> Mirrored gutter (PDF)</label>\n      <label class=\"win-check\">Preset:\n        <select id=\"selColorPreset\">\n          <option value=\"std\">Standard</option>\n          <option value=\"ugra\">Ugra/Fogra 21</option>\n        </select>\n      </label>\n    </div>\n    <div class=\"win-group\" id=\"frameInspector\">\n      <div class=\"ins-grid\">\n        <label>X (mm)\n          <input type=\"number\" id=\"framePosX\" step=\"0.5\" />\n        </label>\n        <label>Y (mm)\n          <input type=\"number\" id=\"framePosY\" step=\"0.5\" />\n        </label>\n        <label>Width (mm)\n          <input type=\"number\" id=\"frameWidth\" step=\"0.5\" min=\"10\" />\n        </label>\n        <label>Height (mm)\n          <input type=\"number\" id=\"frameHeight\" step=\"0.5\" min=\"10\" />\n        </label>\n        <label>Wrap Mode\n          <select id=\"frameWrap\">\n            <option value=\"overlay\">Overlay (free)</option>\n            <option value=\"float-left\">Float Left</option>\n            <option value=\"float-right\">Float Right</option>\n            <option value=\"block\">Block</option>\n          </select>\n        </label>\n        <label>Caption\n          <input type=\"text\" id=\"frameCaption\" />\n        </label>\n        <label id=\"frameImageUrlLabel\">Image URL\n          <input type=\"text\" id=\"frameImageUrl\" placeholder=\"https://‚Ä¶\" />\n        </label>\n      </div>\n      <small>Edit values to reposition or update the selected frame.</small>\n    </div>\n    <div class=\"win-group\">\n      <span class=\"win-stat\" id=\"status\">Ready.</span>\n      <span class=\"win-stat\" id=\"ver\">Orbit OS v 0.2.0 ‚Ä¢ Docu Monster Studio Pro 0.1.1</span>\n    </div>\n  </div>\n\n  <div id=\"rulerTop\" aria-hidden=\"true\">\n    <div class=\"ruler-labels cm\"></div>\n    <div class=\"ruler-labels inch\"></div>\n  </div>\n  <div id=\"rulerLeft\" aria-hidden=\"true\">\n    <div class=\"ruler-labels cm\"></div>\n    <div class=\"ruler-labels inch\"></div>\n  </div>\n\n  <aside id=\"sidebar\">\n    <div id=\"releaseCard\"></div>\n    <div id=\"thumbs\"></div>\n  </aside>\n  <div id=\"pageViewport\">\n    <div id=\"pages\"></div>\n  </div>\n  <div id=\"viewportZoomControls\" role=\"group\" aria-label=\"Canvas zoom controls\">\n    <button type=\"button\" id=\"viewportZoomOut\" aria-label=\"Zoom out\">\n      <svg viewBox=\"0 0 24 24\" aria-hidden=\"true\" focusable=\"false\">\n        <rect x=\"5\" y=\"11\" width=\"14\" height=\"2\" rx=\"1\"></rect>\n      </svg>\n    </button>\n    <button type=\"button\" id=\"viewportZoomIn\" aria-label=\"Zoom in\">\n      <svg viewBox=\"0 0 24 24\" aria-hidden=\"true\" focusable=\"false\">\n        <rect x=\"11\" y=\"5\" width=\"2\" height=\"14\" rx=\"1\"></rect>\n        <rect x=\"5\" y=\"11\" width=\"14\" height=\"2\" rx=\"1\"></rect>\n      </svg>\n    </button>\n  </div>\n  <div id=\"pagePreviewModal\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"pagePreviewHeading\" tabindex=\"-1\" aria-hidden=\"true\">\n    <div class=\"page-preview-card\">\n      <div class=\"page-preview-bar\">\n        <div class=\"page-preview-heading\" id=\"pagePreviewHeading\">\n          <strong>Page Preview</strong>\n          <span>Page 1 of 1</span>\n        </div>\n        <div class=\"page-preview-controls\">\n          <button type=\"button\" id=\"pagePreviewZoomOut\">‚àí</button>\n          <input type=\"range\" id=\"pagePreviewZoomRange\" min=\"40\" max=\"200\" value=\"100\" />\n          <span id=\"pagePreviewZoomDisplay\">100%</span>\n          <button type=\"button\" id=\"pagePreviewZoomIn\">+</button>\n          <button type=\"button\" id=\"pagePreviewZoomFit\">Fit</button>\n          <button type=\"button\" id=\"pagePreviewClose\">Close</button>\n        </div>\n      </div>\n      <div class=\"page-preview-body\">\n        <button type=\"button\" class=\"page-preview-nav\" id=\"pagePreviewPrev\" aria-label=\"Previous page\">‚óÄ</button>\n        <div class=\"page-preview-viewport\" id=\"pagePreviewViewport\">\n          <div class=\"page-preview-sheet\" id=\"pagePreviewSheet\"></div>\n        </div>\n        <button type=\"button\" class=\"page-preview-nav\" id=\"pagePreviewNext\" aria-label=\"Next page\">‚ñ∂</button>\n      </div>\n    </div>\n  </div>\n  <div id=\"templateModal\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"templateModalTitle\" tabindex=\"-1\">\n    <div class=\"template-modal-card\">\n      <div class=\"template-modal-header\" id=\"templateModalTitle\">New Document Templates</div>\n      <div class=\"template-modal-body\">\n        <p>Select a starting layout for your next spread.</p>\n        <div class=\"template-grid\" id=\"templateList\"></div>\n        <div class=\"template-actions\">\n          <button type=\"button\" id=\"templateCancel\">Cancel</button>\n        </div>\n      </div>\n    </div>\n  </div>\n  <input type=\"file\" id=\"openFileInput\" accept=\".dx,.DX,.json,application/json\" hidden />\n\n<script>\n(function(){\n  'use strict';\n  const pxPerMm = 96/25.4;\n  const STORAGE_KEY = 'documonster-studiopro-autosave-v0-1';\n  const pagesEl = document.getElementById('pages');\n  const releaseCardEl = document.getElementById('releaseCard');\n  const curEl = document.getElementById('cur');\n  const totEl = document.getElementById('tot');\n  const gotoEl = document.getElementById('goto');\n  const prevBtn = document.getElementById('prevBtn');\n  const nextBtn = document.getElementById('nextBtn');\n  const firstBtn = document.getElementById('firstBtn');\n  const lastBtn = document.getElementById('lastBtn');\n  const goBtn = document.getElementById('goBtn');\n  const newPageBtn = document.getElementById('newPageBtn');\n  const duplicatePageBtn = document.getElementById('duplicatePageBtn');\n  const thumbsEl = document.getElementById('thumbs');\n  const chkGuides = document.getElementById('chkGuides');\n  const chkCrops = document.getElementById('chkCrops');\n  const chkColor = document.getElementById('chkColor');\n  const chkReg = document.getElementById('chkReg');\n  const chkSafe = document.getElementById('chkSafe');\n  const chkShop = document.getElementById('chkShop');\n  const chkMirror = document.getElementById('chkMirror');\n  const selColorPreset = document.getElementById('selColorPreset');\n  const pageThemeSelect = document.getElementById('pageThemeSelect');\n  const elementStyleSelect = document.getElementById('elementStyleSelect');\n  const statusEl = document.getElementById('status');\n  const versionEl = document.getElementById('ver');\n  const menubar = document.getElementById('menubar');\n  const uiPanel = document.getElementById('ui');\n  const sidebar = document.getElementById('sidebar');\n  const openFileInput = document.getElementById('openFileInput');\n  const frameInspector = document.getElementById('frameInspector');\n  const framePosX = document.getElementById('framePosX');\n  const framePosY = document.getElementById('framePosY');\n  const frameWidth = document.getElementById('frameWidth');\n  const frameHeight = document.getElementById('frameHeight');\n  const frameWrap = document.getElementById('frameWrap');\n  const frameCaption = document.getElementById('frameCaption');\n  const frameImageUrl = document.getElementById('frameImageUrl');\n  const frameImageUrlLabel = document.getElementById('frameImageUrlLabel');\n  const rulerTopEl = document.getElementById('rulerTop');\n  const rulerTopCm = document.querySelector('#rulerTop .cm');\n  const rulerTopIn = document.querySelector('#rulerTop .inch');\n  const rulerLeftEl = document.getElementById('rulerLeft');\n  const rulerLeftCm = document.querySelector('#rulerLeft .cm');\n  const rulerLeftIn = document.querySelector('#rulerLeft .inch');\n  const pageViewport = document.getElementById('pageViewport');\n  const zoomOutBtn = document.getElementById('zoomOutBtn');\n  const zoomInBtn = document.getElementById('zoomInBtn');\n  const zoomResetBtn = document.getElementById('zoomResetBtn');\n  const zoomFullBtn = document.getElementById('zoomFullBtn');\n  const zoomDisplay = document.getElementById('zoomDisplay');\n  const openPreviewBtn = document.getElementById('openPreviewBtn');\n  const templateModal = document.getElementById('templateModal');\n  const templateList = document.getElementById('templateList');\n  const templateCancel = document.getElementById('templateCancel');\n  const pagePreviewModal = document.getElementById('pagePreviewModal');\n  const pagePreviewViewport = document.getElementById('pagePreviewViewport');\n  const pagePreviewSheet = document.getElementById('pagePreviewSheet');\n  const pagePreviewClose = document.getElementById('pagePreviewClose');\n  const pagePreviewZoomRange = document.getElementById('pagePreviewZoomRange');\n  const pagePreviewZoomDisplay = document.getElementById('pagePreviewZoomDisplay');\n  const pagePreviewZoomIn = document.getElementById('pagePreviewZoomIn');\n  const pagePreviewZoomOutBtn = document.getElementById('pagePreviewZoomOut');\n  const pagePreviewZoomFit = document.getElementById('pagePreviewZoomFit');\n  const pagePreviewPrev = document.getElementById('pagePreviewPrev');\n  const pagePreviewNext = document.getElementById('pagePreviewNext');\n  const pagePreviewHeading = document.getElementById('pagePreviewHeading');\n  const viewportZoomOutBtn = document.getElementById('viewportZoomOut');\n  const viewportZoomInBtn = document.getElementById('viewportZoomIn');\n  const mobileToggleTools = document.getElementById('mobileToggleTools');\n  const mobileTogglePages = document.getElementById('mobileTogglePages');\n  const pageCanvasRoot = pagesEl || document;\n\n  let docModel = null;\n  let pages = [];\n  let obs = null;\n  let cur = 0;\n  let isDirty = false;\n  let menuOpen = null;\n  let selectedFrame = null;\n  let selectedFramePage = -1;\n  let selectedFrameIndex = -1;\n  let selectedColumnsBlock = null;\n  let selectedColumnsPage = -1;\n  let selectedColumnsIndex = -1;\n  let styledSelection = { type:null, pageIndex:-1, elementIndex:-1 };\n  let currentStyleOptionType = null;\n  let zoomLevel = 1;\n  let previewPageIndex = 0;\n  let previewZoomLevel = 1;\n  let previewShouldRefit = false;\n  let previewSyncFromSnap = false;\n  let columnDragState = null;\n\n  const PAGE_THEMES = ['standard','newsprint','midnight'];\n  const PAGE_THEME_CLASSES = PAGE_THEMES.map(t=>'theme-'+t);\n  const COLUMN_STYLES = ['standard','accent','note','inverse'];\n  const FRAME_STYLES = ['standard','outline','shadow','banner'];\n  const COLUMN_STYLE_CLASSES = COLUMN_STYLES.filter(v=>v!=='standard').map(v=>'style-'+v);\n  const FRAME_STYLE_CLASSES = FRAME_STYLES.filter(v=>v!=='standard').map(v=>'style-'+v);\n  const DX_MIME = 'application/vnd.orbit-documonster+json';\n  const DX_EXTENSION = '.dx';\n  const ACCEPTED_EXTENSIONS = ['.dx', '.json'];\n  const ELEMENT_STYLE_OPTIONS = {\n    columns:[\n      { value:'standard', label:'Standard Body' },\n      { value:'accent', label:'Accent Block' },\n      { value:'note', label:'Note Panel' },\n      { value:'inverse', label:'Inverse Type' }\n    ],\n    frame:[\n      { value:'standard', label:'Standard Frame' },\n      { value:'outline', label:'Outline Emphasis' },\n      { value:'shadow', label:'Drop Shadow Card' },\n      { value:'banner', label:'Banner Caption' }\n    ]\n  };\n\n  const MIN_CANVAS_ZOOM = 0.35;\n  const MAX_CANVAS_ZOOM = 2.5;\n  const MOBILE_BREAKPOINT = 1080;\n\n  const DEFAULT_TEMPLATE_ID = 'heritage-gazette';\n\n  let mobileAutoZoomed = false;\n\n  function createColumnElement(columns, windows, style = 'standard', layout = []){\n    const count = Math.min(4, Math.max(1, parseInt(columns, 10) || 1));\n    const normalizedWindows = Array.from({ length:count }, (_, idx)=>{\n      if(Array.isArray(windows) && typeof windows[idx] === 'string' && windows[idx].trim()){\n        return windows[idx];\n      }\n      if(idx === 0 && Array.isArray(windows) && typeof windows[0] === 'string'){\n        return windows[0];\n      }\n      return '<p>Start typing‚Ä¶</p>';\n    });\n    const normalizedLayout = Array.from({ length:count }, (_, idx)=>{\n      const slot = Array.isArray(layout) ? layout[idx] : null;\n      const width = slot && Number.isFinite(slot.width) ? slot.width : null;\n      const height = slot && Number.isFinite(slot.height) ? slot.height : null;\n      return { width, height };\n    });\n    return {\n      type:'columns',\n      columns:count,\n      windows:normalizedWindows,\n      windowLayout:normalizedLayout,\n      style:normalizeStyleValue('columns', style),\n      html: normalizedWindows.join('')\n    };\n  }\n\n  function createFrameModel(data){\n    return Object.assign({\n      type:'frame',\n      frameType:'text',\n      mode:'overlay',\n      x:30,\n      y:30,\n      width:60,\n      height:40,\n      content:'<p>Double-click to edit frame text.</p>',\n      src:'',\n      caption:'',\n      style:'standard'\n    }, data || {});\n  }\n\n  function heritageGazetteTemplate(){\n    return {\n      version:'1.3.0',\n      docVersion:'1.3.0',\n      codename:'Heritage Gazette',\n      docName:'Docu Monster Studio Pro',\n      releaseNotes:[\n        'Two-page broadsheet kit inspired by 1940s U.S. metropolitan newspapers.',\n        'Banner headlines, war bulletins, and local advertising rails mirror historic layouts.',\n        'Includes editorial, community, and radio listing modules tuned for serif body copy.'\n      ],\n      pages:[\n        {\n          title:'THE EVENING LEDGER',\n          subtitle:'Founded 1898 ‚Ä¢ Final Edition',\n          deck:'Compose a commanding banner with wire-photo placement and column grids faithful to 1940s broadsheets.',\n          theme:'standard',\n          elements:[\n            createColumnElement(1,[\n              '<p class=\"news-kicker\">Late City Final</p><h1 class=\"title news-banner\">Nation Watches Capitol Talks</h1><p class=\"deck\">Set your lede with decisive verbs and authoritative tone to anchor the edition.</p>'\n            ], 'standard', [ { width:160, height:46 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'block',\n              width:160,\n              height:80,\n              caption:'Swap in a wire-service photograph with a crisp cutline beneath the fold.',\n              style:'outline'\n            }),\n            createColumnElement(3,[\n              '<p><span class=\"dropcap\">W</span>ashington, D.C.‚ÄîWrite your front-page lead here. Reference telegraph briefings, committee chairs, and the national mood.</p><p>Follow with a second paragraph that delivers figures or quotations from correspondents to mirror syndicated coverage.</p>',\n              '<p><strong>Capitol Steps.</strong> Use this column for sidebars: highlight negotiations, floor debates, and analysis from the city desk.</p><p>Insert subheads or bold phrases like ‚ÄúIndustry Mobilizes‚Äù to punctuate the narrative.</p>',\n              '<p><strong>City Reaction.</strong> Quote streetcar riders, shopkeepers, and factory crews to humanize the headlines.</p><ul class=\"bullet\"><li>Strike board convenes at dawn</li><li>Bond drive surpasses goal</li><li>Victory gardens expanded</li></ul>'\n            ], 'standard', [ { width:55, height:115 }, { width:55, height:115 }, { width:55, height:115 } ]),\n            createColumnElement(2,[\n              '<div class=\"news-rail\">War Bulletins</div><p><strong>London.</strong> Summarize Allied movements with datelines and terse sentences.</p><p><strong>Pacific.</strong> Note convoy positions, naval escorts, and wireless reports.</p>',\n              '<div class=\"news-rail\">Home Front</div><p>Reserve this rail for ration reminders, blackout drills, or civil defense notices.</p><p>Keep copy tight, factual, and ready for last-minute rewrites.</p>'\n            ], 'note', [ { width:70, height:90 }, { width:70, height:90 } ]),\n            createFrameModel({\n              mode:'float-right',\n              width:60,\n              height:50,\n              content:'<div class=\"ad-box\">Place department store advertising, subscription drives, or classified spotlights here.</div>',\n              style:'banner'\n            })\n          ],\n          footerLeft:'The Evening Ledger ‚Ä¢ City Desk',\n          footerRight:'Edition {{version}} ‚Ä¢ Page {{page}} of {{total}}'\n        },\n        {\n          title:'SECOND SECTION',\n          subtitle:'Home Front & Community',\n          deck:'Inside spread with editorials, community notebook, and radio listings styled after 1940s feature pages.',\n          theme:'standard',\n          elements:[\n            createColumnElement(3,[\n              '<p><span class=\"dropcap\">E</span>ditorial Board‚ÄîCraft opinion columns with measured cadence. Cite letters, telegrams, and senate testimony for authenticity.</p><p>Use italics for signatures or board statements.</p>',\n              '<p><strong>Community Notebook.</strong> Chronicle charity teas, USO dances, and neighborhood drives with tidy paragraphing.</p><p>Include short subheads for each civic update.</p>',\n              '<p><strong>Sports Ticker.</strong> Post box scores, double-header recaps, and pennant races. Keep statistics in tight sentences for easy scanning.</p>'\n            ], 'standard', [ { width:55, height:110 }, { width:55, height:110 }, { width:55, height:110 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'block',\n              width:150,\n              height:60,\n              caption:'Drop in archival photography, courtroom sketches, or hometown portraits.',\n              style:'shadow'\n            }),\n            createFrameModel({\n              mode:'overlay',\n              x:22,\n              y:138,\n              width:70,\n              height:36,\n              content:'<div class=\"news-rail\">City Calendar</div><p>List parades, air-raid wardens‚Äô drills, and council meetings.</p>',\n              style:'banner'\n            }),\n            createFrameModel({\n              mode:'block',\n              width:150,\n              height:55,\n              content:'<div class=\"ad-box\">Evening Ledger Radio Listings<br>8:00‚ÄîDrama Hour<br>9:30‚ÄîSwing Session<br>11:00‚ÄîSign-Off News</div>',\n              style:'outline'\n            })\n          ],\n          footerLeft:'Ledger Features ‚Ä¢ Community Bureau',\n          footerRight:'Page {{page}} of {{total}} ‚Ä¢ {{codename}}'\n        }\n      ]\n    };\n  }\n\n  function velocityFeatureTemplate(){\n    return {\n      version:'1.2.0',\n      docVersion:'1.2.0',\n      codename:'Velocity Feature',\n      docName:'Docu Monster Studio Pro',\n      releaseNotes:[\n        'Wired-inspired feature grid with neon accent banding and modular hero art.',\n        'Pre-styled callouts and stat blocks for technology reporting.',\n        'Midnight studio theme tuned for high-contrast photography and white type.'\n      ],\n      pages:[\n        {\n          title:'VELOCITY MAGAZINE',\n          subtitle:'THE FUTURE OF URBAN MOBILITY',\n          deck:'An immersive feature package in the spirit of WIRED with asymmetric image anchors and modular columns.',\n          theme:'midnight',\n          elements:[\n            createFrameModel({\n              frameType:'image',\n              mode:'block',\n              width:150,\n              height:90,\n              caption:'Swap in a hero image to anchor the feature opener. The layout reserves space for headline overlays.',\n              style:'shadow'\n            }),\n            createColumnElement(2,[\n              '<p>Electric grids, edge computing, and autonomous systems converge in cities worldwide. Velocity traces the code that keeps night routes glowing and safe.</p>'+\n              '<p>From Seoul to San Francisco, transit directors are shipping beta firmware to bus depots like clockwork.</p>',\n              '<p>Use this spread to narrate the main story. Neon dividers and uppercase subheads evoke the velocity of printed tech monthlies.</p>'+\n              '<p>Drop quotes or stats into the overlay frames to punctuate your reporting.</p>'\n            ], 'inverse', [ { width:90, height:120 }, { width:90, height:120 } ]),\n            createFrameModel({\n              frameType:'text',\n              mode:'overlay',\n              x:118,\n              y:45,\n              width:60,\n              height:32,\n              content:'<p class=\"callout\">Key stat: 68% of commuters will ride autonomous shuttles by 2032, according to the Velocity Index.</p>',\n              style:'banner'\n            }),\n            createColumnElement(3,[\n              '<h3 class=\"span-all\">Signal Boost</h3><p>Map out the partners accelerating this rollout‚Äîfrom chipset designers to city halls.</p>',\n              '<p>Short blocks like these mimic Wired‚Äôs modular briefs. Keep entries sharp and data-rich.</p>',\n              '<p>Pair each card with icons or mini graphics by converting the frame style to accent mode.</p>'\n            ], 'accent', [ { width:55, height:90 }, { width:55, height:90 }, { width:55, height:90 } ])\n          ],\n          footerLeft:'Velocity Magazine ‚Ä¢ Tech Futures',\n          footerRight:'Feature Package ‚Ä¢ Page {{page}}/{{total}}'\n        },\n        {\n          title:'VELOCITY LAB',\n          subtitle:'Prototypes, pilots, and platform bets',\n          deck:'A modular lab page for deep dives and annotated diagrams.',\n          theme:'midnight',\n          elements:[\n            createColumnElement(3,[\n              '<p><strong>Prototype Watch.</strong> Catalog the hardware labs refining lidar, solid-state batteries, and curbside hubs.</p>',\n              '<p><strong>Policy Shift.</strong> Summarize the latest legislation that keeps micromobility lanes funded.</p>',\n              '<p><strong>Platform Notes.</strong> Break down the API updates your engineering desk should watch.</p>'\n            ], 'standard', [ { width:58, height:120 }, { width:58, height:120 }, { width:58, height:120 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'overlay',\n              x:92,\n              y:132,\n              width:78,\n              height:58,\n              caption:'Overlay a system diagram or product render to mirror the iconic Wired lab sections.',\n              style:'outline'\n            }),\n            createFrameModel({\n              frameType:'text',\n              mode:'float-right',\n              width:60,\n              height:45,\n              content:'<p class=\"note\">Edit the inspector to switch this card to accent or inverse styling. Perfect for listing specs or upcoming release dates.</p>',\n              style:'shadow'\n            })\n          ],\n          footerLeft:'Velocity Lab Notes',\n          footerRight:'Docu Monster Studio Pro ‚Ä¢ Page {{page}}'\n        },\n        {\n          title:'DATA STUDIO',\n          subtitle:'Urban metrics decoded',\n          deck:'Use this closer to visualise metrics and highlight reporter notes.',\n          theme:'midnight',\n          elements:[\n            createColumnElement(2,[\n              '<h3 class=\"span-all\">Timeline: Autonomy Arrives</h3><p>Build a milestone timeline inside these windows. Mix bold numerals with short descriptors to emulate print infographics.</p>',\n              '<p>Pair the second column with insight cards or analyst commentary. Swap styles for quick emphasis.</p>'\n            ], 'accent', [ { width:88, height:110 }, { width:88, height:110 } ]),\n            createFrameModel({\n              frameType:'text',\n              mode:'overlay',\n              x:25,\n              y:140,\n              width:70,\n              height:40,\n              content:'<p class=\"quote\">‚ÄúStreet-level autonomy is no longer a lab experiment‚Äîit‚Äôs live code in need of constant tuning.‚Äù</p><p class=\"attribution\">‚Äî Velocity Magazine</p>',\n              style:'banner'\n            }),\n            createFrameModel({\n              frameType:'image',\n              mode:'block',\n              width:120,\n              height:60,\n              caption:'Use this block for heat maps or city grid composites that stretch across both columns.',\n              style:'shadow'\n            })\n          ],\n          footerLeft:'Velocity ‚Ä¢ Data Studio',\n          footerRight:'{{codename}} {{version}} ‚Ä¢ Page {{page}}/{{total}}'\n        }\n      ]\n    };\n  }\n\n  function metropolisBriefingTemplate(){\n    return {\n      version:'1.2.0',\n      docVersion:'1.2.0',\n      codename:'Metropolis Briefing',\n      docName:'Docu Monster Studio Pro',\n      releaseNotes:[\n        'Broadsheet front page inspired by The New York Times with balanced serif typography.',\n        'Built-in opinion column and skyline photo frame with print-style captions.',\n        'Mirrored gutter-friendly layout tuned for broadsheet exports.'\n      ],\n      pages:[\n        {\n          title:'METROPOLIS MORNING TIMES',\n          subtitle:'National Edition ‚Ä¢ Founded 1896',\n          deck:'A restrained broadsheet composition echoing The New York Times front page with measured columns and hierarchy.',\n          theme:'newsprint',\n          elements:[\n            createColumnElement(4,[\n              '<p><strong>Lead Story.</strong> Set the tone with measured sentences, classic serif styling, and paragraph spacing that mirrors print.</p>',\n              '<p>Use the second column for continuation or a secondary report. Crossheads and italics capture the voice of the paper.</p>',\n              '<p>Third column holds analytical graf or data note. Keep sentences crisp to preserve the broadsheet rhythm.</p>',\n              '<p>Reserve the fourth column for quick reactions, background, or explainer boxes.</p>'\n            ], 'standard', [ { width:40, height:140 }, { width:40, height:140 }, { width:40, height:140 }, { width:40, height:140 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'overlay',\n              x:60,\n              y:60,\n              width:88,\n              height:60,\n              caption:'Classic skyline photo box with italicised caption, sized for broadsheet above-the-fold imagery.',\n              style:'outline'\n            }),\n            createColumnElement(2,[\n              '<h3 class=\"span-all\">Editorial Board</h3><p>The left window is ideal for a lead editorial or analysis column.</p>',\n              '<p>Use the right window for an op-ed or letters to the editor. Swap to inverse styling for weekend editions.</p>'\n            ], 'note', [ { width:85, height:90 }, { width:85, height:90 } ])\n          ],\n          footerLeft:'Metropolis Morning Times',\n          footerRight:'City Desk ‚Ä¢ Page {{page}} of {{total}}'\n        },\n        {\n          title:'IN FOCUS',\n          subtitle:'Investigations & Culture',\n          deck:'A second spread for investigative packages, arts coverage, and long-form features.',\n          theme:'newsprint',\n          elements:[\n            createColumnElement(3,[\n              '<p><strong>Long Read.</strong> Continue the main package with considered columns and generous pull quotes.</p>',\n              '<p>Middle column can host timeline sidebars or fact boxes with drop caps.</p>',\n              '<p>Third column supports arts, book reviews, or metro briefs just like the Sunday section.</p>'\n            ], 'standard', [ { width:55, height:130 }, { width:55, height:130 }, { width:55, height:130 } ]),\n            createFrameModel({\n              frameType:'text',\n              mode:'float-left',\n              width:50,\n              height:45,\n              content:'<p class=\"quote\">‚ÄúMetropolitan reporting demands nuance. Pair this pull quote with investigative highlights.‚Äù</p>',\n              style:'banner'\n            }),\n            createFrameModel({\n              frameType:'image',\n              mode:'float-right',\n              width:60,\n              height:55,\n              caption:'Use this portrait frame for reporters, sources, or archival photography.',\n              style:'shadow'\n            })\n          ],\n          footerLeft:'Metropolis Culture',\n          footerRight:'Edition {{version}} ‚Ä¢ Page {{page}}'\n        }\n      ]\n    };\n  }\n\n  function atlasExpeditionTemplate(){\n    return {\n      version:'1.2.0',\n      docVersion:'1.2.0',\n      codename:'Atlas Expedition',\n      docName:'Docu Monster Studio Pro',\n      releaseNotes:[\n        'Travel feature modeled after National Geographic spreads with immersive photography.',\n        'Caption-ready floating frames and story windows for field notes.',\n        'Adventure log cards and expedition timeline styled for magazine production.'\n      ],\n      pages:[\n        {\n          title:'ATLAS EXPEDITION REPORT',\n          subtitle:'Into the Karakoram',\n          deck:'A National Geographic-inspired opener with sweeping imagery, rich serif deck, and editorial annotations.',\n          theme:'standard',\n          elements:[\n            createFrameModel({\n              frameType:'image',\n              mode:'overlay',\n              x:26,\n              y:40,\n              width:160,\n              height:95,\n              caption:'Replace with your hero landscape. The frame spans the spread for cinematic impact.',\n              style:'shadow'\n            }),\n            createColumnElement(2,[\n              '<p>Begin with a narrative lede and descriptive language. This column is tuned for NatGeo-style storytelling with immersive detail.</p>',\n              '<p>Use the right-hand column for context: expedition logistics, altitude stats, and the science behind the journey.</p>'\n            ], 'accent', [ { width:80, height:110 }, { width:80, height:110 } ]),\n            createFrameModel({\n              frameType:'text',\n              mode:'overlay',\n              x:150,\n              y:120,\n              width:60,\n              height:38,\n              content:'<p class=\"note\">Field Note: Record GPS coordinates, elevation, and weather to mimic real expedition captions.</p>',\n              style:'banner'\n            })\n          ],\n          footerLeft:'Atlas Expedition ‚Ä¢ Field Journal',\n          footerRight:'Page {{page}} ‚Ä¢ {{codename}} {{version}}'\n        },\n        {\n          title:'FIELD JOURNAL',\n          subtitle:'Voices from the trail',\n          deck:'Layer quotes, sidebars, and equipment callouts as seen in premium travel magazines.',\n          theme:'standard',\n          elements:[\n            createColumnElement(3,[\n              '<p><strong>Journal Entry.</strong> Chronicle day-by-day impressions with italic standfirsts and generous margins.</p>',\n              '<p><strong>Research Log.</strong> Summarise the scientific mission, sample data, or interview highlights.</p>',\n              '<p><strong>Logistics.</strong> Detail access routes, permit requirements, and gear lists for fellow explorers.</p>'\n            ], 'standard', [ { width:55, height:120 }, { width:55, height:120 }, { width:55, height:120 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'float-right',\n              width:70,\n              height:60,\n              caption:'Drop in portraiture or macro shots to echo National Geographic photo essays.',\n              style:'outline'\n            }),\n            createFrameModel({\n              frameType:'text',\n              mode:'float-left',\n              width:60,\n              height:45,\n              content:'<p class=\"callout\">Gear Locker: list essential equipment, camera settings, or survival tips in this card.</p>',\n              style:'shadow'\n            })\n          ],\n          footerLeft:'Atlas Expedition Notes',\n          footerRight:'Field Journal ‚Ä¢ Page {{page}}/{{total}}'\n        },\n        {\n          title:'EXPEDITION DATA',\n          subtitle:'Elevation, routes, and observations',\n          deck:'A closing spread dedicated to annotated maps and specimen logs.',\n          theme:'standard',\n          elements:[\n            createColumnElement(2,[\n              '<h3 class=\"span-all\">Route Timeline</h3><p>Plot the trek from base camp to summit. Break each stage into digestible paragraphs for clarity.</p>',\n              '<p>Pair the second column with measurements, species lists, or glaciology insights to mirror NatGeo research pages.</p>'\n            ], 'accent', [ { width:85, height:110 }, { width:85, height:110 } ]),\n            createFrameModel({\n              frameType:'image',\n              mode:'block',\n              width:120,\n              height:65,\n              caption:'Use this space for a locator map, drone mosaic, or geological cross-section.',\n              style:'shadow'\n            }),\n            createFrameModel({\n              frameType:'text',\n              mode:'overlay',\n              x:30,\n              y:140,\n              width:65,\n              height:36,\n              content:'<p class=\"note\">Checklist: Document species observed, weather anomalies, or cultural insights.</p>',\n              style:'banner'\n            })\n          ],\n          footerLeft:'Atlas Expedition Research',\n          footerRight:'Docu Monster ‚Ä¢ Page {{page}}/{{total}}'\n        }\n      ]\n    };\n  }\n\n  function blankTemplate(){\n    return {\n      version:'1.2.0',\n      docVersion:'1.2.0',\n      codename:'Studio Blank',\n      docName:'Docu Monster Studio Pro',\n      releaseNotes:['An empty grid with guides and a neutral theme for building bespoke spreads.'],\n      pages:[\n        {\n          title:'UNTITLED FEATURE',\n          subtitle:'',\n          deck:'',\n          theme:'standard',\n          elements:[\n            createColumnElement(2,['<p>Start typing‚Ä¶</p>','<p>Duplicate or delete blocks to suit your brief.</p>']),\n            createFrameModel({\n              frameType:'image',\n              mode:'overlay',\n              x:90,\n              y:70,\n              width:80,\n              height:55,\n              caption:'Drop an image or chart here when planning your layout.',\n              style:'outline'\n            })\n          ],\n          footerLeft:'Docu Monster Studio Pro',\n          footerRight:'Page {{page}} / {{total}}'\n        }\n      ]\n    };\n  }\n\n  const DOCUMENT_TEMPLATES = [\n    { id:'heritage-gazette', label:'Heritage Gazette Front Page', description:'Traditional 1940s U.S. newspaper spread with banner headlines and classifieds.', create:heritageGazetteTemplate },\n    { id:'velocity-feature', label:'Velocity Magazine Feature', description:'Wired-inspired technology feature with neon accents.', create:velocityFeatureTemplate },\n    { id:'metropolis-briefing', label:'Metropolis Morning Briefing', description:'New York Times-style broadsheet front page.', create:metropolisBriefingTemplate },\n    { id:'atlas-expedition', label:'Atlas Expedition Report', description:'National Geographic-inspired travel narrative.', create:atlasExpeditionTemplate },\n    { id:'blank-spread', label:'Blank Studio Spread', description:'Neutral grid ready for bespoke layouts.', create:blankTemplate }\n  ];\n\n  const TEMPLATE_MAP = new Map(DOCUMENT_TEMPLATES.map(t=>[t.id, t]));\n\n  docModel = normalizeDocument(loadFromStorage() || TEMPLATE_MAP.get(DEFAULT_TEMPLATE_ID).create());\n\n  function mmToPx(mm){ return mm * pxPerMm; }\n  function pxToMm(px){ return px / pxPerMm; }\n  function getTotalPages(){ return docModel.pages.length || 1; }\n\n  function defaultDocument(){\n    const entry = TEMPLATE_MAP.get(DEFAULT_TEMPLATE_ID);\n    return entry ? entry.create() : velocityFeatureTemplate();\n  }\n\n  function normalizeDocument(input){\n    const base = defaultDocument();\n    const doc = Object.assign({}, base, input || {});\n    doc.version = doc.version || base.version;\n    doc.docVersion = doc.docVersion || base.docVersion;\n    doc.codename = doc.codename || base.codename;\n    doc.docName = typeof doc.docName === 'string' && doc.docName.trim() ? doc.docName : base.docName;\n    doc.releaseNotes = Array.isArray(doc.releaseNotes) && doc.releaseNotes.length ? doc.releaseNotes : base.releaseNotes.slice();\n    doc.pages = Array.isArray(doc.pages) && doc.pages.length ? doc.pages.map(normalizePage) : base.pages.slice().map(normalizePage);\n    return doc;\n  }\n\n  function normalizeTheme(value){\n    return PAGE_THEMES.includes(value) ? value : 'standard';\n  }\n\n  function normalizeStyleValue(type, value){\n    const list = type === 'frame' ? FRAME_STYLES : COLUMN_STYLES;\n    return list.includes(value) ? value : 'standard';\n  }\n\n  function normalizePage(page, idx){\n    const p = Object.assign({\n      title:'Untitled Page '+(idx+1),\n      subtitle:'',\n      deck:'',\n      elements:[],\n      footerLeft:'Docu Monster Studio Pro',\n      footerRight:'Page {{page}}',\n      theme:'standard'\n    }, page || {});\n    p.theme = normalizeTheme(p.theme);\n    p.elements = Array.isArray(p.elements) ? p.elements.map(normalizeElement) : [];\n    return p;\n  }\n\n  function normalizeElement(el){\n    if(!el || !el.type){\n      return createColumnElement(1, ['<p>Edit me.</p>']);\n    }\n    if(el.type === 'columns'){\n      const columns = Math.min(4, Math.max(1, parseInt(el.columns, 10) || (Array.isArray(el.windows) ? el.windows.length : 1)));\n      const windows = Array.isArray(el.windows) ? el.windows.slice(0, columns).map(html=> typeof html === 'string' && html.trim() ? html : '<p>Start typing‚Ä¶</p>') : [];\n      if(!windows.length){\n        const baseHtml = typeof el.html === 'string' ? el.html : '<p>Edit me.</p>';\n        windows.push(baseHtml);\n      }\n      while(windows.length < columns){\n        windows.push('<p>Start typing‚Ä¶</p>');\n      }\n      const layout = Array.isArray(el.windowLayout) ? el.windowLayout.slice(0, columns).map(item=>({\n        width: item && Number.isFinite(item.width) ? item.width : null,\n        height: item && Number.isFinite(item.height) ? item.height : null\n      })) : [];\n      while(layout.length < columns){\n        layout.push({ width:null, height:null });\n      }\n      return {\n        type:'columns',\n        columns,\n        windows,\n        windowLayout:layout,\n        style: normalizeStyleValue('columns', el.style),\n        html: windows.join('')\n      };\n    }\n    const mode = el.mode || 'overlay';\n    return {\n      type:'frame',\n      frameType: el.frameType === 'image' ? 'image' : 'text',\n      mode: mode,\n      x: typeof el.x === 'number' ? el.x : 30,\n      y: typeof el.y === 'number' ? el.y : 40,\n      width: typeof el.width === 'number' ? el.width : 60,\n      height: typeof el.height === 'number' ? el.height : 40,\n      content: typeof el.content === 'string' ? el.content : '<p>Frame content</p>',\n      src: typeof el.src === 'string' ? el.src : '',\n      caption: typeof el.caption === 'string' ? el.caption : '',\n      style: normalizeStyleValue('frame', el.style)\n    };\n  }\n\n  function loadFromStorage(){\n    try{\n      const raw = localStorage.getItem(STORAGE_KEY);\n      if(!raw) return null;\n      return JSON.parse(raw);\n    }catch(err){\n      console.warn('Failed to load autosave', err);\n      return null;\n    }\n  }\n\n  function saveToStorage(){\n    try{\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(docModel));\n      markDirty(false);\n      setStatus('Saved to local storage (.dx autosave).');\n    }catch(err){\n      console.error('Save failed', err);\n      setStatus('Save failed: '+err.message, false);\n    }\n  }\n\n  function markDirty(state = true){\n    isDirty = state;\n    document.body.classList.toggle('dirty', isDirty);\n    if(isDirty){\n      setStatus('Unsaved changes', false);\n    }\n  }\n\n  function setStatus(msg, transient = true){\n    statusEl.textContent = msg;\n    if(transient){\n      clearTimeout(setStatus._timer);\n      setStatus._timer = setTimeout(()=>{\n        statusEl.textContent = isDirty ? 'Unsaved changes' : 'Ready.';\n      }, 3200);\n    }\n  }\n\n  function updateVersionInfo(){\n    versionEl.textContent = docModel.codename+' v '+docModel.version+' ‚Ä¢ '+docModel.docName+' '+docModel.docVersion;\n    document.title = 'Docu Monster Studio Pro ‚Äî '+docModel.codename+' v '+docModel.version;\n  }\n\n  function renderReleaseCard(){\n    const notes = (docModel.releaseNotes || []).map(note=>'<li>'+note+'</li>').join('');\n    releaseCardEl.innerHTML = '<h2>'+docModel.codename+' v '+docModel.version+'</h2>'+\n      '<p>'+docModel.docName+' '+docModel.docVersion+' ‚Ä¢ '+docModel.codename+' v '+docModel.version+'</p>'+\n      '<ul>'+notes+'</ul>';\n  }\n\n  function createTrim(section){\n    const trim = document.createElement('div');\n    trim.className = 'trim';\n    ['tl','tr','bl','br'].forEach(pos=>{\n      const m = document.createElement('div');\n      m.className = 'crop '+pos;\n      trim.appendChild(m);\n    });\n    section.appendChild(trim);\n    return trim;\n  }\n\n  function addMarks(section, idx){\n    const marks = document.createElement('div');\n    marks.className = 'marks';\n    const bar = document.createElement('div');\n    bar.className = 'colorbar';\n    marks.appendChild(bar);\n    const info = document.createElement('div');\n    info.className = 'info';\n    info.textContent = docModel.codename+' v '+docModel.version+' ‚Äî page '+(idx+1)+'/'+getTotalPages();\n    marks.appendChild(info);\n    ['tl','tr','bl','br'].forEach(pos=>{\n      const r = document.createElement('div');\n      r.className = 'reg '+pos;\n      marks.appendChild(r);\n    });\n    const safe = document.createElement('div');\n    safe.className = 'safe-area';\n    marks.appendChild(safe);\n    const slur = document.createElement('div');\n    slur.className = 'slur';\n    marks.appendChild(slur);\n    section.appendChild(marks);\n  }\n\n  function targetWindowIndicator(windowEl){\n    let indicator = windowEl.querySelector('.column-window-drop-indicator');\n    if(!indicator){\n      indicator = document.createElement('div');\n      indicator.className = 'column-window-drop-indicator';\n      windowEl.appendChild(indicator);\n    }\n    return indicator;\n  }\n\n  function renderPage(page, idx){\n    const sheet = document.createElement('section');\n    sheet.className = 'sheet '+(idx%2 ? 'even' : 'odd');\n    sheet.dataset.index = String(idx);\n    applyPageThemeClass(sheet, page.theme || 'standard');\n    const trim = createTrim(sheet);\n    const content = document.createElement('div');\n    content.className = 'content';\n    trim.appendChild(content);\n    addMarks(sheet, idx);\n\n    const head = document.createElement('header');\n    head.className = 'head';\n    const titleEl = document.createElement('h1');\n    titleEl.className = 'title';\n    titleEl.contentEditable = 'true';\n    titleEl.textContent = page.title;\n    titleEl.addEventListener('input', ()=>{ page.title = titleEl.textContent.trim(); markDirty(); });\n    head.appendChild(titleEl);\n\n    const sub = document.createElement('p');\n    sub.className = 'subtitle';\n    sub.contentEditable = 'true';\n    sub.textContent = page.subtitle || '';\n    sub.addEventListener('input', ()=>{ page.subtitle = sub.textContent.trim(); markDirty(); });\n    head.appendChild(sub);\n\n    const deck = document.createElement('p');\n    deck.className = 'deck';\n    deck.contentEditable = 'true';\n    deck.textContent = page.deck || '';\n    deck.addEventListener('input', ()=>{ page.deck = deck.textContent.trim(); markDirty(); });\n    head.appendChild(deck);\n    content.appendChild(head);\n\n    page.elements.forEach((el, elementIndex)=>{\n      if(el.type === 'columns'){\n        const stack = document.createElement('div');\n        stack.className = 'column-window-stack split';\n        stack.dataset.pageIndex = String(idx);\n        stack.dataset.elementIndex = String(elementIndex);\n        el.style = applyElementStyleClass(stack, el.style, 'columns');\n        const windows = Array.isArray(el.windows) ? el.windows : [typeof el.html === 'string' ? el.html : '<p>Edit me.</p>'];\n        if(!Array.isArray(el.windowLayout) || el.windowLayout.length !== windows.length){\n          el.windowLayout = windows.map(()=>({ width:null, height:null }));\n        }\n        if(selectedColumnsPage === idx && selectedColumnsIndex === elementIndex){\n          selectedColumnsBlock = stack;\n          stack.classList.add('selected');\n        }\n\n        const updateSizeLabel = (windowEl, labelEl, windowIndex, triggerDirty = false)=>{\n          const widthPx = windowEl.offsetWidth;\n          const heightPx = windowEl.offsetHeight;\n          const widthMm = parseFloat(pxToMm(widthPx).toFixed(1));\n          const heightMm = parseFloat(pxToMm(heightPx).toFixed(1));\n          labelEl.textContent = Math.round(widthMm)+'√ó'+Math.round(heightMm)+'mm';\n          const prev = el.windowLayout[windowIndex] || { width:null, height:null };\n          const changed = !prev || Math.abs((prev.width || 0) - widthMm) > 0.2 || Math.abs((prev.height || 0) - heightMm) > 0.2;\n          el.windowLayout[windowIndex] = { width:widthMm, height:heightMm };\n          if(triggerDirty && changed){\n            markDirty();\n          }\n        };\n\n        const handleWindowResize = (windowEl, labelEl, windowIndex)=>{\n          const observer = new ResizeObserver(()=>{\n            updateSizeLabel(windowEl, labelEl, windowIndex, true);\n          });\n          observer.observe(windowEl);\n        };\n\n        const ensureDropCleanup = ()=>{\n          stack.querySelectorAll('.column-window-drop-indicator').forEach(el=>el.remove());\n        };\n\n        const handleDragDrop = (targetWindow, event)=>{\n          if(!columnDragState || columnDragState.pageIndex !== idx || columnDragState.elementIndex !== elementIndex) return;\n          event.preventDefault();\n          const fromIndex = columnDragState.windowIndex;\n          let toIndex = parseInt(targetWindow.dataset.windowIndex, 10);\n          const rect = targetWindow.getBoundingClientRect();\n          const isAfter = (event.clientX - rect.left) > rect.width/2;\n          if(isAfter) toIndex += 1;\n          handleColumnReorder(idx, elementIndex, fromIndex, toIndex);\n          ensureDropCleanup();\n        };\n\n        windows.forEach((windowHtml, windowIndex)=>{\n          const windowEl = document.createElement('section');\n          windowEl.className = 'column-window';\n          windowEl.draggable = true;\n          windowEl.dataset.windowIndex = String(windowIndex);\n\n          const header = document.createElement('div');\n          header.className = 'column-window-header';\n          const label = document.createElement('span');\n          label.className = 'label';\n          label.textContent = 'Column '+(windowIndex+1);\n          const size = document.createElement('span');\n          size.className = 'size';\n          header.appendChild(label);\n          header.appendChild(size);\n          windowEl.appendChild(header);\n\n          const body = document.createElement('div');\n          body.className = 'column-window-content';\n          body.contentEditable = 'true';\n          body.dataset.pageIndex = String(idx);\n          body.dataset.elementIndex = String(elementIndex);\n          body.dataset.windowIndex = String(windowIndex);\n          body.innerHTML = windowHtml;\n          body.addEventListener('input', ()=>{\n            el.windows[windowIndex] = body.innerHTML;\n            el.html = el.windows.join('');\n            markDirty();\n          });\n          body.addEventListener('focus', ()=>{ selectColumnsBlock(stack, idx, elementIndex); });\n          body.addEventListener('click', ()=>{ selectColumnsBlock(stack, idx, elementIndex); });\n          windowEl.appendChild(body);\n\n          const layout = el.windowLayout[windowIndex] || { width:null, height:null };\n          if(Number.isFinite(layout.width)){ windowEl.style.width = mmToPx(layout.width)+'px'; }\n          if(Number.isFinite(layout.height)){ windowEl.style.height = mmToPx(layout.height)+'px'; }\n\n          windowEl.addEventListener('dragstart', ev=>{\n            if(!ev.target.closest('.column-window-header')){\n              ev.preventDefault();\n              return;\n            }\n            columnDragState = { pageIndex:idx, elementIndex, windowIndex };\n            windowEl.classList.add('dragging');\n            ensureDropCleanup();\n            ev.dataTransfer.effectAllowed = 'move';\n            ev.dataTransfer.setData('text/plain', '');\n          });\n          windowEl.addEventListener('dragend', ()=>{\n            windowEl.classList.remove('dragging');\n            columnDragState = null;\n            ensureDropCleanup();\n          });\n          windowEl.addEventListener('dragover', ev=>{\n            if(!columnDragState || columnDragState.pageIndex !== idx || columnDragState.elementIndex !== elementIndex){ return; }\n            ev.preventDefault();\n            const indicator = targetWindowIndicator(windowEl);\n            const rect = windowEl.getBoundingClientRect();\n            const isAfter = (ev.clientX - rect.left) > rect.width/2;\n            indicator.style.left = isAfter ? 'auto' : '0';\n            indicator.style.right = isAfter ? '0' : 'auto';\n          });\n          windowEl.addEventListener('dragleave', ensureDropCleanup);\n          windowEl.addEventListener('drop', ev=>{\n            handleDragDrop(windowEl, ev);\n          });\n\n          updateSizeLabel(windowEl, size, windowIndex);\n          handleWindowResize(windowEl, size, windowIndex);\n\n          stack.appendChild(windowEl);\n        });\n\n        stack.addEventListener('dragover', ev=>{\n          if(!columnDragState || columnDragState.pageIndex !== idx || columnDragState.elementIndex !== elementIndex){ return; }\n          ev.preventDefault();\n        });\n        stack.addEventListener('drop', ev=>{\n          if(!columnDragState || columnDragState.pageIndex !== idx || columnDragState.elementIndex !== elementIndex){ return; }\n          ev.preventDefault();\n          handleColumnReorder(idx, elementIndex, columnDragState.windowIndex, el.windows.length);\n          ensureDropCleanup();\n        });\n\n        content.appendChild(stack);\n      } else {\n        const frame = createFrameElement(el, idx, elementIndex);\n        content.appendChild(frame);\n      }\n    });\n\n    const foot = document.createElement('footer');\n    foot.className = 'foot';\n    const left = document.createElement('span');\n    left.contentEditable = 'true';\n    left.textContent = resolveFooter(page.footerLeft, idx);\n    left.addEventListener('input', ()=>{ page.footerLeft = left.textContent; markDirty(); });\n    const right = document.createElement('span');\n    right.contentEditable = 'true';\n    right.textContent = resolveFooter(page.footerRight, idx);\n    right.addEventListener('input', ()=>{ page.footerRight = right.textContent; markDirty(); });\n    foot.appendChild(left);\n    foot.appendChild(right);\n    content.appendChild(foot);\n    return sheet;\n  }\n\n  function applyPageThemeClass(sheet, theme){\n    const safeTheme = normalizeTheme(theme);\n    PAGE_THEME_CLASSES.forEach(cls=>sheet.classList.remove(cls));\n    sheet.classList.add('theme-'+safeTheme);\n    sheet.dataset.theme = safeTheme;\n  }\n\n  function resolveFooter(template, idx){\n    const total = getTotalPages();\n    return (template || '').replace(/{{page}}/g, String(idx+1))\n      .replace(/{{total}}/g, String(total))\n      .replace(/{{version}}/g, docModel.version)\n      .replace(/{{codename}}/g, docModel.codename);\n  }\n\n  function createFrameElement(el, pageIndex, elementIndex){\n    const frame = document.createElement('figure');\n    frame.className = 'frame frame-'+el.frameType;\n    frame.dataset.pageIndex = String(pageIndex);\n    frame.dataset.elementIndex = String(elementIndex);\n    frame.tabIndex = 0;\n\n    const contentWrap = document.createElement('div');\n    if(el.frameType === 'text'){\n      contentWrap.className = 'frame-content';\n      contentWrap.contentEditable = 'true';\n      contentWrap.innerHTML = el.content;\n      contentWrap.addEventListener('input', ()=>{ el.content = contentWrap.innerHTML; markDirty(); });\n    } else {\n      contentWrap.className = 'frame-image';\n      if(el.src){\n        contentWrap.dataset.src = el.src;\n        contentWrap.style.backgroundImage = 'url(\"'+el.src.replace(/\"/g,'&quot;')+'\")';\n      } else {\n        contentWrap.textContent = 'Set an image URL from the inspector.';\n      }\n    }\n    frame.appendChild(contentWrap);\n\n    const cap = document.createElement('figcaption');\n    cap.contentEditable = 'true';\n    cap.textContent = el.caption || '';\n    cap.addEventListener('input', ()=>{ el.caption = cap.textContent; markDirty(); });\n    frame.appendChild(cap);\n\n    ['se','e','s'].forEach(dir=>{\n      const handle = document.createElement('div');\n      handle.className = 'resize-handle '+dir;\n      frame.appendChild(handle);\n    });\n\n    frame.addEventListener('click', ev=>{\n      ev.stopPropagation();\n      selectFrame(frame, pageIndex, elementIndex);\n    });\n\n    frame.addEventListener('pointerdown', ev=>{\n      if(el.mode !== 'overlay') return;\n      if(ev.target.classList.contains('resize-handle')) return;\n      ev.preventDefault();\n      frame.setPointerCapture(ev.pointerId);\n      const startX = ev.clientX;\n      const startY = ev.clientY;\n      const startLeft = el.x;\n      const startTop = el.y;\n      const move = mv=>{\n        const dxMm = pxToMm(mv.clientX - startX);\n        const dyMm = pxToMm(mv.clientY - startY);\n        el.x = Math.max(0, startLeft + dxMm);\n        el.y = Math.max(0, startTop + dyMm);\n        applyFrameMode(frame, el);\n        if(isSelectedFrame(frame)) updateInspectorFields(el);\n        markDirty();\n      };\n      const up = ()=>{\n        frame.releasePointerCapture(ev.pointerId);\n        frame.removeEventListener('pointermove', move);\n        frame.removeEventListener('pointerup', up);\n      };\n      frame.addEventListener('pointermove', move);\n      frame.addEventListener('pointerup', up, { once:true });\n    });\n\n    ['se','e','s'].forEach(dir=>{\n      frame.querySelector('.resize-handle.'+dir).addEventListener('pointerdown', ev=>{\n        if(el.mode !== 'overlay') return;\n        ev.preventDefault();\n        ev.stopPropagation();\n        frame.setPointerCapture(ev.pointerId);\n        const startX = ev.clientX;\n        const startY = ev.clientY;\n        const startW = el.width;\n        const startH = el.height;\n        const move = mv=>{\n          const dxMm = pxToMm(mv.clientX - startX);\n          const dyMm = pxToMm(mv.clientY - startY);\n          if(dir.includes('e')) el.width = Math.max(20, startW + dxMm);\n          if(dir.includes('s')) el.height = Math.max(20, startH + dyMm);\n          applyFrameMode(frame, el);\n          if(isSelectedFrame(frame)) updateInspectorFields(el);\n          markDirty();\n        };\n        const up = ()=>{\n          frame.releasePointerCapture(ev.pointerId);\n          frame.removeEventListener('pointermove', move);\n          frame.removeEventListener('pointerup', up);\n        };\n        frame.addEventListener('pointermove', move);\n        frame.addEventListener('pointerup', up);\n      });\n    });\n\n    applyFrameMode(frame, el);\n    el.style = applyElementStyleClass(frame, el.style, 'frame');\n    return frame;\n  }\n\n  function applyFrameMode(frame, el){\n    frame.classList.remove('mode-overlay','mode-float-left','mode-float-right','mode-block');\n    frame.classList.add('mode-'+el.mode);\n    frame.style.width = mmToPx(el.width)+'px';\n    frame.style.height = mmToPx(el.height)+'px';\n    if(el.mode === 'overlay'){\n      frame.style.position = 'absolute';\n      frame.style.left = mmToPx(el.x)+'px';\n      frame.style.top = mmToPx(el.y)+'px';\n      frame.style.float = 'none';\n      frame.style.margin = '0';\n    } else {\n      frame.style.position = 'relative';\n      frame.style.left = '';\n      frame.style.top = '';\n      if(el.mode === 'float-left'){\n        frame.style.float = 'left';\n        frame.style.margin = '0 4mm 3mm 0';\n      } else if(el.mode === 'float-right'){\n        frame.style.float = 'right';\n        frame.style.margin = '0 0 3mm 4mm';\n      } else {\n        frame.style.float = 'none';\n        frame.style.margin = '3mm auto';\n      }\n    }\n  }\n\n  function applyElementStyleClass(node, styleName, type){\n    const safeStyle = type === 'frame' ? normalizeStyleValue('frame', styleName) : normalizeStyleValue('columns', styleName);\n    const list = type === 'frame' ? FRAME_STYLE_CLASSES : COLUMN_STYLE_CLASSES;\n    list.forEach(cls=>node.classList.remove(cls));\n    if(safeStyle && safeStyle !== 'standard'){\n      node.classList.add('style-'+safeStyle);\n    }\n    return safeStyle;\n  }\n\n  function renderDocument(){\n    pagesEl.innerHTML = '';\n    docModel.pages.forEach((page, idx)=>{\n      const sheet = renderPage(page, idx);\n      pagesEl.appendChild(sheet);\n    });\n    pages = pagesEl ? Array.from(pagesEl.querySelectorAll('.sheet')) : Array.from(document.querySelectorAll('#pages .sheet'));\n    if(obs){ obs.disconnect(); }\n    obs = new IntersectionObserver(entries=>{\n      let topMost = null;\n      let topY = Infinity;\n      entries.forEach(entry=>{\n        if(entry.isIntersecting){\n          const rect = entry.target.getBoundingClientRect();\n          if(rect.top >= 0 && rect.top < topY){\n            topY = rect.top;\n            topMost = entry.target;\n          }\n        }\n      });\n      if(topMost){\n        const idx = pages.indexOf(topMost);\n        if(idx >= 0){\n          cur = idx;\n          updateNavigationState(true);\n        }\n      }\n    },{ root:null, rootMargin:'0px', threshold:[0.55] });\n    pages.forEach(p=>obs.observe(p));\n    refreshCounts();\n    renderReleaseCard();\n    applyColorPreset();\n    buildThumbnails();\n    restoreFrameSelection();\n    restoreColumnsSelection();\n    updatePageThemeControl();\n    refreshElementStyleControl();\n    applyZoom();\n    applyMobileState();\n    if(isPreviewOpen()){\n      previewShouldRefit = true;\n      renderPagePreview();\n    }\n  }\n\n  function handleColumnReorder(pageIndex, elementIndex, fromIndex, toIndex){\n    const page = docModel.pages[pageIndex];\n    if(!page) return;\n    const el = page.elements[elementIndex];\n    if(!el || el.type !== 'columns') return;\n    const windows = Array.isArray(el.windows) ? el.windows.slice() : [];\n    if(!windows.length) return;\n    const layout = Array.isArray(el.windowLayout) ? el.windowLayout.slice() : windows.map(()=>({ width:null, height:null }));\n    if(fromIndex < 0 || fromIndex >= windows.length) return;\n    let normalizedTo = Math.max(0, Math.min(toIndex, windows.length));\n    if(normalizedTo === fromIndex || normalizedTo === fromIndex+1) return;\n    const [moved] = windows.splice(fromIndex, 1);\n    const [layoutMoved] = layout.splice(fromIndex, 1);\n    if(normalizedTo > windows.length){ normalizedTo = windows.length; }\n    windows.splice(normalizedTo > fromIndex ? normalizedTo-1 : normalizedTo, 0, moved);\n    layout.splice(normalizedTo > fromIndex ? normalizedTo-1 : normalizedTo, 0, layoutMoved || { width:null, height:null });\n    el.windows = windows;\n    el.windowLayout = layout;\n    el.columns = windows.length;\n    el.html = windows.join('');\n    markDirty();\n    selectedColumnsPage = pageIndex;\n    selectedColumnsIndex = elementIndex;\n    renderDocument();\n    snapTo(pageIndex, true);\n  }\n\n  function buildTemplateGallery(){\n    if(!templateList) return;\n    templateList.innerHTML = '';\n    DOCUMENT_TEMPLATES.forEach(entry=>{\n      const option = document.createElement('button');\n      option.type = 'button';\n      option.className = 'template-option';\n      option.dataset.templateId = entry.id;\n      option.innerHTML = '<h3>'+entry.label+'</h3><p>'+entry.description+'</p>';\n      option.addEventListener('click', ()=>{\n        createDocumentFromTemplate(entry.id);\n      });\n      templateList.appendChild(option);\n    });\n  }\n\n  function openTemplateChooser(){\n    if(isDirty && !confirm('Discard current changes and create a new document?')) return;\n    buildTemplateGallery();\n    if(templateModal){\n      templateModal.classList.add('open');\n      try{\n        templateModal.focus({ preventScroll:true });\n      }catch(err){\n        templateModal.focus();\n      }\n    }\n  }\n\n  function closeTemplateChooser(){\n    if(templateModal){\n      templateModal.classList.remove('open');\n    }\n  }\n\n  function createDocumentFromTemplate(templateId){\n    const entry = TEMPLATE_MAP.get(templateId) || TEMPLATE_MAP.get(DEFAULT_TEMPLATE_ID);\n    if(!entry) return;\n    docModel = normalizeDocument(entry.create());\n    markDirty(false);\n    updateVersionInfo();\n    renderDocument();\n    snapTo(0, true);\n    closeTemplateChooser();\n    setStatus('Template loaded: '+entry.label+'.');\n  }\n\n  if(templateCancel){\n    templateCancel.addEventListener('click', closeTemplateChooser);\n  }\n  if(templateModal){\n    templateModal.addEventListener('click', ev=>{\n      if(ev.target === templateModal) closeTemplateChooser();\n    });\n  }\n\n  function clampZoom(value){\n    return Math.min(MAX_CANVAS_ZOOM, Math.max(MIN_CANVAS_ZOOM, value));\n  }\n\n  function applyZoom(){\n    if(!pageViewport) return;\n    pageViewport.style.transform = 'scale('+zoomLevel.toFixed(3)+')';\n    if(zoomDisplay){\n      zoomDisplay.textContent = Math.round(zoomLevel*100)+'%';\n    }\n    if(zoomOutBtn){\n      zoomOutBtn.disabled = zoomLevel <= MIN_CANVAS_ZOOM + 0.01;\n    }\n    if(zoomInBtn){\n      zoomInBtn.disabled = zoomLevel >= MAX_CANVAS_ZOOM - 0.01;\n    }\n    if(viewportZoomOutBtn){\n      viewportZoomOutBtn.disabled = zoomLevel <= MIN_CANVAS_ZOOM + 0.01;\n    }\n    if(viewportZoomInBtn){\n      viewportZoomInBtn.disabled = zoomLevel >= MAX_CANVAS_ZOOM - 0.01;\n    }\n    buildRulers();\n  }\n\n  function zoomTo(value){\n    const clamped = clampZoom(value);\n    if(Math.abs(clamped - zoomLevel) < 0.01) return;\n    zoomLevel = clamped;\n    applyZoom();\n  }\n\n  function zoomIn(){ zoomTo(zoomLevel + 0.1); }\n  function zoomOut(){ zoomTo(zoomLevel - 0.1); }\n  function zoomReset(){ zoomTo(1); }\n\n  function zoomFit(){\n    if(!pageViewport || !pages.length){\n      zoomTo(1);\n      return;\n    }\n    const sheet = pages[cur] || pages[0];\n    if(!sheet){ zoomTo(1); return; }\n    const widthPx = sheet.offsetWidth || sheet.getBoundingClientRect().width;\n    const heightPx = sheet.offsetHeight || sheet.getBoundingClientRect().height;\n    if(!widthPx || !heightPx){ zoomTo(1); return; }\n    const viewportRect = pageViewport.getBoundingClientRect();\n    const availableWidth = Math.max(120, window.innerWidth - viewportRect.left - 32);\n    const availableHeight = Math.max(120, window.innerHeight - viewportRect.top - 32);\n    const rawScale = Math.min(availableWidth / widthPx, availableHeight / heightPx);\n    zoomTo(rawScale);\n  }\n\n  function isMobileLayout(){\n    return window.innerWidth <= MOBILE_BREAKPOINT;\n  }\n\n  function syncMobileToggleState(){\n    if(mobileToggleTools){\n      const expanded = !document.body.classList.contains('mobile-ui-hidden');\n      mobileToggleTools.setAttribute('aria-expanded', expanded ? 'true' : 'false');\n    }\n    if(mobileTogglePages){\n      const expanded = !document.body.classList.contains('mobile-sidebar-hidden');\n      mobileTogglePages.setAttribute('aria-expanded', expanded ? 'true' : 'false');\n    }\n  }\n\n  function applyMobileState(){\n    if(isMobileLayout()){\n      document.body.classList.add('mobile-layout');\n      if(!document.body.classList.contains('mobile-layout-active')){\n        document.body.classList.add('mobile-layout-active');\n        document.body.classList.add('mobile-ui-hidden','mobile-sidebar-hidden');\n        if(!mobileAutoZoomed){\n          zoomFit();\n          mobileAutoZoomed = true;\n        }\n      }\n    } else {\n      document.body.classList.remove('mobile-layout','mobile-layout-active','mobile-ui-hidden','mobile-sidebar-hidden');\n      mobileAutoZoomed = false;\n    }\n    syncMobileToggleState();\n    buildRulers();\n  }\n\n  if(zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);\n  if(zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);\n  if(zoomResetBtn) zoomResetBtn.addEventListener('click', zoomReset);\n  if(zoomFullBtn) zoomFullBtn.addEventListener('click', zoomFit);\n  if(viewportZoomInBtn) viewportZoomInBtn.addEventListener('click', zoomIn);\n  if(viewportZoomOutBtn) viewportZoomOutBtn.addEventListener('click', zoomOut);\n\n  if(mobileToggleTools){\n    mobileToggleTools.addEventListener('click', ()=>{\n      if(!document.body.classList.contains('mobile-layout')) return;\n      document.body.classList.toggle('mobile-ui-hidden');\n      syncMobileToggleState();\n      if(!document.body.classList.contains('mobile-ui-hidden') && uiPanel){\n        try{\n          uiPanel.scrollIntoView({ behavior:'smooth', block:'start' });\n        } catch(err){\n          uiPanel.scrollIntoView();\n        }\n      }\n    });\n  }\n\n  if(mobileTogglePages){\n    mobileTogglePages.addEventListener('click', ()=>{\n      if(!document.body.classList.contains('mobile-layout')) return;\n      document.body.classList.toggle('mobile-sidebar-hidden');\n      syncMobileToggleState();\n      if(!document.body.classList.contains('mobile-sidebar-hidden') && sidebar){\n        try{\n          sidebar.scrollIntoView({ behavior:'smooth', block:'start' });\n        } catch(err){\n          sidebar.scrollIntoView();\n        }\n      }\n    });\n  }\n\n  function isPreviewOpen(){\n    return !!(pagePreviewModal && pagePreviewModal.classList.contains('open'));\n  }\n\n  function clampPreviewZoom(value){\n    return Math.min(3, Math.max(0.3, value));\n  }\n\n  function applyPreviewZoom(){\n    if(!pagePreviewSheet) return;\n    const sheet = pagePreviewSheet.querySelector('.sheet');\n    if(sheet){\n      sheet.style.transform = 'scale('+previewZoomLevel.toFixed(3)+')';\n    }\n    if(pagePreviewZoomDisplay){\n      pagePreviewZoomDisplay.textContent = Math.round(previewZoomLevel*100)+'%';\n    }\n    if(pagePreviewZoomRange){\n      const sliderValue = Math.round(previewZoomLevel*100);\n      const min = parseInt(pagePreviewZoomRange.min, 10) || 40;\n      const max = parseInt(pagePreviewZoomRange.max, 10) || 200;\n      const clamped = Math.max(min, Math.min(max, sliderValue));\n      pagePreviewZoomRange.value = String(clamped);\n    }\n  }\n\n  function computePreviewFit(sheet){\n    if(!sheet || !pagePreviewViewport) return clampPreviewZoom(1);\n    const sheetRect = sheet.getBoundingClientRect();\n    if(!sheetRect.width || !sheetRect.height) return clampPreviewZoom(1);\n    const viewportRect = pagePreviewViewport.getBoundingClientRect();\n    const availableWidth = Math.max(140, viewportRect.width - 40);\n    const availableHeight = Math.max(140, viewportRect.height - 40);\n    const rawScale = Math.min(availableWidth / sheetRect.width, availableHeight / sheetRect.height);\n    if(!Number.isFinite(rawScale) || rawScale <= 0) return clampPreviewZoom(1);\n    return clampPreviewZoom(rawScale);\n  }\n\n  function updatePreviewHeading(){\n    if(!pagePreviewHeading) return;\n    const total = getTotalPages();\n    const page = docModel.pages[previewPageIndex];\n    const suffix = page && page.title ? ' ‚Äî '+page.title : '';\n    pagePreviewHeading.innerHTML = '<strong>Page Preview</strong><span>Page '+(previewPageIndex+1)+' of '+total+suffix+'</span>';\n  }\n\n  function updatePreviewNavButtons(){\n    if(pagePreviewPrev){\n      pagePreviewPrev.disabled = (previewPageIndex <= 0);\n    }\n    if(pagePreviewNext){\n      pagePreviewNext.disabled = (previewPageIndex >= getTotalPages()-1);\n    }\n  }\n\n  function renderPagePreview(){\n    if(!isPreviewOpen() || !pagePreviewSheet) return;\n    const source = pages[previewPageIndex];\n    pagePreviewSheet.innerHTML = '';\n    if(!source){\n      const empty = document.createElement('div');\n      empty.style.color = '#fff';\n      empty.style.font = '14px var(--font-ui)';\n      empty.style.padding = '16px';\n      empty.textContent = 'No page available.';\n      pagePreviewSheet.appendChild(empty);\n      updatePreviewHeading();\n      updatePreviewNavButtons();\n      return;\n    }\n    const clone = source.cloneNode(true);\n    clone.style.transform = '';\n    clone.style.transformOrigin = 'top center';\n    pagePreviewSheet.appendChild(clone);\n    if(previewShouldRefit){\n      previewZoomLevel = computePreviewFit(clone);\n      previewShouldRefit = false;\n    }\n    applyPreviewZoom();\n    updatePreviewHeading();\n    updatePreviewNavButtons();\n  }\n\n  function openPagePreview(index){\n    if(!pagePreviewModal) return;\n    const total = getTotalPages();\n    const target = Number.isFinite(index) ? index : cur;\n    previewPageIndex = Math.max(0, Math.min(total-1, target));\n    previewShouldRefit = true;\n    pagePreviewModal.classList.add('open');\n    pagePreviewModal.setAttribute('aria-hidden', 'false');\n    document.body.classList.add('preview-open');\n    renderPagePreview();\n    setTimeout(()=>{ try{ pagePreviewModal.focus({ preventScroll:true }); } catch(err){ pagePreviewModal.focus(); } }, 0);\n  }\n\n  function closePagePreview(){\n    if(!pagePreviewModal) return;\n    pagePreviewModal.classList.remove('open');\n    pagePreviewModal.setAttribute('aria-hidden', 'true');\n    document.body.classList.remove('preview-open');\n  }\n\n  function goToPreviewPage(index, resetZoom = false){\n    const total = getTotalPages();\n    const target = Math.max(0, Math.min(total-1, index));\n    previewShouldRefit = resetZoom;\n    if(target !== previewPageIndex){\n      previewSyncFromSnap = true;\n      previewPageIndex = target;\n      snapTo(target, false);\n      previewSyncFromSnap = false;\n    } else {\n      renderPagePreview();\n    }\n  }\n\n  function previewZoomTo(value){\n    previewZoomLevel = clampPreviewZoom(value);\n    applyPreviewZoom();\n  }\n\n  function previewZoomBy(step){\n    previewZoomTo(previewZoomLevel + step);\n  }\n\n  function previewZoomFit(){\n    previewShouldRefit = true;\n    renderPagePreview();\n  }\n\n  function handlePreviewWheelZoom(ev){\n    if(!(ev.ctrlKey || ev.metaKey)) return;\n    ev.preventDefault();\n    const delta = ev.deltaY;\n    if(!Number.isFinite(delta) || delta === 0) return;\n    previewZoomBy(delta < 0 ? 0.1 : -0.1);\n  }\n\n  function handleWheelZoom(ev){\n    if(!(ev.ctrlKey || ev.metaKey)) return;\n    ev.preventDefault();\n    const delta = ev.deltaY;\n    if(!Number.isFinite(delta) || delta === 0) return;\n    const step = delta < 0 ? 0.1 : -0.1;\n    zoomTo(zoomLevel + step);\n  }\n\n  if(pageViewport){\n    pageViewport.addEventListener('wheel', handleWheelZoom, { passive:false });\n  }\n\n  if(openPreviewBtn){\n    openPreviewBtn.addEventListener('click', ()=>openPagePreview(cur));\n  }\n  if(pagePreviewModal){\n    pagePreviewModal.addEventListener('click', ev=>{\n      if(ev.target === pagePreviewModal) closePagePreview();\n    });\n  }\n  if(pagePreviewClose){\n    pagePreviewClose.addEventListener('click', closePagePreview);\n  }\n  if(pagePreviewZoomRange){\n    pagePreviewZoomRange.addEventListener('input', ()=>{\n      const value = parseInt(pagePreviewZoomRange.value, 10) || 100;\n      previewZoomTo(value / 100);\n    });\n  }\n  if(pagePreviewZoomIn){\n    pagePreviewZoomIn.addEventListener('click', ()=>previewZoomBy(0.1));\n  }\n  if(pagePreviewZoomOutBtn){\n    pagePreviewZoomOutBtn.addEventListener('click', ()=>previewZoomBy(-0.1));\n  }\n  if(pagePreviewZoomFit){\n    pagePreviewZoomFit.addEventListener('click', previewZoomFit);\n  }\n  if(pagePreviewPrev){\n    pagePreviewPrev.addEventListener('click', ()=>goToPreviewPage(previewPageIndex-1));\n  }\n  if(pagePreviewNext){\n    pagePreviewNext.addEventListener('click', ()=>goToPreviewPage(previewPageIndex+1));\n  }\n  if(pagePreviewViewport){\n    pagePreviewViewport.addEventListener('wheel', handlePreviewWheelZoom, { passive:false });\n  }\n  if(pagesEl){\n    pagesEl.addEventListener('dblclick', ev=>{\n      if(ev.target.closest('[contenteditable=\"true\"]')) return;\n      const sheet = ev.target.closest('.sheet');\n      if(!sheet) return;\n      const idx = pages.indexOf(sheet);\n      if(idx >= 0){\n        openPagePreview(idx);\n      }\n    });\n  }\n\n  function refreshCounts(){\n    const total = getTotalPages();\n    totEl.textContent = String(total);\n    gotoEl.max = total;\n    if(total === 0){\n      cur = 0;\n      curEl.textContent = '0';\n      gotoEl.value = '0';\n      updateNavigationButtons();\n      return;\n    }\n    cur = Math.min(cur, total-1);\n    curEl.textContent = String(cur+1);\n    gotoEl.value = String(cur+1);\n    updateNavigationButtons();\n  }\n\n  function updateNavigationButtons(){\n    const total = getTotalPages();\n    prevBtn.disabled = (cur === 0);\n    firstBtn.disabled = (cur === 0);\n    nextBtn.disabled = (cur >= total-1);\n    lastBtn.disabled = (cur >= total-1);\n  }\n\n  function scrollPageIntoView(target, behavior){\n    if(!target) return;\n    const style = getComputedStyle(target);\n    const marginTop = parseFloat(style.scrollMarginTop) || 0;\n    const y = target.getBoundingClientRect().top + window.scrollY - marginTop;\n    window.scrollTo({ top: Math.max(0, y), left: 0, behavior });\n  }\n\n  function updateNavigationState(skipScroll){\n    const total = getTotalPages();\n    cur = Math.max(0, Math.min(total-1, cur));\n    curEl.textContent = String(cur+1);\n    gotoEl.value = String(cur+1);\n    updateNavigationButtons();\n    setActiveThumb();\n    updatePageThemeControl();\n    refreshElementStyleControl();\n    buildRulers();\n    if(!skipScroll){\n      scrollPageIntoView(pages[cur], 'smooth');\n    }\n  }\n\n  function snapTo(idx, instant = false){\n    const total = getTotalPages();\n    cur = Math.max(0, Math.min(total-1, idx));\n    const target = pages[cur];\n    if(target){\n      scrollPageIntoView(target, instant ? 'auto' : 'smooth');\n    }\n    updateNavigationState(true);\n    if(isPreviewOpen()){\n      if(!previewSyncFromSnap){\n        previewPageIndex = cur;\n      }\n      renderPagePreview();\n    }\n  }\n\n  function buildThumbnails(){\n    thumbsEl.innerHTML = '';\n    if(!pages.length) return;\n    const rect = pages[0].getBoundingClientRect();\n    const baseW = rect.width || pages[0].offsetWidth || 1000;\n    const baseH = rect.height || pages[0].offsetHeight || 1400;\n    pages.forEach((page, idx)=>{\n      const wrap = document.createElement('div');\n      wrap.className = 'thumb';\n      wrap.dataset.index = String(idx);\n      const mini = document.createElement('div');\n      mini.className = 'mini-wrap';\n      const clone = page.cloneNode(true);\n      clone.style.pointerEvents = 'none';\n      mini.appendChild(clone);\n      wrap.appendChild(mini);\n      const meta = document.createElement('div');\n      meta.className = 'mini-meta';\n      meta.textContent = 'Page '+(idx+1);\n      wrap.appendChild(meta);\n      wrap.addEventListener('click', ()=>{ snapTo(idx, false); });\n      thumbsEl.appendChild(wrap);\n      const availW = mini.clientWidth;\n      let scale = availW / baseW;\n      if(!isFinite(scale) || scale <= 0){ scale = 0.2; }\n      clone.style.transformOrigin = 'top left';\n      clone.style.transform = 'scale('+scale.toFixed(4)+')';\n      mini.style.height = (baseH*scale)+'px';\n    });\n    setActiveThumb();\n    applyColorPreset();\n  }\n\n  function setActiveThumb(){\n    document.querySelectorAll('#thumbs .thumb.active').forEach(el=>el.classList.remove('active'));\n    const active = thumbsEl.querySelector('.thumb[data-index=\"'+cur+'\"]');\n    if(active) active.classList.add('active');\n  }\n\n  function applyToggles(){\n    document.body.classList.toggle('hide-guides', !chkGuides.checked);\n    document.body.classList.toggle('hide-crops', !chkCrops.checked);\n    document.body.classList.toggle('hide-colorbar', !chkColor.checked);\n    document.body.classList.toggle('hide-reg', !chkReg.checked);\n    document.body.classList.toggle('hide-safe', !chkSafe.checked);\n    document.body.classList.toggle('printshop', chkShop.checked);\n  }\n  [chkGuides, chkCrops, chkColor, chkReg, chkSafe, chkShop].forEach(el=>el.addEventListener('change', applyToggles));\n  applyToggles();\n\n  function applyColorPreset(){\n    const preset = selColorPreset.value;\n    const bars = document.querySelectorAll('.marks .colorbar');\n    bars.forEach(bar=>{\n      bar.innerHTML = '';\n      let patches = [];\n      if(preset === 'ugra'){\n        patches = ['c','m','y','k'];\n        for(let i=0;i<=20;i++){\n          const val = Math.round((i/20)*90);\n          patches.push('g'+(val || '90'));\n        }\n      } else {\n        patches = ['c','m','y','k','r','g','b','w','g10','g20','g30','g40','g50','g60','g70','g80','g90'];\n      }\n      patches.forEach(p=>{\n        const d = document.createElement('div');\n        d.className = 'patch '+p;\n        bar.appendChild(d);\n      });\n    });\n  }\n  selColorPreset.addEventListener('change', applyColorPreset);\n\n  function buildRulers(){\n    if(document.body.classList.contains('mobile-layout')){\n      rulerTopEl.style.display = 'none';\n      rulerLeftEl.style.display = 'none';\n      return;\n    }\n    if(!pages.length){\n      rulerTopEl.style.display = 'none';\n      rulerLeftEl.style.display = 'none';\n      return;\n    }\n    const sheet = pages[cur] || pages[0];\n    const rect = sheet.getBoundingClientRect();\n    const baseWidthPx = sheet.offsetWidth || rect.width;\n    const baseHeightPx = sheet.offsetHeight || rect.height;\n    const zoom = zoomLevel || 1;\n    const widthPx = baseWidthPx * zoom;\n    const heightPx = baseHeightPx * zoom;\n    const widthMm = pxToMm(baseWidthPx);\n    const heightMm = pxToMm(baseHeightPx);\n    const cmTopCount = Math.ceil(widthMm / 10);\n    const inTopCount = Math.ceil(widthMm / 25.4);\n    const cmLeftCount = Math.ceil(heightMm / 10);\n    const inLeftCount = Math.ceil(heightMm / 25.4);\n    rulerTopCm.innerHTML = '';\n    rulerTopIn.innerHTML = '';\n    rulerLeftCm.innerHTML = '';\n    rulerLeftIn.innerHTML = '';\n    rulerTopEl.style.display = 'block';\n    rulerLeftEl.style.display = 'block';\n    rulerTopEl.style.width = Math.round(widthPx)+'px';\n    rulerTopEl.style.left = Math.max(0, Math.round(rect.left))+'px';\n    const verticalWidth = rulerLeftEl.offsetWidth || 36;\n    rulerLeftEl.style.left = Math.max(0, Math.round(rect.left - verticalWidth))+'px';\n    rulerLeftEl.style.height = Math.round(heightPx + 40*(zoomLevel || 1))+'px';\n    for(let i=0;i<=cmTopCount;i++){\n      const span = document.createElement('span');\n      span.textContent = i;\n      span.style.left = (mmToPx(i*10)*zoom)+'px';\n      rulerTopCm.appendChild(span);\n    }\n    for(let i=0;i<=inTopCount;i++){\n      const span = document.createElement('span');\n      span.textContent = i+'\"';\n      span.style.left = (mmToPx(i*25.4)*zoom)+'px';\n      rulerTopIn.appendChild(span);\n    }\n    for(let i=0;i<=cmLeftCount;i++){\n      const span = document.createElement('span');\n      span.textContent = i;\n      span.style.top = (mmToPx(i*10)*zoom)+'px';\n      rulerLeftCm.appendChild(span);\n    }\n    for(let i=0;i<=inLeftCount;i++){\n      const span = document.createElement('span');\n      span.textContent = i+'\"';\n      span.style.top = (mmToPx(i*25.4)*zoom)+'px';\n      rulerLeftIn.appendChild(span);\n    }\n  }\n\n  function selectFrame(frameEl, pageIndex, elementIndex){\n    pageCanvasRoot.querySelectorAll('.frame.selected').forEach(el=>el.classList.remove('selected'));\n    frameEl.classList.add('selected');\n    selectedFrame = frameEl;\n    selectedFramePage = pageIndex;\n    selectedFrameIndex = elementIndex;\n    frameInspector.classList.add('active');\n    updateInspectorFields(docModel.pages[pageIndex].elements[elementIndex]);\n    clearColumnsSelection(true);\n    setStyledSelection('frame', pageIndex, elementIndex);\n  }\n\n  function restoreFrameSelection(){\n    if(selectedFramePage < 0 || selectedFrameIndex < 0) return;\n    const selector = '.frame[data-page-index=\"'+selectedFramePage+'\"][data-element-index=\"'+selectedFrameIndex+'\"]';\n    const frame = pageCanvasRoot.querySelector(selector);\n    if(frame){\n      selectFrame(frame, selectedFramePage, selectedFrameIndex);\n    } else {\n      clearFrameSelection();\n    }\n  }\n\n  function isSelectedFrame(frameEl){\n    return selectedFrame && frameEl === selectedFrame;\n  }\n\n  function updateInspectorFields(el){\n    if(el.mode === 'overlay'){\n      framePosX.disabled = false;\n      framePosY.disabled = false;\n      framePosX.value = el.x.toFixed(1);\n      framePosY.value = el.y.toFixed(1);\n    } else {\n      framePosX.disabled = true;\n      framePosY.disabled = true;\n      framePosX.value = '‚Äî';\n      framePosY.value = '‚Äî';\n    }\n    frameWidth.value = el.width.toFixed(1);\n    frameHeight.value = el.height.toFixed(1);\n    frameWrap.value = el.mode;\n    frameCaption.value = el.caption || '';\n    if(el.frameType === 'image'){\n      frameImageUrlLabel.style.display = '';\n      frameImageUrl.value = el.src || '';\n    } else {\n      frameImageUrlLabel.style.display = 'none';\n      frameImageUrl.value = '';\n    }\n  }\n\n  function clearFrameSelection(silent = false){\n    pageCanvasRoot.querySelectorAll('.frame.selected').forEach(el=>el.classList.remove('selected'));\n    selectedFrame = null;\n    selectedFrameIndex = -1;\n    selectedFramePage = -1;\n    frameInspector.classList.remove('active');\n    if(!silent && styledSelection.type === 'frame'){\n      clearStyleControl();\n    }\n  }\n\n  document.addEventListener('click', ev=>{\n    if(!ev.target.closest('.frame') && !ev.target.closest('#frameInspector')){\n      clearFrameSelection();\n    }\n    if(!ev.target.closest('.column-window-stack') && !ev.target.closest('#styleControls')){\n      clearColumnsSelection();\n    }\n  });\n\n  function selectColumnsBlock(block, pageIndex, elementIndex){\n    if(selectedColumnsBlock && selectedColumnsBlock !== block){\n      selectedColumnsBlock.classList.remove('selected');\n    }\n    selectedColumnsBlock = block;\n    selectedColumnsPage = pageIndex;\n    selectedColumnsIndex = elementIndex;\n    block.classList.add('selected');\n    clearFrameSelection(true);\n    setStyledSelection('columns', pageIndex, elementIndex);\n  }\n\n  function clearColumnsSelection(skipStyle = false){\n    if(selectedColumnsBlock){\n      selectedColumnsBlock.classList.remove('selected');\n    }\n    selectedColumnsBlock = null;\n    selectedColumnsPage = -1;\n    selectedColumnsIndex = -1;\n    if(!skipStyle && styledSelection.type === 'columns'){\n      clearStyleControl();\n    }\n  }\n\n  function restoreColumnsSelection(){\n    if(selectedColumnsPage < 0 || selectedColumnsIndex < 0) return;\n    const selector = '.column-window-stack[data-page-index=\"'+selectedColumnsPage+'\"][data-element-index=\"'+selectedColumnsIndex+'\"]';\n    const block = pageCanvasRoot.querySelector(selector);\n    if(block){\n      selectedColumnsBlock = block;\n      block.classList.add('selected');\n      setStyledSelection('columns', selectedColumnsPage, selectedColumnsIndex);\n    } else {\n      clearColumnsSelection();\n    }\n  }\n\n  function populateElementStyleOptions(type, currentValue){\n    if(!elementStyleSelect) return;\n    const options = ELEMENT_STYLE_OPTIONS[type] || ELEMENT_STYLE_OPTIONS.columns;\n    if(currentStyleOptionType !== type){\n      elementStyleSelect.innerHTML = '';\n      options.forEach(opt=>{\n        const option = document.createElement('option');\n        option.value = opt.value;\n        option.textContent = opt.label;\n        elementStyleSelect.appendChild(option);\n      });\n      currentStyleOptionType = type;\n    }\n    const hasValue = options.some(opt=>opt.value === currentValue);\n    elementStyleSelect.value = hasValue ? currentValue : options[0].value;\n  }\n\n  function setStyledSelection(type, pageIndex, elementIndex){\n    const page = docModel.pages[pageIndex];\n    if(!page){\n      clearStyleControl();\n      return;\n    }\n    const element = page.elements[elementIndex];\n    if(!element){\n      clearStyleControl();\n      return;\n    }\n    const normalized = type === 'frame' ? normalizeStyleValue('frame', element.style) : normalizeStyleValue('columns', element.style);\n    element.style = normalized;\n    styledSelection = { type, pageIndex, elementIndex };\n    populateElementStyleOptions(type, normalized);\n    elementStyleSelect.disabled = false;\n    elementStyleSelect.value = normalized;\n  }\n\n  function clearStyleControl(){\n    styledSelection = { type:null, pageIndex:-1, elementIndex:-1 };\n    if(elementStyleSelect){\n      elementStyleSelect.innerHTML = '<option value=\"standard\">Standard</option>';\n      elementStyleSelect.value = 'standard';\n      elementStyleSelect.disabled = true;\n    }\n    currentStyleOptionType = null;\n  }\n\n  function refreshElementStyleControl(){\n    if(!elementStyleSelect) return;\n    if(!styledSelection.type){\n      clearStyleControl();\n      return;\n    }\n    if(styledSelection.pageIndex !== cur){\n      if(styledSelection.type === 'columns'){\n        clearColumnsSelection();\n      } else {\n        clearStyleControl();\n      }\n      return;\n    }\n    const page = docModel.pages[styledSelection.pageIndex];\n    if(!page){\n      clearStyleControl();\n      return;\n    }\n    const element = page.elements[styledSelection.elementIndex];\n    if(!element){\n      if(styledSelection.type === 'columns'){\n        clearColumnsSelection();\n      } else {\n        clearStyleControl();\n      }\n      return;\n    }\n    const normalized = styledSelection.type === 'frame' ? normalizeStyleValue('frame', element.style) : normalizeStyleValue('columns', element.style);\n    element.style = normalized;\n    populateElementStyleOptions(styledSelection.type, normalized);\n    elementStyleSelect.disabled = false;\n    elementStyleSelect.value = normalized;\n  }\n\n  function updatePageThemeControl(){\n    if(!pageThemeSelect) return;\n    const page = docModel.pages[cur];\n    if(!page){\n      pageThemeSelect.value = 'standard';\n      pageThemeSelect.disabled = true;\n      return;\n    }\n    const theme = normalizeTheme(page.theme);\n    page.theme = theme;\n    pageThemeSelect.disabled = false;\n    pageThemeSelect.value = theme;\n  }\n\n  framePosX.addEventListener('input', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    if(el.mode !== 'overlay') return;\n    el.x = parseFloat(framePosX.value) || 0;\n    applyFrameMode(selectedFrame, el);\n    markDirty();\n  });\n  framePosY.addEventListener('input', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    if(el.mode !== 'overlay') return;\n    el.y = parseFloat(framePosY.value) || 0;\n    applyFrameMode(selectedFrame, el);\n    markDirty();\n  });\n  frameWidth.addEventListener('input', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    el.width = Math.max(20, parseFloat(frameWidth.value) || el.width);\n    applyFrameMode(selectedFrame, el);\n    markDirty();\n  });\n  frameHeight.addEventListener('input', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    el.height = Math.max(20, parseFloat(frameHeight.value) || el.height);\n    applyFrameMode(selectedFrame, el);\n    markDirty();\n  });\n  frameWrap.addEventListener('change', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    el.mode = frameWrap.value;\n    applyFrameMode(selectedFrame, el);\n    updateInspectorFields(el);\n    markDirty();\n  });\n  frameCaption.addEventListener('input', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    el.caption = frameCaption.value;\n    const cap = selectedFrame.querySelector('figcaption');\n    if(cap) cap.textContent = el.caption;\n    markDirty();\n  });\n  frameImageUrl.addEventListener('change', ()=>{\n    if(!selectedFrame) return;\n    const el = docModel.pages[selectedFramePage].elements[selectedFrameIndex];\n    if(el.frameType !== 'image') return;\n    el.src = frameImageUrl.value.trim();\n    const wrap = selectedFrame.querySelector('.frame-image');\n    if(wrap){\n      if(el.src){\n        wrap.dataset.src = el.src;\n        wrap.style.backgroundImage = 'url(\"'+el.src.replace(/\"/g,'&quot;')+'\")';\n        wrap.textContent = '';\n      } else {\n        wrap.removeAttribute('data-src');\n        wrap.style.backgroundImage = '';\n        wrap.textContent = 'Set an image URL from the inspector.';\n      }\n    }\n    markDirty();\n  });\n\n  function addColumnsToCurrent(count){\n    const page = docModel.pages[cur];\n    if(!page) return;\n    const windows = Array.from({ length:count }, (_, idx)=> idx === 0 ? '<p>Type your story here.</p>' : '<p>Start typing‚Ä¶</p>');\n    page.elements.push(createColumnElement(count, windows));\n    markDirty();\n    renderDocument();\n    snapTo(cur, true);\n  }\n\n  function addFrameToCurrent(type){\n    const page = docModel.pages[cur];\n    if(!page) return;\n    const frame = {\n      type:'frame',\n      frameType:type,\n      mode:'overlay',\n      x:30,\n      y:40,\n      width:60,\n      height:40,\n      content: type === 'text' ? '<p>Double-click to edit frame text.</p>' : '',\n      src:'',\n      caption:'',\n      style:'standard'\n    };\n    page.elements.push(frame);\n    selectedFramePage = cur;\n    selectedFrameIndex = page.elements.length-1;\n    selectedFrame = null;\n    markDirty();\n    renderDocument();\n    snapTo(cur, true);\n  }\n\n  function addPage(afterIndex){\n    const inheritTheme = docModel.pages[afterIndex] ? docModel.pages[afterIndex].theme : 'standard';\n    const base = { title:'Untitled Spread', subtitle:'', deck:'', theme:inheritTheme, elements:[createColumnElement(1, ['<p>Start typing‚Ä¶</p>'])], footerLeft:'Docu Monster Studio Pro ‚Ä¢ Orbit OS', footerRight:'Page {{page}} / {{total}}' };\n    docModel.pages.splice(afterIndex+1, 0, base);\n    markDirty();\n    renderDocument();\n    snapTo(afterIndex+1, true);\n  }\n\n  function duplicateCurrentPage(){\n    const page = docModel.pages[cur];\n    if(!page) return;\n    const clone = JSON.parse(JSON.stringify(page));\n    docModel.pages.splice(cur+1, 0, clone);\n    markDirty();\n    renderDocument();\n    snapTo(cur+1, true);\n  }\n\n  function newDocument(){\n    openTemplateChooser();\n  }\n\n  function getFileExtension(name){\n    if(typeof name !== 'string') return '';\n    const idx = name.lastIndexOf('.');\n    return idx >= 0 ? name.slice(idx).toLowerCase() : '';\n  }\n\n  function suggestDownloadName(){\n    const base = (docModel && (docModel.codename || docModel.docName)) || 'documonster';\n    const slug = base.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'documonster';\n    const timestamp = new Date().toISOString().replace(/[:T]/g,'-').split('.')[0];\n    return `${slug}-${timestamp}`;\n  }\n\n  function applyLoadedDocument(data, meta = {}){\n    let normalized;\n    try{\n      normalized = normalizeDocument(data);\n    }catch(err){\n      console.error('Invalid document payload', err);\n      setStatus('Failed to load document: '+err.message, false);\n      return false;\n    }\n    docModel = normalized;\n    markDirty(false);\n    updateVersionInfo();\n    renderDocument();\n    snapTo(0, true);\n    if(meta.persistToStorage){\n      try{\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(docModel));\n      }catch(err){\n        console.warn('Autosave write failed', err);\n      }\n    }\n    const statusMessage = meta.status || (meta.source ? meta.source+' document loaded.' : 'Document loaded.');\n    const transient = meta.hasOwnProperty('transient') ? !!meta.transient : false;\n    setStatus(statusMessage, transient);\n    if(window.parent && window.parent !== window){\n      window.parent.postMessage({ type:'documonster:document-loaded', payload:{ source: meta.source || 'external', name: meta.name || '', pageCount: getTotalPages() } }, '*');\n    }\n    return true;\n  }\n\n  function handleExternalDocumentLoad(payload){\n    if(!payload || typeof payload !== 'object') return;\n    const meta = Object.assign({ source:'External', transient:false }, payload.meta || {});\n    if(payload.meta && Object.prototype.hasOwnProperty.call(payload.meta, 'persistToStorage')){\n      meta.persistToStorage = !!payload.meta.persistToStorage;\n    }\n    meta.name = meta.name || (payload.meta && payload.meta.name) || '';\n    meta.status = meta.status || meta.note || (meta.source ? `Received document from ${meta.source}.` : 'Document received.');\n    applyLoadedDocument(payload.document, meta);\n  }\n\n  function openDocumentFile(){\n    openFileInput.value = '';\n    openFileInput.click();\n  }\n\n  openFileInput.addEventListener('change', ()=>{\n    const file = openFileInput.files && openFileInput.files[0];\n    if(!file) return;\n    const ext = getFileExtension(file.name);\n    if(ext && !ACCEPTED_EXTENSIONS.includes(ext)){\n      setStatus('Unsupported file type. Please choose a .dx document.', false);\n      return;\n    }\n    const reader = new FileReader();\n    reader.onload = ()=>{\n      let data;\n      try{\n        data = JSON.parse(reader.result);\n      }catch(err){\n        console.error('Failed to parse document', err);\n        setStatus('Invalid document file: '+err.message, false);\n        return;\n      }\n      applyLoadedDocument(data, { source:'File', name:file.name, status:'Loaded '+file.name, transient:false });\n    };\n    reader.readAsText(file);\n  });\n\n  window.addEventListener('message', event=>{\n    const data = event.data;\n    if(!data || typeof data !== 'object') return;\n    if(data.type === 'documonster:load-document'){\n      handleExternalDocumentLoad(data.payload || {});\n    }\n  });\n\n  function notifyParentReady(){\n    if(window.parent && window.parent !== window){\n      window.parent.postMessage({ type:'documonster:ready' }, '*');\n    }\n  }\n\n  function loadAutosave(){\n    const saved = loadFromStorage();\n    if(!saved){\n      setStatus('No autosave found.', true);\n      return;\n    }\n    docModel = normalizeDocument(saved);\n    markDirty(false);\n    updateVersionInfo();\n    renderDocument();\n    snapTo(0, true);\n    setStatus('Autosave restored.');\n  }\n\n  function saveAsDocument(){\n    const blob = new Blob([JSON.stringify(docModel, null, 2)], { type:DX_MIME });\n    const a = document.createElement('a');\n    a.href = URL.createObjectURL(blob);\n    a.download = `${suggestDownloadName()}${DX_EXTENSION}`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(a.href);\n    markDirty(false);\n    setStatus('DX file downloaded.');\n  }\n\n  function openMenu(id, anchor){\n    closeMenus();\n    const panel = document.querySelector('.menu-dropdown[data-panel=\"'+id+'\"]');\n    if(!panel) return;\n    const rect = anchor.getBoundingClientRect();\n    panel.style.left = rect.left+'px';\n    panel.style.top = (rect.bottom)+'px';\n    panel.classList.add('open');\n    anchor.classList.add('open');\n    menuOpen = { id, anchor, panel };\n  }\n\n  function closeMenus(){\n    document.querySelectorAll('.menu-dropdown.open').forEach(el=>el.classList.remove('open'));\n    document.querySelectorAll('.menu-root.open').forEach(el=>el.classList.remove('open'));\n    menuOpen = null;\n  }\n\n  menubar.addEventListener('click', ev=>{\n    const root = ev.target.closest('.menu-root');\n    if(root){\n      const id = root.dataset.menu;\n      if(menuOpen && menuOpen.id === id){\n        closeMenus();\n      } else {\n        openMenu(id, root);\n      }\n    }\n    const action = ev.target.closest('.menu-dropdown button');\n    if(action){\n      handleMenuAction(action.dataset.action);\n      closeMenus();\n    }\n  });\n\n  document.addEventListener('keydown', ev=>{\n    if(ev.key === 'Escape'){\n      if(isPreviewOpen()){\n        closePagePreview();\n        return;\n      }\n      if(templateModal && templateModal.classList.contains('open')){\n        closeTemplateChooser();\n      } else {\n        closeMenus();\n      }\n    }\n  });\n\n  document.addEventListener('click', ev=>{\n    if(!ev.target.closest('#menubar')) closeMenus();\n  });\n\n  function handleMenuAction(action){\n    switch(action){\n      case 'new-doc': return newDocument();\n      case 'open-doc': return openDocumentFile();\n      case 'save-doc': return saveToStorage();\n      case 'save-as-doc': return saveAsDocument();\n      case 'load-autosave': return loadAutosave();\n      case 'export-bleed': return exportPdfBleed();\n      case 'export-trim': return exportPdfTrim();\n      case 'toggle-mirror': chkMirror.checked = !chkMirror.checked; return;\n      case 'toggle-printshop': chkShop.checked = !chkShop.checked; applyToggles(); return;\n      case 'add-col-1': return addColumnsToCurrent(1);\n      case 'add-col-2': return addColumnsToCurrent(2);\n      case 'add-col-3': return addColumnsToCurrent(3);\n      case 'add-text-frame': return addFrameToCurrent('text');\n      case 'add-image-frame': return addFrameToCurrent('image');\n      case 'new-page': return addPage(cur);\n      case 'duplicate-page': return duplicateCurrentPage();\n      case 'toggle-guides': chkGuides.checked = !chkGuides.checked; applyToggles(); return;\n      case 'toggle-crops': chkCrops.checked = !chkCrops.checked; applyToggles(); return;\n      case 'toggle-colorbar': chkColor.checked = !chkColor.checked; applyToggles(); return;\n      default: return;\n    }\n  }\n\n  function injectPrintStyle(css){\n    let t = document.getElementById('print-style');\n    if(t) t.remove();\n    t = document.createElement('style');\n    t.id = 'print-style';\n    t.type = 'text/css';\n    t.appendChild(document.createTextNode(css));\n    document.head.appendChild(t);\n  }\n\n  function prePrintCommon(){\n    applyToggles();\n    document.body.classList.toggle('pdf-mirror', !!chkMirror.checked);\n    document.body.classList.add('print-export');\n    thumbsEl.innerHTML = '';\n    window.scrollTo({ top:0, behavior:'auto' });\n  }\n\n  function postPrint(){\n    const t = document.getElementById('print-style');\n    if(t) t.remove();\n    document.body.classList.remove('print-export');\n    document.body.classList.remove('pdf-mirror');\n    applyToggles();\n    buildThumbnails();\n  }\n\n  function runPrintRestore(callback){\n    let finished = false;\n    const finalize = ()=>{\n      if(finished) return;\n      finished = true;\n      window.removeEventListener('afterprint', handleAfterPrint);\n      callback();\n    };\n    const handleAfterPrint = ()=>{\n      clearTimeout(fallbackTimer);\n      finalize();\n    };\n    const fallbackTimer = setTimeout(finalize, 1500);\n    window.addEventListener('afterprint', handleAfterPrint);\n    return finalize;\n  }\n\n  function exportPdfBleed(){\n    prePrintCommon();\n    injectPrintStyle('@page{size:216mm 303mm;margin:0} html,body{width:216mm;height:303mm;margin:0;padding:0} #menubar,#ui,#sidebar,#rulerTop,#rulerLeft,#viewportZoomControls{display:none!important;} #pageViewport{margin:0!important;padding:0!important;transform:none!important;position:static!important;} #pages{margin:0!important;padding:0!important;transform:none!important;} .sheet{left:0;top:0;width:216mm!important;height:303mm!important;margin:0!important;position:relative!important;box-shadow:none!important;border:none!important;} .trim{left:3mm!important;top:3mm!important;width:210mm!important;height:297mm!important} :root{--m-top:12mm;--m-bot:12mm;--m-in:12mm;--m-out:12mm}');\n    const restore = runPrintRestore(postPrint);\n    setTimeout(()=>window.print(), 120);\n  }\n\n  function exportPdfTrim(){\n    const prev = { crops:chkCrops.checked, color:chkColor.checked, reg:chkReg.checked };\n    chkCrops.checked = false;\n    chkColor.checked = false;\n    chkReg.checked = false;\n    applyToggles();\n    prePrintCommon();\n    injectPrintStyle('@page{size:210mm 297mm;margin:0} html,body{width:210mm;height:297mm;margin:0;padding:0} #menubar,#ui,#sidebar,#rulerTop,#rulerLeft,#viewportZoomControls{display:none!important;} #pageViewport{margin:0!important;padding:0!important;transform:none!important;position:static!important;} #pages{margin:0!important;padding:0!important;transform:none!important;} .sheet{left:0;top:0;width:210mm!important;height:297mm!important;margin:0!important;position:relative!important;box-shadow:none!important;border:none!important;} .trim{left:0!important;top:0!important;width:210mm!important;height:297mm!important} .marks,.crop,.trim::before{display:none!important;} :root{--m-top:12mm;--m-bot:12mm;--m-in:12mm;--m-out:12mm;--bleed:0mm;--sheet-w:210mm;--sheet-h:297mm}');\n    setTimeout(()=>window.print(), 120);\n    runPrintRestore(()=>{\n      chkCrops.checked = prev.crops;\n      chkColor.checked = prev.color;\n      chkReg.checked = prev.reg;\n      postPrint();\n    });\n  }\n\n  prevBtn.addEventListener('click', ()=>snapTo(cur-1, false));\n  nextBtn.addEventListener('click', ()=>snapTo(cur+1, false));\n  firstBtn.addEventListener('click', ()=>snapTo(0, false));\n  lastBtn.addEventListener('click', ()=>snapTo(getTotalPages()-1, false));\n  goBtn.addEventListener('click', ()=>{ const v = parseInt(gotoEl.value,10)||1; snapTo(v-1, false); });\n  gotoEl.addEventListener('keydown', ev=>{ if(ev.key === 'Enter'){ const v = parseInt(gotoEl.value,10)||1; snapTo(v-1, false); }});\n  newPageBtn.addEventListener('click', ()=>addPage(cur));\n  duplicatePageBtn.addEventListener('click', duplicateCurrentPage);\n  pageThemeSelect.addEventListener('change', ()=>{\n    const page = docModel.pages[cur];\n    if(!page) return;\n    const theme = normalizeTheme(pageThemeSelect.value);\n    page.theme = theme;\n    const sheet = pages[cur];\n    if(sheet){\n      applyPageThemeClass(sheet, theme);\n    }\n    markDirty();\n    buildThumbnails();\n  });\n  elementStyleSelect.addEventListener('change', ()=>{\n    if(!styledSelection.type) return;\n    const pageIdx = styledSelection.pageIndex;\n    const elementIdx = styledSelection.elementIndex;\n    const type = styledSelection.type;\n    const page = docModel.pages[pageIdx];\n    if(!page) return;\n    const element = page.elements[elementIdx];\n    if(!element) return;\n    const normalized = type === 'frame' ? normalizeStyleValue('frame', elementStyleSelect.value) : normalizeStyleValue('columns', elementStyleSelect.value);\n    element.style = normalized;\n    if(type === 'frame'){\n      const frame = pageCanvasRoot.querySelector('.frame[data-page-index=\"'+pageIdx+'\"][data-element-index=\"'+elementIdx+'\"]');\n      if(frame) applyElementStyleClass(frame, normalized, 'frame');\n    } else {\n      const block = pageCanvasRoot.querySelector('.column-window-stack[data-page-index=\"'+pageIdx+'\"][data-element-index=\"'+elementIdx+'\"]');\n      if(block) applyElementStyleClass(block, normalized, 'columns');\n    }\n    populateElementStyleOptions(type, normalized);\n    elementStyleSelect.value = normalized;\n    markDirty();\n    buildThumbnails();\n  });\n\n  window.addEventListener('keydown', ev=>{\n    if(isPreviewOpen()){\n      if(ev.ctrlKey || ev.metaKey){\n        if(ev.key === '=' || ev.key === '+'){\n          ev.preventDefault();\n          previewZoomBy(0.1);\n          return;\n        }\n        if(ev.key === '-'){\n          ev.preventDefault();\n          previewZoomBy(-0.1);\n          return;\n        }\n        if(ev.key === '0'){\n          ev.preventDefault();\n          previewZoomFit();\n          return;\n        }\n      }\n      if(ev.key === 'ArrowRight' || ev.key === 'PageDown'){\n        ev.preventDefault();\n        goToPreviewPage(previewPageIndex+1);\n        return;\n      }\n      if(ev.key === 'ArrowLeft' || ev.key === 'PageUp'){\n        ev.preventDefault();\n        goToPreviewPage(previewPageIndex-1);\n        return;\n      }\n      if(ev.key === 'Home'){\n        ev.preventDefault();\n        goToPreviewPage(0, true);\n        return;\n      }\n      if(ev.key === 'End'){\n        ev.preventDefault();\n        goToPreviewPage(getTotalPages()-1, true);\n        return;\n      }\n      if(ev.key === 'Enter' && !ev.ctrlKey && !ev.metaKey){\n        ev.preventDefault();\n        closePagePreview();\n        return;\n      }\n    }\n    if(ev.ctrlKey || ev.metaKey){\n      if(ev.key === '=' || ev.key === '+'){\n        ev.preventDefault();\n        zoomIn();\n        return;\n      }\n      if(ev.key === '-'){\n        ev.preventDefault();\n        zoomOut();\n        return;\n      }\n      if(ev.key === '0'){\n        ev.preventDefault();\n        zoomReset();\n        return;\n      }\n    }\n    if(ev.target === gotoEl) return;\n    if(ev.key === 'ArrowRight' || ev.key === 'PageDown') snapTo(cur+1, false);\n    if(ev.key === 'ArrowLeft' || ev.key === 'PageUp') snapTo(cur-1, false);\n    if(ev.key === 'Home') snapTo(0, false);\n    if(ev.key === 'End') snapTo(getTotalPages()-1, false);\n  });\n\n  window.addEventListener('afterprint', postPrint);\n  window.addEventListener('beforeunload', ev=>{\n    if(isDirty){\n      ev.preventDefault();\n      ev.returnValue = '';\n    }\n  });\n\n  renderDocument();\n  applyMobileState();\n  updateVersionInfo();\n  snapTo(0, true);\n  setStatus('Ready.', false);\n  notifyParentReady();\n  window.addEventListener('resize', ()=>{\n    buildThumbnails();\n    applyZoom();\n    applyMobileState();\n    if(isPreviewOpen()){\n      previewShouldRefit = true;\n      renderPagePreview();\n    }\n  });\n\n})();\n<\/script>\n</body>\n</html>\n",
  "comic-issue-forge.html": "<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<title>Orbit Comics Editor ‚Äî Orbit OS v 0.0.2</title>\n<style>\n  :root {\n    color-scheme: light;\n    --bg: #eef1f8;\n    --panel: #ffffff;\n    --panel-strong: #f7f9ff;\n    --border: #c5cbe0;\n    --border-strong: #92a0d0;\n    --text: #1b2240;\n    --text-soft: #5a6388;\n    --accent: #4769ff;\n    --accent-soft: rgba(71, 105, 255, 0.12);\n    --accent-strong: #2040b8;\n    --danger: #b83232;\n    --success: #1c8c4d;\n    --shadow: 0 12px 32px rgba(23, 33, 74, 0.12);\n    --card-radius: 16px;\n    --page-aspect: calc(6.625 / 10.25);\n    font-family: 'Segoe UI', 'Tahoma', 'Helvetica Neue', sans-serif;\n  }\n\n  * {\n    box-sizing: border-box;\n  }\n\n  body {\n    margin: 0;\n    padding: 32px;\n    background: radial-gradient(circle at top, rgba(255,255,255,0.9), rgba(224,230,255,0.85)), var(--bg);\n    min-height: 100vh;\n    color: var(--text);\n  }\n\n  .app-shell {\n    max-width: 1280px;\n    margin: 0 auto 48px;\n    background: var(--panel);\n    border-radius: 20px;\n    box-shadow: var(--shadow);\n    border: 1px solid rgba(146, 160, 208, 0.35);\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n  }\n\n  header.app-header {\n    padding: 28px 32px 20px;\n    background: linear-gradient(140deg, rgba(71, 105, 255, 0.12), rgba(116, 152, 255, 0.08));\n    border-bottom: 1px solid rgba(146, 160, 208, 0.35);\n  }\n\n  header.app-header h1 {\n    margin: 0 0 6px;\n    font-size: clamp(28px, 3vw, 38px);\n    font-weight: 700;\n    letter-spacing: -0.02em;\n  }\n\n  header.app-header p {\n    margin: 0;\n    color: var(--text-soft);\n    font-size: 15px;\n    max-width: 720px;\n  }\n\n  .toolbar {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 20px;\n    align-items: center;\n    padding: 24px 32px 16px;\n    border-bottom: 1px solid rgba(146, 160, 208, 0.25);\n    background: linear-gradient(180deg, var(--panel), var(--panel-strong));\n  }\n\n  .toolbar .project-meta {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n    min-width: 260px;\n  }\n\n  .toolbar label {\n    font-size: 13px;\n    color: var(--text-soft);\n    font-weight: 600;\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n  }\n\n  .toolbar input[type=\"text\"] {\n    padding: 10px 14px;\n    border-radius: 12px;\n    border: 1px solid var(--border);\n    background: rgba(255,255,255,0.85);\n    font-size: 16px;\n    color: var(--text);\n    transition: border 0.2s ease, box-shadow 0.2s ease;\n  }\n\n  .toolbar input[type=\"text\"]:focus {\n    outline: none;\n    border-color: var(--accent);\n    box-shadow: 0 0 0 3px rgba(71, 105, 255, 0.18);\n  }\n\n  .progress-row {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  .progress-row strong {\n    font-size: 15px;\n  }\n\n  .progress-bar {\n    position: relative;\n    height: 10px;\n    border-radius: 999px;\n    background: rgba(71, 105, 255, 0.12);\n    overflow: hidden;\n  }\n\n  .progress-bar span {\n    position: absolute;\n    inset: 0;\n    width: 0;\n    background: linear-gradient(90deg, var(--accent), rgba(71, 105, 255, 0.55));\n    transition: width 0.25s ease;\n  }\n\n  .toolbar .actions {\n    margin-left: auto;\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    flex-wrap: wrap;\n  }\n\n  button {\n    appearance: none;\n    border: none;\n    border-radius: 12px;\n    padding: 10px 18px;\n    font-size: 15px;\n    font-weight: 600;\n    letter-spacing: 0.01em;\n    cursor: pointer;\n    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;\n    background: #eef1ff;\n    color: var(--accent-strong);\n    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);\n  }\n\n  button:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 8px 18px rgba(71, 105, 255, 0.18);\n  }\n\n  button.primary {\n    background: linear-gradient(135deg, #4769ff, #3f5be0);\n    color: #fff;\n    box-shadow: 0 12px 24px rgba(56, 86, 224, 0.35);\n  }\n\n  button.primary:hover {\n    box-shadow: 0 14px 26px rgba(56, 86, 224, 0.45);\n  }\n\n  button.ghost {\n    background: rgba(91, 104, 144, 0.1);\n    color: var(--text-soft);\n  }\n\n  .info-panel {\n    padding: 0 32px 8px;\n    display: grid;\n    grid-template-columns: minmax(240px, 1fr) minmax(200px, auto);\n    gap: 20px;\n    align-items: start;\n  }\n\n  .info-panel ul {\n    margin: 0;\n    padding-left: 20px;\n    color: var(--text-soft);\n    font-size: 14px;\n    line-height: 1.6;\n  }\n\n  .sequence-indicator {\n    padding: 14px 18px;\n    background: rgba(71, 105, 255, 0.08);\n    border-radius: 14px;\n    border: 1px dashed rgba(71, 105, 255, 0.3);\n    font-size: 14px;\n    color: var(--accent-strong);\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n  }\n\n  .sequence-indicator strong {\n    font-size: 15px;\n  }\n\n  .page-grid {\n    padding: 16px 32px 32px;\n    display: grid;\n    gap: 18px;\n    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n    background: var(--panel-strong);\n  }\n\n  .page-card {\n    background: #fff;\n    border-radius: var(--card-radius);\n    border: 1px solid rgba(146, 160, 208, 0.4);\n    padding: 16px;\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n    position: relative;\n    transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;\n    min-height: 320px;\n  }\n\n  .page-card:focus-within,\n  .page-card:hover {\n    border-color: var(--accent);\n    box-shadow: 0 10px 22px rgba(65, 88, 190, 0.22);\n  }\n\n  .page-card.is-ready {\n    border-color: rgba(28, 140, 77, 0.45);\n    box-shadow: 0 10px 24px rgba(28, 140, 77, 0.22);\n  }\n\n  .page-card.is-sequence-start::after {\n    content: \"Sequence start\";\n    position: absolute;\n    top: 14px;\n    right: 16px;\n    font-size: 11px;\n    text-transform: uppercase;\n    letter-spacing: 0.12em;\n    background: var(--accent);\n    color: #fff;\n    padding: 3px 8px;\n    border-radius: 999px;\n    box-shadow: 0 4px 12px rgba(71, 105, 255, 0.35);\n  }\n\n  .page-card.is-dragover {\n    border-style: dashed;\n    border-color: var(--accent);\n  }\n\n  .page-head {\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n  }\n\n  .page-title {\n    font-size: 18px;\n    font-weight: 700;\n    margin: 0;\n  }\n\n  .page-kind {\n    font-size: 12px;\n    font-weight: 600;\n    color: var(--text-soft);\n    text-transform: uppercase;\n    letter-spacing: 0.08em;\n  }\n\n  .page-drop {\n    position: relative;\n    border-radius: 14px;\n    border: 1px dashed rgba(146, 160, 208, 0.55);\n    background: rgba(71, 105, 255, 0.04);\n    flex: 1 1 auto;\n    min-height: 180px;\n    overflow: hidden;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    cursor: pointer;\n    padding: 12px;\n    transition: border 0.2s ease, background 0.2s ease;\n  }\n\n  .page-drop:hover {\n    border-color: var(--accent);\n    background: rgba(71, 105, 255, 0.08);\n  }\n\n  .page-drop img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n    object-position: center;\n    display: none;\n    border-radius: 10px;\n    background: #fff;\n  }\n\n  .page-drop .placeholder {\n    text-align: center;\n    color: var(--text-soft);\n    font-size: 14px;\n    line-height: 1.6;\n  }\n\n  .page-actions {\n    display: flex;\n    gap: 10px;\n    flex-wrap: wrap;\n  }\n\n  .page-meta {\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 8px 12px;\n    font-size: 12px;\n    color: var(--text-soft);\n  }\n\n  .page-meta dt {\n    font-weight: 700;\n    text-transform: uppercase;\n    letter-spacing: 0.08em;\n  }\n\n  .page-meta dd {\n    margin: 0;\n    color: var(--text);\n    font-size: 12px;\n    word-break: break-word;\n  }\n\n  footer.app-footer {\n    padding: 18px 28px 24px;\n    border-top: 1px solid rgba(146, 160, 208, 0.25);\n    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(240,244,255,0.9));\n  }\n\n  .status {\n    padding: 12px 16px;\n    border-radius: 12px;\n    font-size: 14px;\n    display: inline-flex;\n    align-items: center;\n    gap: 10px;\n    border: 1px solid rgba(146, 160, 208, 0.4);\n    background: rgba(255, 255, 255, 0.9);\n  }\n\n  .status::before {\n    content: '‚óè';\n    font-size: 10px;\n    color: var(--accent);\n  }\n\n  .status[data-tone=\"success\"] {\n    border-color: rgba(28, 140, 77, 0.4);\n    background: rgba(28, 140, 77, 0.08);\n    color: var(--success);\n  }\n\n  .status[data-tone=\"success\"]::before {\n    color: var(--success);\n  }\n\n  .status[data-tone=\"error\"] {\n    border-color: rgba(184, 50, 50, 0.35);\n    background: rgba(184, 50, 50, 0.08);\n    color: var(--danger);\n  }\n\n  .status[data-tone=\"error\"]::before {\n    color: var(--danger);\n  }\n\n  .status[data-tone=\"info\"] {\n    color: var(--text-soft);\n  }\n\n  @media (max-width: 960px) {\n    body {\n      padding: 16px;\n    }\n\n    .app-shell {\n      border-radius: 14px;\n    }\n\n    .toolbar {\n      padding: 20px;\n    }\n\n    .info-panel {\n      grid-template-columns: 1fr;\n      padding: 0 20px 12px;\n    }\n\n    .page-grid {\n      padding: 12px 20px 20px;\n      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    }\n\n    header.app-header {\n      padding: 24px 24px 18px;\n    }\n  }\n\n  @media (max-width: 640px) {\n    .toolbar {\n      flex-direction: column;\n      align-items: stretch;\n    }\n\n    .toolbar .actions {\n      width: 100%;\n      justify-content: stretch;\n    }\n\n    .toolbar .actions button {\n      flex: 1 1 auto;\n      text-align: center;\n    }\n\n    .page-grid {\n      grid-template-columns: 1fr;\n    }\n  }\n</style>\n</head>\n<body>\n<div class=\"app-shell\" role=\"application\" aria-label=\"Orbit Comics Editor\">\n  <header class=\"app-header\">\n    <h1>Orbit Comics Editor</h1>\n    <p>Build a professional 36-page US comic issue by pairing each page slot with finished artwork. Drop ready-made images, review the lineup, save your project, and export a trim-ready PDF at 6.625 √ó 10.25 in.</p>\n  </header>\n  <section class=\"toolbar\">\n    <div class=\"project-meta\">\n      <label for=\"issue-title\">Issue title\n        <input id=\"issue-title\" type=\"text\" spellcheck=\"false\" autocomplete=\"off\" placeholder=\"Untitled comic\">\n      </label>\n      <div class=\"progress-row\">\n        <strong><span id=\"ready-count\">0</span> / <span id=\"total-count\">36</span> pages ready</strong>\n        <div class=\"progress-bar\" aria-hidden=\"true\"><span id=\"ready-progress\"></span></div>\n      </div>\n    </div>\n    <div class=\"actions\">\n      <button id=\"import-sequence\" type=\"button\">Import sequence‚Ä¶</button>\n      <button id=\"save-browser\" type=\"button\">Save to browser</button>\n      <button id=\"load-browser\" type=\"button\">Load from browser</button>\n      <button id=\"export-project\" type=\"button\">Save project JSON</button>\n      <button id=\"import-project\" type=\"button\">Load project JSON‚Ä¶</button>\n      <button id=\"clear-all\" type=\"button\" class=\"ghost\">Clear all</button>\n      <button id=\"export-pdf\" type=\"button\" class=\"primary\">Export trimmed PDF</button>\n    </div>\n  </section>\n  <section class=\"info-panel\">\n    <ul>\n      <li>Each slot accepts high-resolution PNG, JPG, or WebP artwork. Drag &amp; drop files or use the ‚ÄúLoad image‚Äù button.</li>\n      <li>Sequence import follows the highlighted card. Click a card to set the starting point before loading a folder full of pages.</li>\n      <li>Artwork is centred on the US comic trim (6.625 √ó 10.25 in). Add bleed inside your images if a printer requires it.</li>\n    </ul>\n    <div class=\"sequence-indicator\">\n      <strong>Sequence start</strong>\n      <div>Import sequence begins at <span id=\"sequence-label\">Front Cover</span>.</div>\n      <div>Tip: Use multiple selection in your file dialog to feed covers, interiors, and back matter in one action.</div>\n    </div>\n  </section>\n  <main id=\"page-grid\" class=\"page-grid\" aria-live=\"polite\"></main>\n  <footer class=\"app-footer\">\n    <div id=\"status\" class=\"status\" role=\"status\" aria-live=\"polite\" data-tone=\"info\">Ready to build your issue.</div>\n  </footer>\n</div>\n\n<input type=\"file\" id=\"sequence-input\" accept=\"image/*\" multiple hidden>\n<input type=\"file\" id=\"project-input\" accept=\"application/json\" hidden>\n\n<template id=\"page-card-template\">\n  <article class=\"page-card\" tabindex=\"0\">\n    <div class=\"page-head\">\n      <h2 class=\"page-title\">Page label</h2>\n      <span class=\"page-kind\">Interior</span>\n    </div>\n    <div class=\"page-drop\" data-drop>\n      <img class=\"page-preview\" alt=\"Page preview\" loading=\"lazy\">\n      <div class=\"placeholder\">Drop image here or use ‚ÄúLoad image‚Äù</div>\n    </div>\n    <div class=\"page-actions\">\n      <button type=\"button\" data-action=\"load\">Load image‚Ä¶</button>\n      <button type=\"button\" data-action=\"clear\" class=\"ghost\">Clear</button>\n    </div>\n    <dl class=\"page-meta\">\n      <div>\n        <dt>File</dt>\n        <dd data-meta=\"file\">‚Äî</dd>\n      </div>\n      <div>\n        <dt>Resolution</dt>\n        <dd data-meta=\"resolution\">‚Äî</dd>\n      </div>\n      <div>\n        <dt>Size</dt>\n        <dd data-meta=\"size\">‚Äî</dd>\n      </div>\n      <div>\n        <dt>Updated</dt>\n        <dd data-meta=\"updated\">‚Äî</dd>\n      </div>\n    </dl>\n    <input type=\"file\" accept=\"image/*\" hidden data-file-input>\n  </article>\n</template>\n\n<script>\n(function() {\n  const PAGE_BLUEPRINT = [\n    { id: 'cover-front', label: 'Front Cover', kind: 'Cover' },\n    { id: 'cover-inner-front', label: 'Inside Front Cover', kind: 'Cover' },\n    ...Array.from({ length: 32 }, (_, i) => ({\n      id: `page-${i + 1}`,\n      label: `Page ${i + 1}`,\n      kind: 'Interior'\n    })),\n    { id: 'cover-inner-back', label: 'Inside Back Cover', kind: 'Cover' },\n    { id: 'cover-back', label: 'Back Cover', kind: 'Cover' }\n  ];\n\n  const state = PAGE_BLUEPRINT.map(page => ({\n    ...page,\n    dataUrl: null,\n    pdfDataUrl: null,\n    imageWidth: 0,\n    imageHeight: 0,\n    fileName: '',\n    fileSize: 0,\n    updatedAt: null,\n    sourceType: ''\n  }));\n\n  const cards = [];\n  const totalCount = state.length;\n  const grid = document.getElementById('page-grid');\n  const template = document.getElementById('page-card-template');\n  const readyCountEl = document.getElementById('ready-count');\n  const totalCountEl = document.getElementById('total-count');\n  const progressFill = document.getElementById('ready-progress');\n  const statusEl = document.getElementById('status');\n  const importBtn = document.getElementById('import-sequence');\n  const saveBrowserBtn = document.getElementById('save-browser');\n  const loadBrowserBtn = document.getElementById('load-browser');\n  const exportProjectBtn = document.getElementById('export-project');\n  const importProjectBtn = document.getElementById('import-project');\n  const clearBtn = document.getElementById('clear-all');\n  const exportBtn = document.getElementById('export-pdf');\n  const sequenceInput = document.getElementById('sequence-input');\n  const projectInput = document.getElementById('project-input');\n  const sequenceLabel = document.getElementById('sequence-label');\n  const issueTitleInput = document.getElementById('issue-title');\n  const TITLE_STORAGE_KEY = 'orbit-comics-editor-title';\n  const LEGACY_TITLE_KEY = 'orbit-comic-forge-title';\n  const PROJECT_STORAGE_KEY = 'orbit-comics-editor-project';\n  const AUTOSAVE_ERROR_MESSAGE = 'Autosave to browser storage failed. Use ‚ÄúSave project JSON‚Äù to keep a backup.';\n  let sequenceStartIndex = 0;\n  let jsPdfLoader = null;\n  let autosaveEnabled = true;\n  let titleAutosaveTimer = null;\n  let lastAutosaveResult = 'idle';\n\n  totalCountEl.textContent = String(totalCount);\n\n  function setStatus(message, tone = 'info') {\n    statusEl.textContent = message;\n    statusEl.setAttribute('data-tone', tone);\n  }\n\n  function getProjectSnapshot() {\n    return {\n      version: '0.0.2',\n      title: issueTitleInput.value || '',\n      sequenceStartId: state[sequenceStartIndex] ? state[sequenceStartIndex].id : null,\n      pages: state.map(page => ({\n        id: page.id,\n        label: page.label,\n        kind: page.kind,\n        dataUrl: page.dataUrl,\n        imageWidth: page.imageWidth,\n        imageHeight: page.imageHeight,\n        fileName: page.fileName,\n        fileSize: page.fileSize,\n        updatedAt: page.updatedAt ? page.updatedAt.toISOString() : null,\n        sourceType: page.sourceType\n      }))\n    };\n  }\n\n  function applyProjectSnapshot(snapshot) {\n    if (!snapshot || !Array.isArray(snapshot.pages)) {\n      throw new Error('Invalid project snapshot.');\n    }\n    const pagesById = new Map(snapshot.pages.map(page => [page.id, page]));\n    state.forEach((page, index) => {\n      const incoming = pagesById.get(page.id);\n      if (incoming && incoming.dataUrl) {\n        page.dataUrl = incoming.dataUrl;\n        page.pdfDataUrl = incoming.dataUrl;\n        page.imageWidth = incoming.imageWidth || 0;\n        page.imageHeight = incoming.imageHeight || 0;\n        page.fileName = incoming.fileName || '';\n        page.fileSize = incoming.fileSize || 0;\n        page.updatedAt = incoming.updatedAt ? new Date(incoming.updatedAt) : null;\n        page.sourceType = incoming.sourceType || '';\n      } else {\n        page.dataUrl = null;\n        page.pdfDataUrl = null;\n        page.imageWidth = 0;\n        page.imageHeight = 0;\n        page.fileName = '';\n        page.fileSize = 0;\n        page.updatedAt = null;\n        page.sourceType = '';\n      }\n      renderPage(index);\n    });\n    issueTitleInput.value = snapshot.title && snapshot.title.trim() ? snapshot.title : 'Untitled Comic';\n    persistTitle();\n    const startId = snapshot.sequenceStartId;\n    if (startId) {\n      const idx = state.findIndex(page => page.id === startId);\n      assignSequenceStart(idx >= 0 ? idx : 0);\n    } else {\n      assignSequenceStart(0);\n    }\n    updateProgress();\n  }\n\n  function autosaveProject() {\n    if (!autosaveEnabled) return 'skipped';\n    try {\n      const snapshot = getProjectSnapshot();\n      localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(snapshot));\n      lastAutosaveResult = 'success';\n      return 'success';\n    } catch (error) {\n      autosaveEnabled = false;\n      lastAutosaveResult = 'error';\n      console.warn('Autosave disabled. Unable to write project to browser storage.', error);\n      return 'error';\n    }\n  }\n\n  function saveProjectToBrowser() {\n    try {\n      const snapshot = getProjectSnapshot();\n      localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(snapshot));\n      autosaveEnabled = true;\n      lastAutosaveResult = 'success';\n      setStatus('Project saved to browser storage.', 'success');\n      return true;\n    } catch (error) {\n      console.error('Manual save to browser storage failed.', error);\n      lastAutosaveResult = 'error';\n      setStatus('Could not save to browser storage. Project may be too large for local storage.', 'error');\n      return false;\n    }\n  }\n\n  function restoreProjectFromBrowser({ showStatus = false } = {}) {\n    let stored = null;\n    try {\n      stored = localStorage.getItem(PROJECT_STORAGE_KEY);\n    } catch (error) {\n      console.warn('Unable to access browser storage.', error);\n      if (showStatus) setStatus('Browser storage is unavailable in this context.', 'error');\n      return false;\n    }\n    if (!stored) {\n      if (showStatus) setStatus('No project found in browser storage.', 'error');\n      return false;\n    }\n    try {\n      const snapshot = JSON.parse(stored);\n      applyProjectSnapshot(snapshot);\n      autosaveEnabled = true;\n      lastAutosaveResult = 'success';\n      if (showStatus) setStatus('Project loaded from browser storage.', 'success');\n      return true;\n    } catch (error) {\n      console.error('Failed to restore project from browser storage.', error);\n      if (showStatus) setStatus('Stored project data is invalid or corrupted.', 'error');\n      return false;\n    }\n  }\n\n  function exportProjectJson() {\n    try {\n      const snapshot = getProjectSnapshot();\n      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      const safeName = sanitizeFilename(snapshot.title || 'comic-project') || 'comic-project';\n      link.href = url;\n      link.download = `${safeName}.orbit-project.json`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n      setStatus('Project JSON downloaded.', 'success');\n    } catch (error) {\n      console.error('Failed to export project JSON.', error);\n      setStatus('Could not export project JSON.', 'error');\n    }\n  }\n\n  function readFileAsText(file) {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => resolve(reader.result);\n      reader.onerror = () => reject(reader.error || new Error('File read failed.'));\n      reader.readAsText(file);\n    });\n  }\n\n  async function importProjectFromFile(file) {\n    if (!file) return;\n    try {\n      const contents = await readFileAsText(file);\n      const snapshot = JSON.parse(contents);\n      applyProjectSnapshot(snapshot);\n      autosaveEnabled = true;\n      const autosaveResult = autosaveProject();\n      if (autosaveResult === 'error' || lastAutosaveResult === 'error') {\n        setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n      } else {\n        setStatus('Project JSON loaded.', 'success');\n      }\n    } catch (error) {\n      console.error('Project import failed.', error);\n      setStatus('Could not import project JSON. Ensure the file was created by Orbit Comics Editor.', 'error');\n    }\n  }\n\n  function formatBytes(bytes) {\n    if (!bytes) return '‚Äî';\n    const units = ['B', 'KB', 'MB', 'GB'];\n    const idx = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);\n    const value = bytes / Math.pow(1024, idx);\n    return `${value.toFixed(value >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;\n  }\n\n  function formatDate(date) {\n    if (!date) return '‚Äî';\n    return new Intl.DateTimeFormat(undefined, {\n      dateStyle: 'medium',\n      timeStyle: 'short'\n    }).format(date);\n  }\n\n  function sanitizeFilename(name) {\n    return name\n      .replace(/[^a-z0-9_\\-]+/gi, '-')\n      .replace(/-+/g, '-')\n      .replace(/^-+|-+$/g, '')\n      .slice(0, 80);\n  }\n\n  function updateProgress() {\n    const ready = state.filter(p => !!p.dataUrl).length;\n    readyCountEl.textContent = String(ready);\n    const ratio = ready / totalCount;\n    progressFill.style.width = `${Math.round(ratio * 100)}%`;\n  }\n\n  function renderPage(index) {\n    const card = cards[index];\n    const page = state[index];\n    if (!card) return;\n    const preview = card.querySelector('.page-preview');\n    const placeholder = card.querySelector('.placeholder');\n    const fileEl = card.querySelector('[data-meta=\"file\"]');\n    const resEl = card.querySelector('[data-meta=\"resolution\"]');\n    const sizeEl = card.querySelector('[data-meta=\"size\"]');\n    const updatedEl = card.querySelector('[data-meta=\"updated\"]');\n\n    if (page.dataUrl) {\n      preview.src = page.dataUrl;\n      preview.style.display = 'block';\n      placeholder.style.display = 'none';\n      card.classList.add('is-ready');\n      fileEl.textContent = page.fileName || 'Image';\n      resEl.textContent = page.imageWidth && page.imageHeight\n        ? `${page.imageWidth} √ó ${page.imageHeight}`\n        : '‚Äî';\n      sizeEl.textContent = formatBytes(page.fileSize);\n      updatedEl.textContent = formatDate(page.updatedAt);\n    } else {\n      preview.removeAttribute('src');\n      preview.style.display = 'none';\n      placeholder.style.display = 'block';\n      card.classList.remove('is-ready');\n      fileEl.textContent = '‚Äî';\n      resEl.textContent = '‚Äî';\n      sizeEl.textContent = '‚Äî';\n      updatedEl.textContent = '‚Äî';\n    }\n  }\n\n  function resetPage(index) {\n    const page = state[index];\n    page.dataUrl = null;\n    page.pdfDataUrl = null;\n    page.imageWidth = 0;\n    page.imageHeight = 0;\n    page.fileName = '';\n    page.fileSize = 0;\n    page.updatedAt = null;\n    page.sourceType = '';\n    renderPage(index);\n  }\n\n  function ensureJsPDF() {\n    if (window.jspdf && window.jspdf.jsPDF) {\n      return Promise.resolve(window.jspdf);\n    }\n    if (jsPdfLoader) return jsPdfLoader;\n    jsPdfLoader = new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';\n      script.onload = () => resolve(window.jspdf);\n      script.onerror = () => reject(new Error('Failed to load jsPDF library.'));\n      document.head.appendChild(script);\n    });\n    return jsPdfLoader;\n  }\n\n  function assignSequenceStart(index) {\n    sequenceStartIndex = index;\n    sequenceLabel.textContent = state[index].label;\n    cards.forEach((card, idx) => {\n      card.classList.toggle('is-sequence-start', idx === sequenceStartIndex);\n    });\n  }\n\n  async function applyFileToPage(index, file) {\n    if (!file) return false;\n    if (!file.type.startsWith('image/')) {\n      setStatus(`‚Äú${file.name}‚Äù is not an image.`, 'error');\n      return false;\n    }\n    try {\n      const dataUrl = await readFileAsDataUrl(file);\n      const img = await loadImage(dataUrl);\n      const canvas = document.createElement('canvas');\n      canvas.width = img.naturalWidth || img.width;\n      canvas.height = img.naturalHeight || img.height;\n      const ctx = canvas.getContext('2d');\n      ctx.fillStyle = '#ffffff';\n      ctx.fillRect(0, 0, canvas.width, canvas.height);\n      ctx.drawImage(img, 0, 0);\n      const jpegData = canvas.toDataURL('image/jpeg', 0.92);\n      const page = state[index];\n      page.dataUrl = jpegData;\n      page.pdfDataUrl = jpegData;\n      page.imageWidth = canvas.width;\n      page.imageHeight = canvas.height;\n      page.fileName = file.name;\n      page.fileSize = file.size;\n      page.updatedAt = new Date();\n      page.sourceType = file.type;\n      renderPage(index);\n      updateProgress();\n      const autosaveResult = autosaveProject();\n      if (autosaveResult === 'error' || lastAutosaveResult === 'error') {\n        setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n      } else {\n        setStatus(`${page.label} ready.`, 'success');\n      }\n      return true;\n    } catch (error) {\n      console.error(error);\n      setStatus(`Could not process ‚Äú${file.name}‚Äù.`, 'error');\n      return false;\n    }\n  }\n\n  function readFileAsDataUrl(file) {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => resolve(reader.result);\n      reader.onerror = () => reject(reader.error || new Error('File read failed.'));\n      reader.readAsDataURL(file);\n    });\n  }\n\n  function loadImage(src) {\n    return new Promise((resolve, reject) => {\n      const img = new Image();\n      img.onload = () => resolve(img);\n      img.onerror = () => reject(new Error('Image decode failed.'));\n      img.src = src;\n    });\n  }\n\n  async function handleSequence(files) {\n    if (!files || !files.length) {\n      setStatus('No images selected for sequence import.', 'error');\n      return;\n    }\n    const images = Array.from(files).filter(file => file.type.startsWith('image/'));\n    if (!images.length) {\n      setStatus('No compatible images found in selection.', 'error');\n      return;\n    }\n    images.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));\n    let assigned = 0;\n    for (let i = 0; i < images.length; i += 1) {\n      const targetIndex = sequenceStartIndex + i;\n      if (targetIndex >= state.length) break;\n      const success = await applyFileToPage(targetIndex, images[i]);\n      if (success) assigned += 1;\n    }\n    if (lastAutosaveResult === 'error') {\n      setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n    } else if (assigned) {\n      setStatus(`Imported ${assigned} page${assigned === 1 ? '' : 's'} starting at ${state[sequenceStartIndex].label}.`, 'success');\n    } else {\n      setStatus('No pages were updated.', 'error');\n    }\n  }\n\n  async function exportPdf() {\n    const ready = state.filter(p => !!p.dataUrl).length;\n    if (!ready) {\n      setStatus('Load at least one page before exporting.', 'error');\n      return;\n    }\n    setStatus('Preparing PDF export‚Ä¶', 'info');\n    try {\n      const { jsPDF } = await ensureJsPDF();\n      const doc = new jsPDF({\n        orientation: 'portrait',\n        unit: 'in',\n        format: [6.625, 10.25]\n      });\n      const pageWidth = doc.internal.pageSize.getWidth();\n      const pageHeight = doc.internal.pageSize.getHeight();\n\n      state.forEach((page, index) => {\n        if (index !== 0) doc.addPage();\n        doc.setFillColor(255, 255, 255);\n        doc.rect(0, 0, pageWidth, pageHeight, 'F');\n        if (page.pdfDataUrl) {\n          const ratio = page.imageWidth && page.imageHeight ? page.imageWidth / page.imageHeight : pageWidth / pageHeight;\n          const pageRatio = pageWidth / pageHeight;\n          let drawWidth;\n          let drawHeight;\n          let offsetX = 0;\n          let offsetY = 0;\n          if (ratio > pageRatio) {\n            drawHeight = pageHeight;\n            drawWidth = pageHeight * ratio;\n            offsetX = (pageWidth - drawWidth) / 2;\n          } else {\n            drawWidth = pageWidth;\n            drawHeight = pageWidth / ratio;\n            offsetY = (pageHeight - drawHeight) / 2;\n          }\n          doc.addImage(page.pdfDataUrl, 'JPEG', offsetX, offsetY, drawWidth, drawHeight, undefined, 'FAST');\n        } else {\n          doc.setTextColor(120, 130, 160);\n          doc.setFontSize(12);\n          doc.text(page.label, pageWidth / 2, pageHeight / 2, { align: 'center', baseline: 'middle' });\n        }\n      });\n\n      const rawName = (issueTitleInput.value || '').trim() || 'comic-issue';\n      const safeName = sanitizeFilename(rawName) || 'comic-issue';\n      doc.save(`${safeName}.pdf`);\n      setStatus('Export complete. PDF downloaded.', 'success');\n    } catch (error) {\n      console.error(error);\n      setStatus('Export failed. Please retry.', 'error');\n    }\n  }\n\n  function buildCards() {\n    PAGE_BLUEPRINT.forEach((page, index) => {\n      const fragment = template.content.cloneNode(true);\n      const card = fragment.querySelector('.page-card');\n      const title = card.querySelector('.page-title');\n      const kind = card.querySelector('.page-kind');\n      const drop = card.querySelector('[data-drop]');\n      const loadBtn = card.querySelector('[data-action=\"load\"]');\n      const clearBtn = card.querySelector('[data-action=\"clear\"]');\n      const fileInput = card.querySelector('[data-file-input]');\n\n      title.textContent = page.label;\n      kind.textContent = page.kind;\n      if (page.kind === 'Interior') {\n        kind.style.color = 'var(--text-soft)';\n      }\n\n      drop.addEventListener('click', () => fileInput.click());\n      loadBtn.addEventListener('click', (event) => {\n        event.stopPropagation();\n        fileInput.click();\n      });\n      clearBtn.addEventListener('click', (event) => {\n        event.stopPropagation();\n        resetPage(index);\n        updateProgress();\n        const autosaveResult = autosaveProject();\n        if (autosaveResult === 'error' || lastAutosaveResult === 'error') {\n          setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n        } else {\n          setStatus(`${state[index].label} cleared.`, 'info');\n        }\n      });\n\n      fileInput.addEventListener('change', (event) => {\n        const file = event.target.files && event.target.files[0];\n        if (file) {\n          applyFileToPage(index, file);\n          assignSequenceStart(index);\n        }\n        fileInput.value = '';\n      });\n\n      drop.addEventListener('dragover', (event) => {\n        event.preventDefault();\n        card.classList.add('is-dragover');\n      });\n\n      drop.addEventListener('dragleave', () => {\n        card.classList.remove('is-dragover');\n      });\n\n      drop.addEventListener('drop', (event) => {\n        event.preventDefault();\n        card.classList.remove('is-dragover');\n        const file = event.dataTransfer.files && event.dataTransfer.files[0];\n        if (file) {\n          applyFileToPage(index, file);\n          assignSequenceStart(index);\n        }\n      });\n\n      card.addEventListener('click', (event) => {\n        if (event.target.closest('button') || event.target.closest('input')) return;\n        assignSequenceStart(index);\n      });\n\n      card.addEventListener('keydown', (event) => {\n        if (event.key === 'Enter' || event.key === ' ') {\n          event.preventDefault();\n          assignSequenceStart(index);\n        }\n      });\n\n      cards.push(card);\n      grid.appendChild(fragment);\n      renderPage(index);\n    });\n    assignSequenceStart(0);\n  }\n\n  function restoreTitle() {\n    try {\n      const saved = localStorage.getItem(TITLE_STORAGE_KEY) || localStorage.getItem(LEGACY_TITLE_KEY);\n      if (saved && saved.trim()) {\n        issueTitleInput.value = saved;\n      } else {\n        issueTitleInput.value = 'Untitled Comic';\n      }\n    } catch (error) {\n      console.warn('Unable to restore project title', error);\n      issueTitleInput.value = 'Untitled Comic';\n    }\n  }\n\n  function persistTitle() {\n    try {\n      localStorage.setItem(TITLE_STORAGE_KEY, issueTitleInput.value || '');\n      localStorage.removeItem(LEGACY_TITLE_KEY);\n    } catch (error) {\n      console.warn('Unable to persist project title', error);\n    }\n  }\n\n  issueTitleInput.addEventListener('input', () => {\n    persistTitle();\n    if (titleAutosaveTimer) window.clearTimeout(titleAutosaveTimer);\n    titleAutosaveTimer = window.setTimeout(() => {\n      const result = autosaveProject();\n      if (result === 'error') {\n        setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n      }\n    }, 600);\n  });\n\n  importBtn.addEventListener('click', () => {\n    sequenceInput.click();\n  });\n\n  saveBrowserBtn.addEventListener('click', () => {\n    saveProjectToBrowser();\n  });\n\n  loadBrowserBtn.addEventListener('click', () => {\n    restoreProjectFromBrowser({ showStatus: true });\n  });\n\n  exportProjectBtn.addEventListener('click', () => {\n    exportProjectJson();\n  });\n\n  importProjectBtn.addEventListener('click', () => {\n    projectInput.click();\n  });\n\n  sequenceInput.addEventListener('change', (event) => {\n    const files = event.target.files;\n    if (files) {\n      handleSequence(files);\n    }\n    sequenceInput.value = '';\n  });\n\n  projectInput.addEventListener('change', (event) => {\n    const file = event.target.files && event.target.files[0];\n    if (file) {\n      importProjectFromFile(file);\n    }\n    projectInput.value = '';\n  });\n\n  clearBtn.addEventListener('click', () => {\n    const confirmed = window.confirm('Clear every page slot? This cannot be undone.');\n    if (!confirmed) return;\n    state.forEach((_, index) => resetPage(index));\n    updateProgress();\n    const autosaveResult = autosaveProject();\n    if (autosaveResult === 'error' || lastAutosaveResult === 'error') {\n      setStatus(AUTOSAVE_ERROR_MESSAGE, 'error');\n    } else {\n      setStatus('All pages cleared.', 'info');\n    }\n  });\n\n  exportBtn.addEventListener('click', exportPdf);\n\n  buildCards();\n  updateProgress();\n  const restored = restoreProjectFromBrowser();\n  if (!restored) {\n    restoreTitle();\n  }\n})();\n<\/script>\n</body>\n</html>\n",
  "scanx.html": "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>ScanX ‚Ä¢ Orbit OS</title>\n  <style>\n    :root {\n      color-scheme: light;\n      --bg:#f4f6ff;\n      --panel:#ffffff;\n      --ink:#13224d;\n      --muted:#5c678a;\n      --accent:#3c7dff;\n      --border:#c7d4f5;\n      --success:#1e7e34;\n      --error:#b71c1c;\n    }\n    * { box-sizing:border-box; }\n    body {\n      margin:0;\n      font-family:\"Segoe UI\", system-ui, sans-serif;\n      background:var(--bg);\n      color:var(--ink);\n      min-height:100vh;\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      padding:24px;\n    }\n    .scanx-shell {\n      width:100%;\n      max-width:960px;\n      background:var(--panel);\n      border:2px solid var(--border);\n      border-radius:16px;\n      box-shadow:0 18px 48px rgba(19,34,77,0.18);\n      padding:28px;\n      display:flex;\n      flex-direction:column;\n      gap:24px;\n    }\n    header h1 {\n      margin:0;\n      font-size:28px;\n      letter-spacing:0.04em;\n    }\n    header p {\n      margin:6px 0 0 0;\n      color:var(--muted);\n      font-size:15px;\n    }\n    .upload-row {\n      display:flex;\n      flex-wrap:wrap;\n      gap:12px;\n      align-items:center;\n    }\n    .upload-row input[type=\"file\"] {\n      flex:1 1 260px;\n      padding:10px;\n      border:1px dashed var(--border);\n      border-radius:10px;\n      background:#f9fbff;\n    }\n    button {\n      font:600 15px \"Segoe UI\", system-ui, sans-serif;\n      border-radius:10px;\n      border:1px solid transparent;\n      padding:10px 18px;\n      cursor:pointer;\n      transition:transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;\n      background:linear-gradient(145deg, var(--accent), #1d4bd8);\n      color:#fff;\n      box-shadow:0 8px 20px rgba(60,125,255,0.24);\n      min-width:150px;\n    }\n    button:disabled {\n      opacity:0.55;\n      cursor:not-allowed;\n      box-shadow:none;\n      transform:none;\n    }\n    button.secondary {\n      background:#fff;\n      color:var(--ink);\n      border-color:var(--border);\n      box-shadow:0 4px 12px rgba(19,34,77,0.08);\n    }\n    .actions {\n      display:flex;\n      flex-wrap:wrap;\n      gap:12px;\n    }\n    .status {\n      padding:14px 16px;\n      border-radius:12px;\n      background:#eef3ff;\n      border:1px solid var(--border);\n      font-size:15px;\n      line-height:1.5;\n    }\n    .status.success {\n      background:rgba(30,126,52,0.12);\n      border-color:rgba(30,126,52,0.4);\n      color:var(--success);\n    }\n    .status.error {\n      background:rgba(183,28,28,0.12);\n      border-color:rgba(183,28,28,0.4);\n      color:var(--error);\n    }\n    .status.processing {\n      background:rgba(60,125,255,0.12);\n      border-color:rgba(60,125,255,0.4);\n    }\n    .summary {\n      display:grid;\n      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));\n      gap:16px;\n    }\n    .page-card {\n      border:1px solid var(--border);\n      border-radius:12px;\n      padding:14px 16px;\n      background:#f9fbff;\n      box-shadow:0 4px 14px rgba(19,34,77,0.08);\n    }\n    .page-card h3 {\n      margin:0 0 8px 0;\n      font-size:18px;\n    }\n    .page-card p {\n      margin:0;\n      color:var(--muted);\n      font-size:14px;\n      line-height:1.5;\n    }\n    .page-card .page-preview {\n      margin:10px 0 12px 0;\n    }\n    .page-card .page-meta {\n      margin:0 0 6px 0;\n      color:var(--accent);\n      font-weight:600;\n      font-size:14px;\n    }\n    .page-card .page-margins {\n      margin:0 0 10px 0;\n      color:var(--muted);\n      font-size:13px;\n    }\n    .page-thumb {\n      position:relative;\n      width:100%;\n      aspect-ratio:3 / 4;\n      min-height:140px;\n      background:#fff;\n      border-radius:10px;\n      border:1px solid rgba(19,34,77,0.12);\n      overflow:hidden;\n      box-shadow:inset 0 0 0 1px rgba(19,34,77,0.04);\n    }\n    .page-thumb__content {\n      position:absolute;\n      inset:8% 6%;\n      border:1px dashed rgba(19,34,77,0.18);\n      border-radius:8px;\n      background:linear-gradient(180deg, rgba(60,125,255,0.05) 0%, rgba(60,125,255,0.05) 60%, transparent 100%);\n      overflow:hidden;\n    }\n    .page-thumb__content[data-style] {\n      inset:auto;\n    }\n    .page-thumb__column {\n      position:absolute;\n      background:repeating-linear-gradient(180deg, rgba(60,125,255,0.16), rgba(60,125,255,0.16) 6%, rgba(60,125,255,0.08) 6%, rgba(60,125,255,0.08) 12%);\n      border-radius:6px;\n      box-shadow:0 2px 4px rgba(19,34,77,0.08);\n    }\n    .page-thumb__column::after {\n      content:'';\n      position:absolute;\n      inset:8% 10%;\n      border-radius:4px;\n      background:repeating-linear-gradient(180deg, rgba(19,34,77,0.08), rgba(19,34,77,0.08) 6%, transparent 6%, transparent 12%);\n      opacity:0.9;\n    }\n    .page-thumb--empty {\n      display:flex;\n      align-items:center;\n      justify-content:center;\n      color:var(--muted);\n      font-size:12px;\n      text-align:center;\n      padding:12px;\n    }\n    .meta-row {\n      display:flex;\n      flex-wrap:wrap;\n      gap:12px;\n      font-size:14px;\n      color:var(--muted);\n    }\n    @media (max-width:640px) {\n      body { padding:12px; }\n      .scanx-shell { padding:20px; }\n      button { flex:1 1 100%; min-width:0; }\n      .upload-row input[type=\"file\"] { flex:1 1 100%; }\n    }\n  </style>\n</head>\n<body>\n  <main class=\"scanx-shell\">\n    <header>\n      <h1>ScanX Publishing Studio</h1>\n      <p>Transform source PDFs into publication-ready Docu Monster layouts with one click.</p>\n    </header>\n    <section class=\"upload-row\">\n      <input type=\"file\" id=\"pdfInput\" accept=\"application/pdf\" />\n      <button id=\"analyzeBtn\" disabled>Analyze PDF</button>\n    </section>\n    <section class=\"meta-row\" id=\"metaRow\" hidden>\n      <span id=\"metaFile\"></span>\n      <span id=\"metaPages\"></span>\n      <span id=\"metaLayout\"></span>\n    </section>\n    <section class=\"status\" id=\"statusPanel\">Select a PDF to begin.</section>\n    <section class=\"actions\">\n      <button id=\"downloadBtn\" class=\"secondary\" disabled>Download .dx</button>\n      <button id=\"saveLocalBtn\" class=\"secondary\" disabled>Save to Local Storage</button>\n      <button id=\"openDocBtn\" disabled>Open in Docu Monster</button>\n    </section>\n    <section class=\"summary\" id=\"summary\"></section>\n  </main>\n  <script>\n    function createProgressLogger(namespace) {\n      const name = namespace || 'Log';\n      const prefix = `[${name}]`;\n      let start = Date.now();\n      const entries = [];\n      const record = (level, message, detail) => {\n        const elapsedMs = Date.now() - start;\n        const payload = detail === undefined ? undefined : detail;\n        const entry = {\n          level,\n          message,\n          elapsedMs,\n          timestamp: new Date().toISOString(),\n          detail: payload || null\n        };\n        entries.push(entry);\n        if (typeof console !== 'undefined') {\n          const logger = typeof console[level] === 'function' ? console[level] : console.log;\n          if (typeof logger === 'function') {\n            if (payload === undefined) {\n              logger.call(console, `${prefix} ${message} (+${elapsedMs}ms)`);\n            } else {\n              logger.call(console, `${prefix} ${message} (+${elapsedMs}ms)`, payload);\n            }\n          }\n        }\n      };\n      return {\n        step(message, detail) { record('info', message, detail); },\n        warn(message, detail) { record('warn', message, detail); },\n        error(message, detail) { record('error', message, detail); },\n        reset() {\n          entries.length = 0;\n          start = Date.now();\n          record('info', 'Progress log reset');\n        },\n        entries() {\n          return entries.slice();\n        }\n      };\n    }\n\n    const scanxLog = createProgressLogger('ScanX');\n    if (typeof window !== 'undefined') {\n      window.__scanxProgressLog = scanxLog;\n    }\n\n    const PDFJS_SOURCES = [\n      {\n        script: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.2.67/build/pdf.min.js',\n        worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.2.67/build/pdf.worker.min.js'\n      },\n      {\n        script: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js',\n        worker: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js'\n      },\n      {\n        script: '../../shared/vendor/scanx/pdfjs-lite.js',\n        lite: true\n      }\n    ];\n\n    const HAS_NATIVE_DECOMPRESSION = typeof DecompressionStream === 'function';\n    let activePdfSource = null;\n\n    function loadScript(src) {\n      return new Promise((resolve, reject) => {\n        const script = document.createElement('script');\n        script.src = src;\n        script.async = true;\n        script.onload = () => {\n          scanxLog.step('Script loaded', { src });\n          resolve();\n        };\n        script.onerror = () => {\n          scanxLog.warn('Script failed to load', { src });\n          reject(new Error('Failed to load script: ' + src));\n        };\n        document.head.appendChild(script);\n      });\n    }\n\n    function configurePdfJs(source) {\n      try {\n        const target = source || activePdfSource;\n        if (window.pdfjsLib && target && target.worker && window.pdfjsLib.GlobalWorkerOptions) {\n          window.pdfjsLib.GlobalWorkerOptions.workerSrc = target.worker;\n        }\n      } catch (err) {\n        console.warn('Unable to configure PDF.js worker', err);\n      }\n    }\n\n    async function ensurePdfJsLoaded() {\n      if (window.pdfjsLib && !window.pdfjsLib.__scanxLiteUnsupported) {\n        if (!activePdfSource) {\n          activePdfSource = PDFJS_SOURCES.find(src => !src.lite) || PDFJS_SOURCES[0];\n        }\n        configurePdfJs();\n        scanxLog.step('PDF.js already available', { source: activePdfSource && activePdfSource.script });\n        return window.pdfjsLib;\n      }\n      for (const source of PDFJS_SOURCES) {\n        if (source.lite && !HAS_NATIVE_DECOMPRESSION) {\n          scanxLog.warn('Skipping PDF.js lite source', { reason: 'missing-decompression-stream', src: source.script });\n          continue;\n        }\n        try {\n          scanxLog.step('Attempting to load PDF.js source', { src: source.script, lite: !!source.lite });\n          await loadScript(source.script);\n          if (source.lite) {\n            if (window.__scanxPdfjsLiteUnsupported) {\n              delete window.__scanxPdfjsLiteUnsupported;\n              scanxLog.warn('PDF.js lite reported unsupported environment', { src: source.script });\n              continue;\n            }\n          }\n          if (window.pdfjsLib) {\n            if (window.pdfjsLib.__scanxLiteUnsupported) {\n              delete window.pdfjsLib;\n              scanxLog.warn('PDF.js lite failed to initialize', { src: source.script });\n              continue;\n            }\n            activePdfSource = source;\n            configurePdfJs(source);\n            scanxLog.step('PDF.js source ready', { src: source.script, worker: source.worker || null });\n            return window.pdfjsLib;\n          }\n        } catch (err) {\n          scanxLog.warn('PDF.js source failed', { src: source.script, error: err && err.message ? err.message : String(err) });\n        }\n      }\n      scanxLog.error('PDF.js library could not be loaded');\n      throw new Error('PDF.js library could not be loaded');\n    }\n\n    let pdfjsReadyPromise = null;\n\n    const STORAGE_KEY = 'documonster-studiopro-autosave-v0-1';\n    const DX_MIME = 'application/vnd.orbit-documonster+json';\n    const DX_EXTENSION = '.dx';\n\n    const pdfInput = document.getElementById('pdfInput');\n    const analyzeBtn = document.getElementById('analyzeBtn');\n    const statusPanel = document.getElementById('statusPanel');\n    const downloadBtn = document.getElementById('downloadBtn');\n    const saveLocalBtn = document.getElementById('saveLocalBtn');\n    const openDocBtn = document.getElementById('openDocBtn');\n    const summaryEl = document.getElementById('summary');\n    const metaRow = document.getElementById('metaRow');\n    const metaFile = document.getElementById('metaFile');\n    const metaPages = document.getElementById('metaPages');\n    const metaLayout = document.getElementById('metaLayout');\n\n    let working = false;\n    let currentDoc = null;\n    let currentFileName = '';\n\n    function setStatus(message, mode = 'info') {\n      statusPanel.textContent = message;\n      statusPanel.classList.remove('success', 'error', 'processing');\n      if (mode === 'success') statusPanel.classList.add('success');\n      else if (mode === 'error') statusPanel.classList.add('error');\n      else if (mode === 'processing') statusPanel.classList.add('processing');\n    }\n\n    function initializePdfEngine() {\n      if (!pdfjsReadyPromise) {\n        scanxLog.step('Initializing PDF engine');\n        pdfjsReadyPromise = ensurePdfJsLoaded();\n      }\n      pdfjsReadyPromise.catch(err => {\n        scanxLog.error('ScanX PDF engine failed to load', { error: err && err.message ? err.message : String(err) });\n        setStatus('ScanX could not load its PDF engine. Check your connection and reload.', 'error');\n      });\n      return pdfjsReadyPromise;\n    }\n\n    function toggleWorking(state) {\n      working = state;\n      analyzeBtn.disabled = state || !pdfInput.files.length;\n      downloadBtn.disabled = state || !currentDoc;\n      saveLocalBtn.disabled = state || !currentDoc;\n      openDocBtn.disabled = state || !currentDoc;\n      pdfInput.disabled = state;\n      if (state) {\n        setStatus('Analyzing PDF‚Ä¶ this may take a moment.', 'processing');\n        scanxLog.step('Analysis started');\n      } else {\n        scanxLog.step('Analysis finished');\n      }\n    }\n\n    function escapeHtml(input) {\n      return input.replace(/[&<>\"']/g, ch => ({\n        '&': '&amp;',\n        '<': '&lt;',\n        '>': '&gt;',\n        '\"': '&quot;',\n        \"'\": '&#39;'\n      })[ch]);\n    }\n\n    const POINT_TO_MM = 25.4 / 72;\n    const LOREM_SOURCE = 'Lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua Vivamus feugiat ligula at fringilla pharetra mauris neque fermentum velit eu consequat augue magna a magna Donec aliquet orci ut turpis imperdiet a tincidunt erat fermentum Praesent suscipit varius nulla nec vehicula nisl pharetra vitae';\n    const LOREM_WORDS = LOREM_SOURCE.split(/\\s+/).filter(Boolean);\n\n    function loremWords(count) {\n      const safe = Math.max(12, Math.round(count || 0));\n      const words = [];\n      for (let i = 0; i < safe; i++) {\n        words.push(LOREM_WORDS[i % LOREM_WORDS.length]);\n      }\n      return words;\n    }\n\n    function buildLoremParagraph(wordEstimate) {\n      const words = loremWords(Math.max(wordEstimate, 35));\n      const sentences = [];\n      const chunkSize = 18;\n      for (let i = 0; i < words.length; i += chunkSize) {\n        const slice = words.slice(i, i + chunkSize);\n        if (!slice.length) continue;\n        const sentence = slice.join(' ');\n        sentences.push(sentence.charAt(0).toUpperCase() + sentence.slice(1) + '.');\n      }\n      return sentences.join(' ');\n    }\n\n    function extractTextBoxes(textContent, viewport) {\n      const boxes = [];\n      const items = Array.isArray(textContent && textContent.items)\n        ? textContent.items\n        : (textContent && typeof textContent.items === 'object' && textContent.items !== null && typeof textContent.items.length === 'number')\n          ? Array.from(textContent.items)\n          : [];\n      const styles = textContent && textContent.styles ? textContent.styles : {};\n      const pageHeight = viewport && typeof viewport.height === 'number' ? viewport.height : 0;\n      const pageWidth = viewport && typeof viewport.width === 'number' ? viewport.width : 0;\n      const pageScale = viewport && typeof viewport.scale === 'number' ? viewport.scale : 1;\n\n      const toMatrix = value => {\n        if (!value) return [1, 0, 0, 1, 0, 0];\n        if (Array.isArray(value)) return value.slice(0, 6);\n        if (typeof value.length === 'number') return Array.from(value).slice(0, 6);\n        if (typeof value === 'object') {\n          if (typeof value.a === 'number' && typeof value.b === 'number' && typeof value.c === 'number' && typeof value.d === 'number' && typeof value.e === 'number' && typeof value.f === 'number') {\n            return [value.a, value.b, value.c, value.d, value.e, value.f];\n          }\n          if (typeof value.m11 === 'number' && typeof value.m12 === 'number' && typeof value.m21 === 'number' && typeof value.m22 === 'number') {\n            const e = typeof value.m41 === 'number' ? value.m41 : (typeof value.e === 'number' ? value.e : 0);\n            const f = typeof value.m42 === 'number' ? value.m42 : (typeof value.f === 'number' ? value.f : 0);\n            return [value.m11, value.m12, value.m21, value.m22, e, f];\n          }\n        }\n        return [1, 0, 0, 1, 0, 0];\n      };\n\n      const viewportTransform = viewport && viewport.transform ? toMatrix(viewport.transform) : null;\n      const textSamples = [];\n\n      items.forEach(item => {\n        const rawSource =\n          (typeof item.str === 'string' && item.str) ? item.str :\n          (typeof item.text === 'string' && item.text) ? item.text :\n          (typeof item.unicode === 'string' && item.unicode) ? item.unicode :\n          '';\n        const raw = String(rawSource)\n          .replace(/[\\u0000-\\u001f]+/g, ' ')\n          .replace(/\\s+/g, ' ');\n        const text = raw.trim();\n        if (!text) return;\n        textSamples.push(text);\n\n        const transform = toMatrix(item.transform);\n        let glyphMatrix = transform;\n        if (window.pdfjsLib && window.pdfjsLib.Util && viewportTransform) {\n          try {\n            glyphMatrix = window.pdfjsLib.Util.transform(viewportTransform, transform);\n          } catch (err) {\n            glyphMatrix = transform;\n          }\n        }\n\n        const style = item.fontName && styles[item.fontName] ? styles[item.fontName] : null;\n        const fontSizePx = style && typeof style.fontSize === 'number'\n          ? Math.abs(style.fontSize) * pageScale\n          : null;\n        const scaleX = Math.hypot(glyphMatrix[0] || 0, glyphMatrix[1] || 0);\n        const scaleY = Math.hypot(glyphMatrix[2] || 0, glyphMatrix[3] || 0);\n        const orientationVertical = style && style.vertical === true\n          ? true\n          : scaleY > scaleX && scaleY > 0;\n\n        let width = 0;\n        if (typeof item.width === 'number' && Number.isFinite(item.width)) {\n          width = Math.abs(item.width) * pageScale;\n        }\n        if ((!Number.isFinite(width) || width <= 0) && !orientationVertical) {\n          width = scaleX;\n        }\n        if ((!Number.isFinite(width) || width <= 0) && orientationVertical) {\n          width = scaleY;\n        }\n        if (!Number.isFinite(width) || width <= 0) {\n          width = Math.max(text.length * (fontSizePx ? fontSizePx * 0.4 : 2), 4);\n        }\n\n        let heightPx = fontSizePx;\n        if (!Number.isFinite(heightPx) || heightPx <= 0) {\n          heightPx = orientationVertical ? scaleX : scaleY;\n        }\n        if (!Number.isFinite(heightPx) || heightPx <= 0) {\n          heightPx = Math.max(width * 0.35, 2);\n        }\n\n        const rawX = Number.isFinite(glyphMatrix[4]) ? glyphMatrix[4] : 0;\n        const rawY = Number.isFinite(glyphMatrix[5]) ? glyphMatrix[5] : 0;\n        const top = pageHeight ? Math.max(pageHeight - rawY - heightPx, 0) : 0;\n        const left = Math.min(rawX, rawX + width);\n        const right = Math.max(rawX, rawX + width);\n\n        boxes.push({\n          text,\n          left,\n          right,\n          top,\n          bottom: top + heightPx,\n          width: right - left,\n          height: heightPx,\n          center: (left + right) / 2\n        });\n      });\n\n      if (!boxes.length && textSamples.length) {\n        const fallbackText = textSamples.join(' ').replace(/\\s+/g, ' ').trim();\n        if (fallbackText) {\n          const fallbackWidth = pageWidth || Math.max(pageHeight * 0.75, 512);\n          const fallbackHeight = pageHeight || Math.max(pageWidth * 1.3, 720);\n          boxes.push({\n            text: fallbackText,\n            left: 0,\n            right: fallbackWidth,\n            top: 0,\n            bottom: fallbackHeight,\n            width: fallbackWidth,\n            height: fallbackHeight,\n            center: fallbackWidth / 2,\n            synthetic: true\n          });\n          scanxLog.warn('Using synthesized text box fallback', {\n            items: items.length,\n            textLength: fallbackText.length\n          });\n        }\n      }\n\n      const syntheticUsed = boxes.some(box => box && box.synthetic);\n      boxes.syntheticFallbackUsed = syntheticUsed;\n      scanxLog.step('Extracted text boxes', {\n        items: items.length,\n        boxes: boxes.length,\n        pageWidth,\n        pageHeight,\n        syntheticFallback: syntheticUsed\n      });\n      return boxes;\n    }\n\n    function clusterColumns(boxes, pageWidth) {\n      if (!boxes.length) return [];\n      const sorted = boxes.slice().sort((a, b) => a.left - b.left);\n      const threshold = Math.max(pageWidth * 0.08, 24);\n      const columns = [];\n      sorted.forEach(box => {\n        let assigned = null;\n        for (const column of columns) {\n          const distance = Math.abs(box.center - column.center);\n          if (distance <= threshold) {\n            assigned = column;\n            break;\n          }\n        }\n        if (!assigned) {\n          assigned = {\n            boxes: [],\n            left: box.left,\n            right: box.right,\n            top: box.top,\n            bottom: box.bottom,\n            center: box.center\n          };\n          columns.push(assigned);\n        }\n        assigned.boxes.push(box);\n        assigned.left = Math.min(assigned.left, box.left);\n        assigned.right = Math.max(assigned.right, box.right);\n        assigned.top = Math.min(assigned.top, box.top);\n        assigned.bottom = Math.max(assigned.bottom, box.bottom);\n        assigned.center = (assigned.left + assigned.right) / 2;\n      });\n      columns.sort((a, b) => a.left - b.left);\n      while (columns.length > 4) {\n        let mergeIndex = 0;\n        let smallestGap = Infinity;\n        for (let i = 0; i < columns.length - 1; i++) {\n          const gap = columns[i + 1].left - columns[i].right;\n          if (gap < smallestGap) {\n            smallestGap = gap;\n            mergeIndex = i;\n          }\n        }\n        const target = columns[mergeIndex];\n        const neighbor = columns[mergeIndex + 1];\n        target.boxes.push(...neighbor.boxes);\n        target.left = Math.min(target.left, neighbor.left);\n        target.right = Math.max(target.right, neighbor.right);\n        target.top = Math.min(target.top, neighbor.top);\n        target.bottom = Math.max(target.bottom, neighbor.bottom);\n        target.center = (target.left + target.right) / 2;\n        columns.splice(mergeIndex + 1, 1);\n      }\n      if (columns.length > 1) {\n        const totalBoxes = boxes.length;\n        for (let i = columns.length - 1; i >= 0; i--) {\n          const col = columns[i];\n          const share = col.boxes.length / totalBoxes;\n          const widthShare = (col.right - col.left) / pageWidth;\n          if (share < 0.08 || widthShare < 0.08) {\n            const neighbor = i === 0 ? columns[1] : columns[i - 1];\n            neighbor.boxes.push(...col.boxes);\n            neighbor.left = Math.min(neighbor.left, col.left);\n            neighbor.right = Math.max(neighbor.right, col.right);\n            neighbor.top = Math.min(neighbor.top, col.top);\n            neighbor.bottom = Math.max(neighbor.bottom, col.bottom);\n            neighbor.center = (neighbor.left + neighbor.right) / 2;\n            columns.splice(i, 1);\n          }\n        }\n      }\n      columns.forEach(col => col.boxes.sort((a, b) => a.top - b.top || a.left - b.left));\n      return columns;\n    }\n\n    function buildColumnPlaceholder(column) {\n      if (!column.boxes.length) {\n        return {\n          html: `<p>${escapeHtml(buildLoremParagraph(40))}</p>`,\n          height: column.bottom - column.top\n        };\n      }\n      const heights = column.boxes.map(box => box.height);\n      const avgHeight = heights.reduce((sum, value) => sum + value, 0) / heights.length || 0;\n      const gapThreshold = Math.max(avgHeight * 1.6, 14);\n      const paragraphs = [];\n      let current = [];\n      let lastBottom = null;\n      column.boxes.forEach(box => {\n        if (lastBottom !== null && (box.top - lastBottom) > gapThreshold) {\n          if (current.length) paragraphs.push(current);\n          current = [];\n        }\n        current.push(box);\n        lastBottom = box.bottom;\n      });\n      if (current.length) paragraphs.push(current);\n      const html = paragraphs.map(group => {\n        const original = group\n          .map(item => item.text)\n          .join(' ')\n          .replace(/\\s+/g, ' ')\n          .trim();\n        if (!original) {\n          return `<p>${escapeHtml(buildLoremParagraph(35))}</p>`;\n        }\n        return `<p>${escapeHtml(original)}</p>`;\n      }).join('') || `<p>${escapeHtml(buildLoremParagraph(40))}</p>`;\n      return {\n        html,\n        height: column.bottom - column.top\n      };\n    }\n\n    function buildPreviewText(boxes) {\n      if (!boxes.length) return 'No textual content detected.';\n      const ordered = boxes.slice().sort((a, b) => a.top - b.top || a.left - b.left);\n      const combined = ordered.map(box => box.text).join(' ');\n      return combined.length > 220 ? combined.slice(0, 220) + '‚Ä¶' : combined;\n    }\n\n    function clampPercent(value) {\n      return Math.max(0, Math.min(100, value));\n    }\n\n    function safeNumber(value, fallback = 0) {\n      return (typeof value === 'number' && Number.isFinite(value)) ? value : fallback;\n    }\n\n    function percentOf(value, total) {\n      const safeTotal = total && Number.isFinite(total) && total !== 0 ? Math.abs(total) : 1;\n      return clampPercent((safeNumber(value) / safeTotal) * 100);\n    }\n\n    function buildPageThumbnail(layout) {\n      if (!layout || !layout.pageSizeMm) {\n        return '<div class=\"page-thumb page-thumb--empty\">No layout detected</div>';\n      }\n      const pageWidth = safeNumber(layout.pageSizeMm.width, 210);\n      const pageHeight = safeNumber(layout.pageSizeMm.height, 297);\n      const margins = layout.marginsMm || {};\n      const marginStyles = {\n        left: percentOf(margins.left, pageWidth),\n        right: percentOf(margins.right, pageWidth),\n        top: percentOf(margins.top, pageHeight),\n        bottom: percentOf(margins.bottom, pageHeight)\n      };\n      const columns = Array.isArray(layout.columnsMm) ? layout.columnsMm : [];\n      const columnMarkup = columns.length ? columns.map((col, idx) => {\n        const left = percentOf(col.start, pageWidth);\n        const width = Math.max(6, percentOf(col.width, pageWidth));\n        const topValue = safeNumber(col.top, margins.top || 0);\n        const bottomValue = safeNumber(col.bottom, pageHeight - safeNumber(margins.bottom, 0));\n        const top = percentOf(topValue, pageHeight);\n        const delta = bottomValue - topValue;\n        const heightMm = delta > 0 ? delta : pageHeight * 0.6;\n        const height = Math.max(8, percentOf(heightMm, pageHeight));\n        return `<div class=\"page-thumb__column\" style=\"left:${left}%;width:${width}%;top:${top}%;height:${height}%;\"></div>`;\n      }).join('') : '<div class=\"page-thumb__column\" style=\"left:15%;width:70%;top:12%;height:76%;\"></div>';\n      const contentStyle = `left:${marginStyles.left}%;top:${marginStyles.top}%;right:${marginStyles.right}%;bottom:${marginStyles.bottom}%;`;\n      return `\n        <div class=\"page-thumb\">\n          <div class=\"page-thumb__content\" data-style=\"true\" style=\"${contentStyle}\">\n            ${columnMarkup}\n          </div>\n        </div>\n      `;\n    }\n\n    function formatMeasurement(value) {\n      if (typeof value !== 'number' || !Number.isFinite(value)) return null;\n      const rounded = Math.round(value * 100) / 100;\n      return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(2);\n    }\n\n    function analyzePageLayout(page, textContent) {\n      const viewport = page.getViewport({ scale: 1 });\n      const boxes = extractTextBoxes(textContent, viewport);\n      const syntheticFallbackUsed = boxes && boxes.syntheticFallbackUsed === true;\n      const pageWidthPx = viewport.width;\n      const pageHeightPx = viewport.height;\n      const pageWidthMm = Number((pageWidthPx * POINT_TO_MM).toFixed(2));\n      const pageHeightMm = Number((pageHeightPx * POINT_TO_MM).toFixed(2));\n\n      if (!boxes.length) {\n        const placeholder = `<p>${escapeHtml(buildLoremParagraph(80))}</p>`;\n        return {\n          columns: 1,\n          windows: [placeholder],\n          windowLayout: [{ width: Number((pageWidthMm * 0.7).toFixed(2)), height: Number((pageHeightMm * 0.6).toFixed(2)) }],\n          html: placeholder,\n          preview: 'No textual content detected.',\n          metadata: {\n            pageSizeMm: { width: pageWidthMm, height: pageHeightMm },\n            marginsMm: { top: 15, right: 15, bottom: 15, left: 15 },\n            columnsMm: [],\n            averageGutterMm: 0,\n            syntheticFallbackUsed\n          }\n        };\n      }\n\n      const columns = clusterColumns(boxes, pageWidthPx);\n      const columnData = columns.map(col => {\n        const placeholder = buildColumnPlaceholder(col);\n        return {\n          html: placeholder.html,\n          widthMm: Number(((col.right - col.left) * POINT_TO_MM).toFixed(2)),\n          heightMm: Number((placeholder.height * POINT_TO_MM).toFixed(2)),\n          startMm: Number((col.left * POINT_TO_MM).toFixed(2)),\n          topMm: Number((col.top * POINT_TO_MM).toFixed(2)),\n          bottomMm: Number((col.bottom * POINT_TO_MM).toFixed(2))\n        };\n      });\n\n      const windows = columnData.map(col => col.html);\n      const windowLayout = columnData.map(col => ({ width: col.widthMm, height: col.heightMm }));\n      const html = windows.join('');\n\n      const contentLeft = Math.min(...boxes.map(box => box.left));\n      const contentRight = Math.max(...boxes.map(box => box.right));\n      const contentTop = Math.min(...boxes.map(box => box.top));\n      const contentBottom = Math.max(...boxes.map(box => box.bottom));\n\n      const marginsMm = {\n        top: Number((contentTop * POINT_TO_MM).toFixed(2)),\n        bottom: Number(((pageHeightPx - contentBottom) * POINT_TO_MM).toFixed(2)),\n        left: Number((contentLeft * POINT_TO_MM).toFixed(2)),\n        right: Number(((pageWidthPx - contentRight) * POINT_TO_MM).toFixed(2))\n      };\n\n      const gutters = [];\n      for (let i = 0; i < columns.length - 1; i++) {\n        gutters.push(columns[i + 1].left - columns[i].right);\n      }\n      const averageGutterMm = gutters.length\n        ? Number(((gutters.reduce((acc, gap) => acc + gap, 0) / gutters.length) * POINT_TO_MM).toFixed(2))\n        : 0;\n\n      const metadata = {\n        pageSizeMm: { width: pageWidthMm, height: pageHeightMm },\n        marginsMm,\n        columnsMm: columnData.map(col => ({\n          start: col.startMm,\n          width: col.widthMm,\n          height: col.heightMm,\n          top: col.topMm,\n          bottom: col.bottomMm\n        })),\n        averageGutterMm,\n        syntheticFallbackUsed\n      };\n\n      return {\n        columns: columnData.length || 1,\n        windows,\n        windowLayout,\n        html,\n        preview: buildPreviewText(boxes),\n        metadata,\n        syntheticFallbackUsed\n      };\n    }\n\n    function buildDocument(pages, sourceName, summaries) {\n      const timestamp = new Date();\n      const averageColumns = summaries.length\n        ? (summaries.reduce((total, entry) => total + (entry.columns || 0), 0) / summaries.length)\n        : 0;\n      const gutterSamples = summaries\n        .map(entry => (typeof entry.gutter === 'number' && Number.isFinite(entry.gutter)) ? entry.gutter : null)\n        .filter(value => value !== null);\n      const averageGutter = gutterSamples.length\n        ? gutterSamples.reduce((total, value) => total + value, 0) / gutterSamples.length\n        : null;\n      return {\n        version: '1.0.0',\n        docVersion: '1.0.0',\n        codename: 'ScanX Publishing Studio',\n        docName: 'Docu Monster Studio Pro',\n        releaseNotes: [\n          `Generated by ScanX from ${sourceName} on ${timestamp.toLocaleString()}.`,\n          'Each page has been rebuilt for publishing-ready refinement in Docu Monster.'\n        ],\n        pages,\n        analysis: {\n          source: sourceName,\n          generatedAt: timestamp.toISOString(),\n          pageCount: pages.length,\n          averageColumns: Number.isFinite(averageColumns) ? Number(averageColumns.toFixed(2)) : 0,\n          averageGutterMm: averageGutter !== null ? Number(averageGutter.toFixed(2)) : null,\n          pages: summaries.map(entry => ({\n            index: entry.index,\n            columns: entry.columns || 0,\n            marginsMm: entry.margins || null,\n            averageGutterMm: typeof entry.gutter === 'number' ? entry.gutter : null\n          }))\n        }\n      };\n    }\n\n    async function analyzePdf(file) {\n      scanxLog.reset();\n      scanxLog.step('Starting analysis for file', {\n        name: file && file.name ? file.name : 'unknown',\n        size: file && typeof file.size === 'number' ? file.size : null,\n        type: file && file.type ? file.type : null\n      });\n      try {\n        await initializePdfEngine();\n      } catch (err) {\n        scanxLog.error('PDF engine initialization failed', { error: err && err.message ? err.message : String(err) });\n        setStatus('ScanX could not load its PDF engine. Check your connection and reload.', 'error');\n        return;\n      }\n      toggleWorking(true);\n      summaryEl.innerHTML = '';\n      metaRow.hidden = true;\n      try {\n        const arrayBuffer = await file.arrayBuffer();\n        scanxLog.step('PDF file loaded into memory', { bytes: arrayBuffer.byteLength });\n        const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });\n        const pdf = await loadingTask.promise;\n        scanxLog.step('PDF document ready', {\n          pages: pdf.numPages,\n          fingerprint: Array.isArray(pdf.fingerprints) && pdf.fingerprints.length ? pdf.fingerprints[0] : null\n        });\n        const pages = [];\n        const summaries = [];\n        for (let pageIndex = 1; pageIndex <= pdf.numPages; pageIndex++) {\n          const page = await pdf.getPage(pageIndex);\n          const textContent = await page.getTextContent({\n            includeMarkedContent: true,\n            disableCombineTextItems: false\n          });\n          const layout = analyzePageLayout(page, textContent);\n          scanxLog.step('Page analyzed', {\n            pageIndex,\n            textItems: Array.isArray(textContent && textContent.items) ? textContent.items.length : (textContent && typeof textContent.items === 'object' && typeof textContent.items.length === 'number' ? textContent.items.length : 0),\n            columnsDetected: layout && typeof layout.columns === 'number' ? layout.columns : null,\n            previewLength: layout && typeof layout.preview === 'string' ? layout.preview.length : 0,\n            syntheticFallback: !!(layout && layout.syntheticFallbackUsed)\n          });\n          pages.push({\n            title: `ScanX Page ${pageIndex}`,\n            subtitle: '',\n            deck: '',\n            theme: 'standard',\n            elements: [{\n              type: 'columns',\n              columns: layout.columns,\n              windows: layout.windows,\n              windowLayout: layout.windowLayout,\n              style: 'standard',\n              html: layout.html\n            }],\n            footerLeft: 'Docu Monster Studio Pro',\n            footerRight: 'Page {{page}} of {{total}}',\n            layout: layout.metadata\n          });\n          summaries.push({\n            index: pageIndex,\n            preview: layout.preview,\n            columns: layout.columns,\n            margins: layout.metadata?.marginsMm || null,\n            gutter: typeof layout.metadata?.averageGutterMm === 'number' ? layout.metadata.averageGutterMm : null,\n            layout: layout.metadata\n          });\n        }\n        const averageColumns = summaries.length\n          ? summaries.reduce((total, entry) => total + (entry.columns || 0), 0) / summaries.length\n          : null;\n        const gutterSamples = summaries\n          .map(entry => (typeof entry.gutter === 'number' && Number.isFinite(entry.gutter)) ? entry.gutter : null)\n          .filter(value => value !== null);\n        const averageGutter = gutterSamples.length\n          ? gutterSamples.reduce((total, value) => total + value, 0) / gutterSamples.length\n          : null;\n        scanxLog.step('Analysis summary computed', {\n          pages: summaries.length,\n          averageColumns,\n          averageGutter\n        });\n        currentDoc = buildDocument(pages, file.name, summaries);\n        currentFileName = file.name;\n        renderSummary(summaries);\n        metaFile.textContent = `Source: ${file.name}`;\n        metaPages.textContent = `Pages detected: ${pages.length}`;\n        if (metaLayout) {\n          const parts = [];\n          const columnValue = averageColumns && averageColumns > 0 ? formatMeasurement(averageColumns) : null;\n          if (columnValue) parts.push(`Avg columns: ${columnValue}`);\n          const gutterValue = averageGutter !== null ? formatMeasurement(averageGutter) : null;\n          if (gutterValue) parts.push(`Avg gutter: ${gutterValue} mm`);\n          metaLayout.textContent = parts.length ? parts.join(' ‚Ä¢ ') : 'Layout analysis ready.';\n        }\n        metaRow.hidden = false;\n        const statusParts = [];\n        const statusColumns = averageColumns && averageColumns > 0 ? formatMeasurement(averageColumns) : null;\n        if (statusColumns) statusParts.push(`${statusColumns} avg columns`);\n        const statusGutter = averageGutter !== null ? formatMeasurement(averageGutter) : null;\n        if (statusGutter) statusParts.push(`~${statusGutter} mm gutters`);\n        const statusDetail = statusParts.length ? ` Detected ${statusParts.join(' ‚Ä¢ ')}.` : '';\n        setStatus(`Scan complete. ${pages.length} page${pages.length === 1 ? '' : 's'} ready for Docu Monster.${statusDetail}`, 'success');\n      } catch (err) {\n        scanxLog.error('ScanX analysis failed', { error: err && err.message ? err.message : String(err) });\n        currentDoc = null;\n        setStatus('ScanX could not analyze this PDF: ' + (err.message || err), 'error');\n      } finally {\n        toggleWorking(false);\n      }\n    }\n\n    function renderSummary(entries) {\n      summaryEl.innerHTML = entries.map(entry => {\n        const columnLabel = entry.columns === 1 ? 'Single-column layout' : `${entry.columns}-column layout`;\n        const gutterValue = formatMeasurement(entry.gutter);\n        const gutterLabel = gutterValue ? ` ‚Ä¢ Avg. gutter ${gutterValue}‚ÄØmm` : '';\n        let marginLabel = '';\n        if (entry.margins) {\n          const left = formatMeasurement(entry.margins.left);\n          const top = formatMeasurement(entry.margins.top);\n          const right = formatMeasurement(entry.margins.right);\n          const bottom = formatMeasurement(entry.margins.bottom);\n          if (left || top || right || bottom) {\n            marginLabel = `Margins L:${left ?? '‚Äî'}‚ÄØmm ‚Ä¢ T:${top ?? '‚Äî'}‚ÄØmm ‚Ä¢ R:${right ?? '‚Äî'}‚ÄØmm ‚Ä¢ B:${bottom ?? '‚Äî'}‚ÄØmm`;\n          }\n        }\n        const marginLine = marginLabel ? `<p class=\"page-margins\">${escapeHtml(marginLabel)}</p>` : '';\n        return `\n        <article class=\"page-card\">\n          <h3>Page ${entry.index}</h3>\n          <p class=\"page-meta\">${escapeHtml(columnLabel + gutterLabel)}</p>\n          ${marginLine}\n          <div class=\"page-preview\">${buildPageThumbnail(entry.layout)}</div>\n          <p>${escapeHtml(entry.preview)}</p>\n        </article>\n      `;\n      }).join('');\n    }\n\n    function makeFileBaseName() {\n      const base = currentFileName ? currentFileName.replace(/\\.[^.]+$/, '') : 'scanx-output';\n      return base.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || 'scanx-output';\n    }\n\n    function downloadDx() {\n      if (!currentDoc) return;\n      const blob = new Blob([JSON.stringify(currentDoc, null, 2)], { type: DX_MIME });\n      const a = document.createElement('a');\n      a.href = URL.createObjectURL(blob);\n      a.download = `${makeFileBaseName()}${DX_EXTENSION}`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(a.href);\n      setStatus('DX file downloaded to your disk.', 'success');\n    }\n\n    function saveToLocalStorage() {\n      if (!currentDoc) return;\n      try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentDoc));\n        setStatus('Document stored in local Orbit OS storage for Docu Monster.', 'success');\n      } catch (err) {\n        console.error('Local save failed', err);\n        setStatus('Unable to write to local storage: ' + (err.message || err), 'error');\n      }\n    }\n\n    function openInDocuMonster() {\n      if (!currentDoc) return;\n      setStatus('Sending document to Docu Monster‚Ä¶', 'processing');\n      try {\n        const pageCount = Array.isArray(currentDoc?.pages) ? currentDoc.pages.length : 0;\n        window.parent?.postMessage({\n          type: 'scanx:open-document',\n          payload: {\n            document: currentDoc,\n            name: `${makeFileBaseName()}${DX_EXTENSION}`,\n            pageCount\n          }\n        }, '*');\n      } catch (err) {\n        console.error('Bridge failed', err);\n        setStatus('Could not notify Docu Monster: ' + (err.message || err), 'error');\n      }\n    }\n\n    pdfInput.addEventListener('change', () => {\n      currentDoc = null;\n      summaryEl.innerHTML = '';\n      metaRow.hidden = true;\n      if (metaFile) metaFile.textContent = '';\n      if (metaPages) metaPages.textContent = '';\n      if (metaLayout) metaLayout.textContent = '';\n      downloadBtn.disabled = true;\n      saveLocalBtn.disabled = true;\n      openDocBtn.disabled = true;\n      if (pdfInput.files.length) {\n        analyzeBtn.disabled = false;\n        setStatus('Ready to scan. Click ‚ÄúAnalyze PDF‚Äù to continue.');\n      } else {\n        analyzeBtn.disabled = true;\n        setStatus('Select a PDF to begin.');\n      }\n    });\n\n    analyzeBtn.addEventListener('click', () => {\n      const file = pdfInput.files[0];\n      if (!file || working) return;\n      analyzePdf(file);\n    });\n\n    downloadBtn.addEventListener('click', downloadDx);\n    saveLocalBtn.addEventListener('click', saveToLocalStorage);\n    openDocBtn.addEventListener('click', openInDocuMonster);\n\n    initializePdfEngine();\n\n    window.addEventListener('message', (event) => {\n      const data = event.data;\n      if (!data || typeof data !== 'object') return;\n      if (data.type === 'scanx:documonster-confirm') {\n        setStatus(`Docu Monster opened ${data.payload?.name || 'the document'} (${data.payload?.pageCount ?? '?'} pages).`, 'success');\n      }\n    });\n  <\/script>\n</body>\n</html>\n"
}
    </script>
    <script id="orbit-app-scripts" type="application/json">
{
  "activity": "WinAPI.createWindow('activity');\n\nwindow.fetchActivity = async function() {\n    const el = document.getElementById('activity-area');\n    if (!el) return;\n    el.textContent = 'Loading...';\n    try {\n        const res = await fetch('https://www.boredapi.com/api/activity/');\n        const data = await res.json();\n        el.textContent = data.activity;\n    } catch {\n        el.textContent = 'Error fetching activity.';\n    }\n};\n\nfetchActivity();\n",
  "calculator": "WinAPI.createWindow('calculator');\n\nlet calcValue = '0';\n\nwindow.appendCalc = function(char) {\n    if (char === '‚Üê') {\n        calcValue = calcValue.slice(0, -1) || '0';\n    } else if (char === 'C') {\n        calcValue = '0';\n    } else if (char === '=') {\n        try {\n            calcValue = eval(calcValue).toString();\n        } catch {\n            calcValue = 'Error';\n        }\n    } else {\n        if (calcValue === '0' || calcValue === 'Error') calcValue = '';\n        calcValue += char;\n    }\n    const el = document.getElementById('calc-display');\n    if (el) el.textContent = calcValue;\n};\n\nwindow.clearCalc = function() {\n    calcValue = '0';\n    const el = document.getElementById('calc-display');\n    if (el) el.textContent = calcValue;\n};\n\nwindow.calculate = function() {\n    window.appendCalc('=');\n};\n",
  "calendar": "const id = WinAPI.createWindow('calendar');\n\nconst calendarWindow = document.getElementById(id);\nconst headerEl = calendarWindow?.querySelector('#calendar-month-year');\nconst gridEl = calendarWindow?.querySelector('.calendar-grid');\n\nwindow.currentDate = new Date();\n\nwindow.generateCalendarDays = function(date) {\n    const year = date.getFullYear();\n    const month = date.getMonth();\n\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const daysInMonth = lastDay.getDate();\n    const startDay = firstDay.getDay();\n\n    let daysHtml = '';\n    const today = new Date();\n\n    for (let i = 0; i < startDay; i++) {\n        daysHtml += '<div class=\"calendar-day\"></div>';\n    }\n\n    for (let day = 1; day <= daysInMonth; day++) {\n        const isToday = day === today.getDate() &&\n                        month === today.getMonth() &&\n                        year === today.getFullYear();\n        daysHtml += `<div class=\"calendar-day ${isToday ? 'today' : ''}\">${day}</div>`;\n    }\n\n    return daysHtml;\n};\n\nfunction renderCalendar(date) {\n    if (headerEl) {\n        headerEl.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });\n    }\n    if (gridEl) {\n        while (gridEl.children.length > 7) {\n            gridEl.removeChild(gridEl.lastElementChild);\n        }\n        gridEl.insertAdjacentHTML('beforeend', window.generateCalendarDays(date));\n    }\n}\n\nwindow.changeMonth = function(direction) {\n    window.currentDate.setMonth(window.currentDate.getMonth() + direction);\n    renderCalendar(window.currentDate);\n};\n\nrenderCalendar(window.currentDate);\n",
  "clock": "const id = WinAPI.createWindow('clock');\n\nfunction getClockLocale() {\n    const data = window.appData || {};\n    return (data.settings && data.settings.clockFormat) || navigator.language || 'en-US';\n}\n\nconst container = document.getElementById(id);\nconst timeEl = container?.querySelector('#gshock-time');\nconst dayEl = container?.querySelector('#gshock-day');\nconst dateEl = container?.querySelector('#gshock-date');\nconst modeEl = container?.querySelector('#gshock-mode');\nconst ampmEl = container?.querySelector('#gshock-ampm');\nconst toggleBtn = container?.querySelector('#gshock-toggle');\nconst locale = getClockLocale();\nlet use24 = false;\n\nfunction formatTime(date) {\n    if (use24) {\n        return date.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });\n    }\n    const time = date.toLocaleTimeString(locale, { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });\n    return time.replace(/ /g, '');\n}\n\nfunction updateClock() {\n    const now = new Date();\n    if (timeEl) timeEl.textContent = formatTime(now);\n    if (dayEl) dayEl.textContent = now.toLocaleDateString(locale, { weekday: 'short' }).toUpperCase();\n    if (dateEl) dateEl.textContent = now.toLocaleDateString(locale, { month: 'short', day: '2-digit' }).toUpperCase();\n    if (modeEl) modeEl.textContent = use24 ? '24H' : '12H';\n    if (ampmEl) ampmEl.textContent = use24 ? ' ' : now.toLocaleTimeString(locale, { hour12: true }).slice(-2).toUpperCase();\n}\n\nif (toggleBtn) {\n    toggleBtn.addEventListener('click', () => {\n        use24 = !use24;\n        toggleBtn.classList.toggle('active');\n        updateClock();\n    });\n}\n\nupdateClock();\nsetInterval(updateClock, 1000);\n",
  "cloudstorage": "WinAPI.createWindow('cloud-storage');\n",
  "comicissueforge": "// Launch Orbit Comics Editor inside a WinGUI window iframe\nWinAPI.createWindow('comic-forge');\n",
  "console": "// spawn a console log window; the main app handles initialization\nWinAPI.createWindow('console-log');\n",
  "documonsterstudiopro": "// Launch Docu Monster Studio Pro document studio inside a window iframe\nWinAPI.createWindow('document-editor');\n",
  "guiapi": "(function(){\n    const loaded=new Set();\n    function loadApp(name){\n        const safe=name.toLowerCase().replace(/\\s+/g,'');\n        if(loaded.has(safe)){\n            const type=window.appTypeMap && window.appTypeMap[name.toLowerCase()];\n            if(type && window.openWindow) window.openWindow(type);\n            return;\n        }\n        const script=document.createElement('script');\n        const base=(window.ORBIT_BASE_PATH||'');\n        script.src=`${base}app-js/${safe}.js`;\n        script.onload=()=>loaded.add(safe);\n        document.body.appendChild(script);\n    }\n    function createWindow(type){\n        if(window.openWindow) return window.openWindow(type);\n    }\n    function closeWin(id){ if(window.closeWindow) window.closeWindow(id); }\n    function minimizeWin(id){ if(window.minimizeWindow) window.minimizeWindow(id); }\n    function maximizeWin(id){ if(window.maximizeWindow) window.maximizeWindow(id); }\n    window.loadApp=loadApp;\n    window.WinAPI={\n        createWindow,\n        closeWindow:closeWin,\n        minimizeWindow:minimizeWin,\n        maximizeWindow:maximizeWin\n    };\n})();\n",
  "htmlstudio": "// Simple loader for HTML Studio using an iframe defined in app-data\nWinAPI.createWindow('html-studio');\n",
  "jokes": "WinAPI.createWindow('jokes');\n\nwindow.fetchJoke = async function() {\n    const el = document.getElementById('joke-area');\n    if (!el) return;\n    el.textContent = 'Loading...';\n    try {\n        const res = await fetch('https://v2.jokeapi.dev/joke/Programming?type=single');\n        const data = await res.json();\n        el.textContent = data.joke;\n    } catch {\n        el.textContent = 'Error fetching joke.';\n    }\n};\n\nfetchJoke();\n",
  "notes": "const id = WinAPI.createWindow('notes');\n\nconst win = document.getElementById(id);\nconst area = win?.querySelector('#notes-area');\nif (area) {\n    const key = 'notes-content';\n    area.value = localStorage.getItem(key) || '';\n    area.addEventListener('input', () => {\n        localStorage.setItem(key, area.value);\n    });\n}\n",
  "orbitcomicseditor": "// Alias launcher for Orbit Comics Editor window\n// Ensures the Orbit Comics desktop shortcut loads the correct app script.\nWinAPI.createWindow('comic-forge');\n",
  "puzzle": "WinAPI.createWindow('puzzle-game');\n\nconst puzzleState = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0];\n\nwindow.initPuzzleGame = function() {\n    shuffleArray(puzzleState);\n    const board = document.getElementById('puzzle-board');\n    if (!board) return;\n    board.innerHTML = '';\n    for (let i = 0; i < 16; i++) {\n        const value = puzzleState[i];\n        const tile = document.createElement('div');\n        tile.className = `game-tile ${value === 0 ? 'empty' : ''}`;\n        tile.textContent = value === 0 ? '' : value;\n        tile.dataset.index = i;\n        tile.dataset.value = value;\n        if (value !== 0) {\n            tile.addEventListener('click', () => moveTile(i));\n        }\n        board.appendChild(tile);\n    }\n};\n\nwindow.moveTile = function(index) {\n    const emptyIndex = puzzleState.indexOf(0);\n    const row = Math.floor(index / 4);\n    const col = index % 4;\n    const emptyRow = Math.floor(emptyIndex / 4);\n    const emptyCol = emptyIndex % 4;\n\n    if ((Math.abs(row - emptyRow) === 1 && col === emptyCol) ||\n        (Math.abs(col - emptyCol) === 1 && row === emptyRow)) {\n        [puzzleState[index], puzzleState[emptyIndex]] = [puzzleState[emptyIndex], puzzleState[index]];\n        window.initPuzzleGame();\n        if (isPuzzleSolved()) {\n            setTimeout(() => alert('Congratulations! Puzzle solved!'), 100);\n        }\n    }\n};\n\nfunction isPuzzleSolved() {\n    for (let i = 0; i < 15; i++) {\n        if (puzzleState[i] !== i + 1) return false;\n    }\n    return puzzleState[15] === 0;\n}\n\nfunction shuffleArray(array) {\n    for (let i = array.length - 1; i > 0; i--) {\n        const j = Math.floor(Math.random() * (i + 1));\n        [array[i], array[j]] = [array[j], array[i]];\n    }\n    let inversions = 0;\n    for (let i = 0; i < array.length; i++) {\n        for (let j = i + 1; j < array.length; j++) {\n            if (array[i] > array[j] && array[i] !== 0 && array[j] !== 0) {\n                inversions++;\n            }\n        }\n    }\n    const emptyRow = 4 - Math.floor(array.indexOf(0) / 4);\n    if ((inversions % 2 === 0) !== (emptyRow % 2 === 1)) {\n        if (array[0] !== 0 && array[1] !== 0) {\n            [array[0], array[1]] = [array[1], array[0]];\n        } else {\n            [array[2], array[3]] = [array[3], array[2]];\n        }\n    }\n}\n\nwindow.initPuzzleGame();\n",
  "retrolist": "WinAPI.createWindow('retro-list');\n",
  "scanx": "// Launch ScanX within an Orbit OS window\nWinAPI.createWindow('scanx');\n",
  "terminal": "const id = WinAPI.createWindow('terminal');\n\nconst win = document.getElementById(id);\nconst screen = win?.querySelector('.terminal-screen');\nconst outputEl = win?.querySelector('.terminal-output');\nconst inputEl = win?.querySelector('.terminal-input');\nconst hintsEl = win?.querySelector('.terminal-hints');\n\nconst ORBIT_VERSION = typeof window !== 'undefined' && window.ORBIT_VERSION\n    ? window.ORBIT_VERSION\n    : '0.2.0';\n\nconst terminalConfig = typeof window !== 'undefined' && window.ORBIT_TERMINAL_CONFIG\n    ? window.ORBIT_TERMINAL_CONFIG\n    : {};\n\nconst commandResponses = new Map();\nconst exactResponses = new Map();\nconst customPatterns = new Map();\nlet wildcardResponse = null;\n\nfunction registerResponse(pattern, value, targetMap) {\n    const trimmed = (pattern || '').trim();\n    if (!trimmed) return;\n    const key = trimmed.toLowerCase();\n    customPatterns.set(key, trimmed);\n    targetMap.set(key, { pattern: trimmed, response: value });\n}\n\nif (terminalConfig && typeof terminalConfig === 'object' && terminalConfig.responses) {\n    const entries = Object.entries(terminalConfig.responses);\n    entries.forEach(([pattern, value]) => {\n        if (pattern === '*') {\n            wildcardResponse = value;\n            return;\n        }\n        if (pattern.includes(' ')) {\n            registerResponse(pattern, value, exactResponses);\n        } else {\n            registerResponse(pattern, value, commandResponses);\n        }\n    });\n}\n\nconst defaultFallback = 'Executed \"{command}\".';\n\nfunction applyTemplate(str, context) {\n    return str.replace(/\\{(command|cmd|args|version|date|time|arg(\\d+))\\}/gi, (match, token, index) => {\n        if (!token) return match;\n        const lower = token.toLowerCase();\n        if (lower === 'command') return context.command;\n        if (lower === 'cmd') return context.cmd;\n        if (lower === 'args') return context.args;\n        if (lower === 'version') return context.version;\n        if (lower === 'date') return context.date;\n        if (lower === 'time') return context.time;\n        if (lower.startsWith('arg')) {\n            const argIndex = Number(index);\n            if (Number.isFinite(argIndex)) {\n                return context.argsArray[argIndex] ?? '';\n            }\n        }\n        return match;\n    });\n}\n\nfunction renderResponse(value, context, prefix = '') {\n    const lines = [];\n    const enqueue = (line, injectedPrefix = prefix) => {\n        if (typeof line !== 'string') {\n            line = line != null ? String(line) : '';\n        }\n        const formatted = applyTemplate(line, context);\n        formatted.split(/\\r?\\n/).forEach(part => {\n            lines.push(injectedPrefix ? `${injectedPrefix}${part}` : part);\n        });\n    };\n\n    const process = (input, injectedPrefix = prefix) => {\n        if (input == null) {\n            return;\n        }\n        if (Array.isArray(input)) {\n            input.forEach(item => process(item, injectedPrefix));\n            return;\n        }\n        if (typeof input === 'object') {\n            const typePrefix = input.type ? `[${String(input.type).toUpperCase()}] ` : injectedPrefix;\n            let consumed = false;\n            if (Array.isArray(input.lines)) {\n                input.lines.forEach(item => process(item, typePrefix));\n                consumed = true;\n            }\n            if (typeof input.message === 'string') {\n                enqueue(input.message, typePrefix);\n                consumed = true;\n            }\n            if (!consumed) {\n                enqueue(JSON.stringify(input), injectedPrefix);\n            }\n            return;\n        }\n        enqueue(input, injectedPrefix);\n    };\n\n    process(value, prefix);\n    return lines;\n}\n\nfunction createContext(rawInput, command, args) {\n    const now = new Date();\n    return {\n        command: rawInput,\n        cmd: command,\n        args: args.join(' '),\n        argsArray: args,\n        version: ORBIT_VERSION,\n        date: now.toLocaleDateString(),\n        time: now.toLocaleTimeString()\n    };\n}\n\nfunction resolveCustomResponse(input, command, args) {\n    const context = createContext(input, command, args);\n    const exact = exactResponses.get(input.toLowerCase());\n    if (exact) {\n        return { context, lines: renderResponse(exact.response, context) };\n    }\n    const cmdEntry = commandResponses.get(command.toLowerCase());\n    if (cmdEntry) {\n        return { context, lines: renderResponse(cmdEntry.response, context) };\n    }\n    if (wildcardResponse != null) {\n        return { context, lines: renderResponse(wildcardResponse, context) };\n    }\n    return { context, lines: null };\n}\n\nif (screen) {\n    screen.focus();\n    screen.addEventListener('click', () => screen.focus());\n}\n\nlet buffer = '';\nconst history = [];\nlet historyIndex = -1;\n\nfunction appendOutput(text = '') {\n    if (!outputEl) return;\n    const lines = Array.isArray(text) ? text : String(text).split('\\n');\n    lines.forEach(line => {\n        const div = document.createElement('div');\n        div.className = 'terminal-row';\n        div.textContent = line;\n        outputEl.appendChild(div);\n    });\n    outputEl.parentElement?.scrollTo({ top: outputEl.parentElement.scrollHeight });\n}\n\nfunction updateInput() {\n    if (!inputEl) return;\n    inputEl.textContent = buffer;\n    outputEl?.parentElement?.scrollTo({ top: outputEl.parentElement.scrollHeight });\n}\n\nfunction showHints(message) {\n    if (!hintsEl) return;\n    hintsEl.innerHTML = message;\n}\n\nconst commands = {\n    help() {\n        const lines = [\n            'Available commands:',\n            '  help       Show this help message',\n            '  clear      Clear the screen',\n            '  date       Show the current date',\n            '  time       Show the current time',\n            '  version    Display Orbit OS version',\n            '  echo TEXT  Repeat the provided text'\n        ];\n        const custom = Array.from(customPatterns.values())\n            .filter(pattern => pattern && pattern !== '*')\n            .sort((a, b) => a.localeCompare(b));\n        if (custom.length) {\n            lines.push('', 'Custom responses:');\n            custom.forEach(pattern => {\n                const display = pattern.includes(' ') ? `  \"${pattern}\"` : `  ${pattern}`;\n                lines.push(display);\n            });\n        }\n        if (wildcardResponse != null) {\n            lines.push('', 'Wildcard handler active for unmatched commands.');\n        }\n        appendOutput(lines);\n    },\n    clear() {\n        if (outputEl) outputEl.innerHTML = '';\n    },\n    cls() {\n        commands.clear();\n    },\n    date() {\n        appendOutput(new Date().toLocaleDateString());\n    },\n    time() {\n        appendOutput(new Date().toLocaleTimeString());\n    },\n    version() {\n        appendOutput(`Orbit OS v${ORBIT_VERSION}`);\n    },\n    echo(...args) {\n        appendOutput(args.join(' '));\n    }\n};\n\nfunction executeCommand(raw) {\n    const input = raw.trim();\n    appendOutput(`orbit> ${input}`);\n    if (!input) return;\n\n    const [cmd, ...args] = input.split(/\\s+/);\n    const fn = commands[cmd.toLowerCase()];\n    if (fn) {\n        fn(...args);\n        return;\n    }\n\n    const { context, lines } = resolveCustomResponse(input, cmd, args);\n    if (Array.isArray(lines) && lines.length) {\n        appendOutput(lines);\n        return;\n    }\n\n    const fallbackSource = terminalConfig.fallback ?? defaultFallback;\n    const fallbackLines = renderResponse(fallbackSource, context);\n    if (fallbackLines.length) {\n        appendOutput(fallbackLines);\n    }\n}\n\nif (screen) {\n    screen.addEventListener('keydown', event => {\n        if (event.key === 'Backspace') {\n            event.preventDefault();\n            buffer = buffer.slice(0, -1);\n            updateInput();\n            return;\n        }\n        if (event.key === 'Enter') {\n            event.preventDefault();\n            const current = buffer;\n            history.push(current);\n            historyIndex = history.length;\n            executeCommand(current);\n            buffer = '';\n            updateInput();\n            return;\n        }\n        if (event.key === 'ArrowUp') {\n            event.preventDefault();\n            if (historyIndex > 0) {\n                historyIndex -= 1;\n                buffer = history[historyIndex] ?? '';\n                updateInput();\n            }\n            return;\n        }\n        if (event.key === 'ArrowDown') {\n            event.preventDefault();\n            if (historyIndex < history.length - 1) {\n                historyIndex += 1;\n                buffer = history[historyIndex] ?? '';\n            } else {\n                historyIndex = history.length;\n                buffer = '';\n            }\n            updateInput();\n            return;\n        }\n        if (event.key === 'Tab') {\n            event.preventDefault();\n            return;\n        }\n        if (event.key.length === 1 && !event.ctrlKey && !event.metaKey) {\n            buffer += event.key;\n            updateInput();\n            return;\n        }\n    });\n}\n\nconst introContext = createContext('', '', []);\nconst bannerSource = terminalConfig.banner ?? [\n    'Orbit OS v{version} CLI',\n    '(c) 2025 CyborgsDream',\n    'System date: {date}',\n    'System time: {time}',\n    ''\n];\nconst bannerLines = renderResponse(bannerSource, introContext);\nif (bannerLines.length) {\n    appendOutput(bannerLines);\n}\n\nconst hintMessage = typeof terminalConfig.hint === 'string'\n    ? terminalConfig.hint\n    : 'Type <strong>help</strong> to list available commands.';\nshowHints(hintMessage);\nupdateInput();\n",
  "textedit": "const id = WinAPI.createWindow('text-editor');\n\nconst win = document.getElementById(id);\nconst root = win?.querySelector('.text-editor');\nconst textarea = win?.querySelector('#text-editor-area');\nconst exportBtn = win?.querySelector('#text-editor-export');\nconst statusEl = win?.querySelector('#text-editor-status');\nconst statsEl = win?.querySelector('#text-editor-stats');\nconst menu = win?.querySelector('.text-editor-menu');\nconst optionsPanel = win?.querySelector('#text-editor-options');\nconst optionsBtn = menu?.querySelector('[data-action=\"options\"]');\nconst fileInput = win?.querySelector('#text-editor-file');\nconst wrapToggle = win?.querySelector('#text-editor-option-wrap');\nconst monoToggle = win?.querySelector('#text-editor-option-mono');\nconst autosaveToggle = win?.querySelector('#text-editor-option-autosave');\nconst filenameInput = win?.querySelector('#text-editor-option-filename');\nconst restoreBtn = win?.querySelector('#text-editor-restore');\n\nif (optionsPanel) {\n    optionsPanel.hidden = true;\n    optionsPanel.setAttribute('aria-hidden', 'true');\n}\n\nif (statusEl && !statusEl.dataset.state) {\n    statusEl.dataset.state = 'info';\n}\n\nconst STORAGE_KEY = 'orbit-textedit-draft';\nconst SETTINGS_KEY = 'orbit-textedit-settings';\nconst defaultSettings = {\n    wrap: true,\n    monospace: true,\n    autosave: true,\n    filename: 'orbit-notes.txt'\n};\n\nlet statusTimeout = null;\nlet autoSaveTimeout = null;\nlet optionsVisible = false;\nlet settings = { ...defaultSettings };\nlet currentFilename = defaultSettings.filename;\n\nfunction loadJsPDF(callback) {\n    if (window.jspdf) {\n        callback();\n        return;\n    }\n    const script = document.createElement('script');\n    script.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';\n    script.onload = callback;\n    document.head.appendChild(script);\n}\n\nfunction parseSettings() {\n    try {\n        const stored = localStorage.getItem(SETTINGS_KEY);\n        if (!stored) return;\n        const parsed = JSON.parse(stored);\n        if (typeof parsed === 'object' && parsed) {\n            settings = {\n                ...defaultSettings,\n                ...parsed\n            };\n        }\n    } catch (error) {\n        console.warn('Orbit OS text editor: unable to parse settings.', error);\n    }\n}\n\nfunction persistSettings() {\n    try {\n        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));\n    } catch (error) {\n        console.warn('Orbit OS text editor: unable to persist settings.', error);\n    }\n}\n\nfunction sanitizeFilename(name) {\n    if (typeof name !== 'string') return defaultSettings.filename;\n    const cleaned = name.replace(/[\\\\/:*?\"<>|]+/g, '_').trim();\n    if (!cleaned) return defaultSettings.filename;\n    return /\\.[A-Za-z0-9]+$/.test(cleaned) ? cleaned : `${cleaned}.txt`;\n}\n\nfunction setStatus(message, type = 'info', persist = false) {\n    if (!statusEl) return;\n    statusEl.textContent = message;\n    statusEl.dataset.state = type;\n    if (statusTimeout) {\n        clearTimeout(statusTimeout);\n        statusTimeout = null;\n    }\n    if (!persist) {\n        statusTimeout = setTimeout(() => {\n            if (statusEl.dataset.state === type) {\n                statusEl.textContent = 'Ready.';\n                statusEl.dataset.state = 'info';\n            }\n        }, 4000);\n    }\n}\n\nfunction updateStats() {\n    if (!textarea || !statsEl) return;\n    const text = textarea.value.trim();\n    const wordCount = text ? text.split(/\\s+/).length : 0;\n    const charCount = textarea.value.length;\n    statsEl.textContent = `Words: ${wordCount} | Characters: ${charCount}`;\n}\n\nfunction toggleOptions(force) {\n    if (!optionsPanel || !optionsBtn) return;\n    const shouldShow = typeof force === 'boolean' ? force : !optionsVisible;\n    optionsVisible = shouldShow;\n    optionsPanel.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');\n    optionsPanel.hidden = !shouldShow;\n    optionsBtn.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');\n}\n\nfunction applySettings() {\n    if (!root || !textarea) return;\n    currentFilename = sanitizeFilename(settings.filename);\n    if (filenameInput && document.activeElement !== filenameInput) {\n        filenameInput.value = currentFilename;\n    }\n    if (wrapToggle) {\n        wrapToggle.checked = Boolean(settings.wrap);\n    }\n    if (monoToggle) {\n        monoToggle.checked = Boolean(settings.monospace);\n    }\n    if (autosaveToggle) {\n        autosaveToggle.checked = Boolean(settings.autosave);\n    }\n    root.classList.toggle('text-editor--wrap', Boolean(settings.wrap));\n    root.classList.toggle('text-editor--mono', Boolean(settings.monospace));\n    textarea.wrap = settings.wrap ? 'soft' : 'off';\n}\n\nfunction saveDraftToStorage() {\n    if (!textarea) return;\n    try {\n        localStorage.setItem(STORAGE_KEY, textarea.value);\n    } catch (error) {\n        console.warn('Orbit OS text editor: unable to save draft.', error);\n    }\n}\n\nfunction scheduleAutoSave() {\n    if (!settings.autosave || !textarea) return;\n    if (autoSaveTimeout) {\n        clearTimeout(autoSaveTimeout);\n    }\n    autoSaveTimeout = setTimeout(() => {\n        saveDraftToStorage();\n        setStatus('Draft auto-saved.', 'success');\n    }, 1500);\n}\n\nfunction createDownload(blob, filename) {\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n}\n\nfunction handleSave() {\n    if (!textarea) return;\n    const filename = sanitizeFilename(filenameInput?.value || settings.filename);\n    settings.filename = filename;\n    currentFilename = filename;\n    persistSettings();\n    saveDraftToStorage();\n    if (autoSaveTimeout) {\n        clearTimeout(autoSaveTimeout);\n        autoSaveTimeout = null;\n    }\n    createDownload(new Blob([textarea.value], { type: 'text/plain' }), filename);\n    setStatus(`Saved as ${filename}.`, 'success');\n}\n\nfunction handleLoadFromFile(file) {\n    if (!textarea || !file) return;\n    const reader = new FileReader();\n    reader.onload = () => {\n        const value = typeof reader.result === 'string' ? reader.result : '';\n        textarea.value = value;\n        updateStats();\n        settings.filename = sanitizeFilename(file.name || settings.filename);\n        currentFilename = settings.filename;\n        persistSettings();\n        if (filenameInput) {\n            filenameInput.value = currentFilename;\n        }\n        saveDraftToStorage();\n        setStatus(`Loaded ${currentFilename}.`, 'success');\n    };\n    reader.onerror = () => {\n        setStatus('Failed to load file.', 'warning');\n    };\n    reader.readAsText(file);\n}\n\nfunction restoreDraft() {\n    if (!textarea) return;\n    const saved = localStorage.getItem(STORAGE_KEY);\n    if (saved == null) {\n        setStatus('No saved draft found.', 'warning');\n        return;\n    }\n    textarea.value = saved;\n    updateStats();\n    setStatus('Draft restored from local storage.', 'success');\n}\n\nfunction handleAction(action) {\n    if (!textarea) return;\n    switch (action) {\n        case 'options':\n            toggleOptions();\n            return;\n        case 'new':\n            if (textarea.value.trim() && !confirm('Clear the current document?')) {\n                return;\n            }\n            textarea.value = '';\n            updateStats();\n            saveDraftToStorage();\n            setStatus('New document created.');\n            break;\n        case 'save':\n            handleSave();\n            break;\n        case 'load':\n            if (fileInput) {\n                fileInput.click();\n            }\n            break;\n        case 'word-count':\n            updateStats();\n            setStatus('Word count updated.', 'info');\n            break;\n        default:\n            break;\n    }\n    if (action !== 'options') {\n        toggleOptions(false);\n    }\n}\n\nparseSettings();\napplySettings();\n\nif (menu) {\n    menu.addEventListener('click', event => {\n        const target = event.target;\n        if (!(target instanceof HTMLElement)) return;\n        const button = target.closest('[data-action]');\n        if (!(button instanceof HTMLElement)) return;\n        const action = button.dataset.action;\n        if (action) {\n            event.preventDefault();\n            handleAction(action);\n        }\n    });\n}\n\nif (optionsPanel && optionsBtn && win) {\n    win.addEventListener('click', event => {\n        const target = event.target;\n        if (!(target instanceof HTMLElement)) return;\n        if (!optionsVisible) return;\n        if (optionsPanel.contains(target) || optionsBtn.contains(target)) return;\n        toggleOptions(false);\n    });\n\n    win.addEventListener('keydown', event => {\n        if (optionsVisible && event.key === 'Escape') {\n            event.preventDefault();\n            toggleOptions(false);\n            optionsBtn.focus();\n        }\n    });\n}\n\nif (wrapToggle) {\n    wrapToggle.addEventListener('change', () => {\n        settings.wrap = wrapToggle.checked;\n        applySettings();\n        persistSettings();\n        setStatus(`Soft wrap ${settings.wrap ? 'enabled' : 'disabled'}.`, 'info');\n    });\n}\n\nif (monoToggle) {\n    monoToggle.addEventListener('change', () => {\n        settings.monospace = monoToggle.checked;\n        applySettings();\n        persistSettings();\n        setStatus(`Monospace mode ${settings.monospace ? 'enabled' : 'disabled'}.`, 'info');\n    });\n}\n\nif (autosaveToggle) {\n    autosaveToggle.addEventListener('change', () => {\n        settings.autosave = autosaveToggle.checked;\n        persistSettings();\n        setStatus(`Auto-save ${settings.autosave ? 'enabled' : 'disabled'}.`, 'info');\n        if (!settings.autosave && autoSaveTimeout) {\n            clearTimeout(autoSaveTimeout);\n            autoSaveTimeout = null;\n        }\n    });\n}\n\nif (filenameInput) {\n    filenameInput.addEventListener('change', () => {\n        const cleaned = sanitizeFilename(filenameInput.value);\n        filenameInput.value = cleaned;\n        settings.filename = cleaned;\n        currentFilename = cleaned;\n        persistSettings();\n        setStatus(`Default filename set to ${cleaned}.`, 'info');\n    });\n}\n\nif (restoreBtn) {\n    restoreBtn.addEventListener('click', () => {\n        restoreDraft();\n        toggleOptions(false);\n    });\n}\n\nif (fileInput) {\n    fileInput.addEventListener('change', () => {\n        const files = fileInput.files;\n        if (files && files[0]) {\n            handleLoadFromFile(files[0]);\n        }\n        fileInput.value = '';\n        toggleOptions(false);\n    });\n}\n\nif (textarea) {\n    textarea.addEventListener('input', () => {\n        updateStats();\n        setStatus('Editing‚Ä¶');\n        if (settings.autosave) {\n            scheduleAutoSave();\n        }\n    });\n\n    const savedDraft = localStorage.getItem(STORAGE_KEY);\n    if (savedDraft && savedDraft !== textarea.value) {\n        textarea.value = savedDraft;\n        setStatus('Restored auto-saved draft.', 'success');\n    }\n    updateStats();\n}\n\nif (exportBtn && textarea) {\n    exportBtn.addEventListener('click', () => {\n        loadJsPDF(() => {\n            const { jsPDF } = window.jspdf;\n            const doc = new jsPDF();\n            const lines = doc.splitTextToSize(textarea.value || '', 180);\n            doc.text(lines, 10, 10);\n            const pdfName = sanitizeFilename(settings.filename || defaultSettings.filename).replace(/\\.[^.]+$/, '') + '.pdf';\n            doc.save(pdfName);\n            setStatus('PDF exported successfully.', 'success');\n        });\n    });\n}\n"
}
    </script>

    <script>
        // State management
        const state = {
            windows: [],
            zIndex: 5,
            windowCount: 0,
            puzzleState: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0]
        };

        // DOM references
        const desktop = document.getElementById('desktop');
        const bootLoader = document.getElementById('boot-loader');
        const bootStatus = document.getElementById('boot-status');
        const defaultBootStatus = 'Initializing subsystems‚Ä¶';
        let bootLoaderBusy = true;
        let appData = null;
        let persistWindows = true;
        let windowStates = JSON.parse(localStorage.getItem('windowStates') || '{}');
        let windowStateSaveHandle = null;
        const DOCUMONSTER_STORAGE_KEY = 'documonster-studiopro-autosave-v0-1';
        const docuBridge = { frameWindow: null, ready: false, queue: [], lastWindowId: null };
        const scanxFrames = new Set();

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const ORBIT_VERSION = '0.2.0';
        const isSingleFile = true;
        window.ORBIT_VERSION = ORBIT_VERSION;
        window.ORBIT_TERMINAL_CONFIG = {};

        function setBootProgress(value, status) {
            if (!bootLoader) return;
            const clamped = Math.max(0, Math.min(1, value));
            bootLoader.style.setProperty('--boot-progress', clamped);
            if (status) {
                bootStatus.textContent = status;
            }
        }

        function showBootLoader(status) {
            if (!bootLoader) return;
            bootLoader.style.display = 'flex';
            void bootLoader.offsetWidth;
            bootLoader.classList.remove('boot-loader--hidden');
            bootLoader.setAttribute('aria-hidden', 'false');
            if (status) {
                bootStatus.textContent = status;
            }
        }

        function hideBootLoader() {
            if (!bootLoader) return Promise.resolve();
            if (bootLoader.classList.contains('boot-loader--hidden')) {
                bootLoader.style.display = 'none';
                bootLoader.style.setProperty('--boot-progress', 0);
                bootStatus.textContent = defaultBootStatus;
                bootLoader.setAttribute('aria-hidden', 'true');
                return Promise.resolve();
            }
            bootLoader.classList.add('boot-loader--hidden');
            bootLoader.setAttribute('aria-hidden', 'true');
            return new Promise(resolve => {
                const finish = () => {
                    bootLoader.style.display = 'none';
                    bootLoader.removeEventListener('transitionend', onTransitionEnd);
                    bootLoader.style.setProperty('--boot-progress', 0);
                    bootStatus.textContent = defaultBootStatus;
                    resolve();
                };
                const onTransitionEnd = (event) => {
                    if (event.target === bootLoader && event.propertyName === 'opacity') {
                        finish();
                    }
                };
                bootLoader.addEventListener('transitionend', onTransitionEnd);
                setTimeout(finish, 500);
            });
        }

        async function runBootLoaderDemo() {
            if (!bootLoader || bootLoaderBusy) return;
            bootLoaderBusy = true;
            try {
                showBootLoader('Demonstrating Orbit OS loader‚Ä¶');
                setBootProgress(0);
                const demoSteps = [
                    { progress: 0.2, status: 'Spinning up demo drives‚Ä¶', delay: 380 },
                    { progress: 0.45, status: 'Syncing color palettes‚Ä¶', delay: 420 },
                    { progress: 0.7, status: 'Preparing creative workspace‚Ä¶', delay: 520 },
                    { progress: 1, status: 'Demo complete!', delay: 620 }
                ];
                for (const step of demoSteps) {
                    await delay(step.delay);
                    setBootProgress(step.progress, step.status);
                }
                await delay(520);
                await hideBootLoader();
            } finally {
                bootLoaderBusy = false;
            }
        }

        function setTheme(theme) {
            const link = document.getElementById('theme-link');
            if (theme === 'retro') {
                link.removeAttribute('href');
            } else {
                link.setAttribute('href', `app-css/${theme}.css`);
            }
            localStorage.setItem('theme', theme);
        }

        function buildMenus(menus) {
            const bar = document.getElementById('menu-bar');
            const clock = document.getElementById('clock');
            bar.innerHTML = '';
            menus.forEach(menu => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.textContent = menu.label;
                const dropdown = document.createElement('div');
                dropdown.className = 'dropdown';
                menu.items.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = entry.label;
                    if (entry.action === 'set-theme' && entry.theme) {
                        div.addEventListener('click', () => {
                            setTheme(entry.theme);
                            dropdown.style.display = 'none';
                        });
                    } else if (entry.action === 'show-boot-loader') {
                        div.addEventListener('click', () => {
                            runBootLoaderDemo();
                            dropdown.style.display = 'none';
                        });
                    } else if (entry.type) {
                        div.addEventListener('click', () => {
                            openWindow(entry.type);
                            dropdown.style.display = 'none';
                        });
                    }
                    dropdown.appendChild(div);
                });
                item.appendChild(dropdown);
                bar.appendChild(item);
            });
            bar.appendChild(clock);
        }

        let lastIconTouch = 0;
        function buildIcons(icons) {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            icons.forEach(icon => {
                const el = document.createElement('div');
                el.className = 'icon';
                el.innerHTML = `<div class="icon-image">${icon.emoji}</div><div class="icon-label">${icon.label}</div>`;
                if (icon.type) {
                    const handler = (e) => {
                        const now = Date.now();
                        if (now - lastIconTouch < 1000) return;
                        lastIconTouch = now;
                        if (e.type === 'touchstart') e.preventDefault();
                        loadApp(icon.label.toLowerCase());
                    };
                    el.addEventListener('click', handler);
                    el.addEventListener('touchstart', handler, { passive: false });
                }
                container.appendChild(el);
            });
        }

        function buildIconTypeMap() {
            window.appTypeMap = {};
            if (!appData || !appData.icons) return;
            appData.icons.forEach(ic => {
                window.appTypeMap[ic.label.toLowerCase()] = ic.type;
            });
        }

        function scheduleWindowStateFlush() {
            if (windowStateSaveHandle) return;
            const flush = () => {
                windowStateSaveHandle = null;
                localStorage.setItem('windowStates', JSON.stringify(windowStates));
            };
            if (typeof requestIdleCallback === 'function') {
                windowStateSaveHandle = requestIdleCallback(flush, { timeout: 120 });
            } else {
                windowStateSaveHandle = setTimeout(flush, 60);
            }
        }

        function saveWindowState(type, el) {
            if (!persistWindows || !type) return;
            windowStates[type] = {
                top: el.offsetTop,
                left: el.offsetLeft,
                width: el.offsetWidth,
                height: el.offsetHeight
            };
            scheduleWindowStateFlush();
        }

        function preloadAppScripts() {
            if (window.ORBIT_SINGLE_FILE) return;
            if (!appData || !appData.icons) return;
            appData.icons.forEach(ic => {
                if (!ic.type) return;
                const safe = ic.label.toLowerCase().replace(/\s+/g,'');
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = `app-js/${safe}.js`;
                document.head.appendChild(link);
            });
            ['html-studio.html', 'documonster.html', 'comic-issue-forge.html', 'scanx.html'].forEach(p => {
                const l = document.createElement('link');
                l.rel = 'prefetch';
                l.href = p;
                document.head.appendChild(l);
            });
        }

        function buildWelcome(welcome) {
            const dialog = document.getElementById('welcome-dialog');
            dialog.querySelector('.window-title').textContent = welcome.title;
            const content = dialog.querySelector('.dialog-content');
            content.innerHTML = welcome.lines.map(l => `<p>${l}</p>`).join('');
            const buttons = document.createElement('div');
            buttons.className = 'dialog-buttons';
            const btn = document.createElement('div');
            btn.className = 'dialog-btn';
            btn.textContent = welcome.button;
            btn.onclick = () => closeDialog('welcome-dialog');
            buttons.appendChild(btn);
            content.appendChild(buttons);
            dialog.style.display = 'block';
        }
        
        // Initialize menus
        function initMenus() {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const dropdown = item.querySelector('.dropdown');
                if (dropdown) {
                    item.addEventListener('click', () => {
                        // Close all other dropdowns
                        document.querySelectorAll('.dropdown').forEach(d => {
                            if (d !== dropdown) d.style.display = 'none';
                        });
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });
                }
            });
            
            // Close dropdowns when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.menu-item')) {
                    document.querySelectorAll('.dropdown').forEach(d => {
                        d.style.display = 'none';
                    });
                }
            });
        }
        
        // Clock functionality
        function initClock(format) {
            let use24 = false;
            const clockEl = document.getElementById('clock');
            const locale = format || navigator.language || 'en-US';

            function updateClock() {
                const now = new Date();
                const opts = { hour12: !use24 };
                clockEl.textContent = now.toLocaleTimeString(locale, opts);
            }

            function toggle() {
                use24 = !use24;
                updateClock();
            }

            clockEl.addEventListener('click', toggle);
            clockEl.addEventListener('touchstart', toggle);

            setInterval(updateClock, 1000);
            updateClock();
        }
        
        // Window management helpers
        function openWindow(type) {
            console.log('Opening window:', type);
            const windowConfig = getWindowConfig(type);
            if (!windowConfig) return;

            let winWidth = windowConfig.width;
            let winHeight = windowConfig.height;
            if (window.innerWidth < winWidth) winWidth = window.innerWidth - 20;
            if (window.innerHeight < winHeight) winHeight = window.innerHeight - 40;

            const id = `window-${++state.windowCount}`;
            state.zIndex++;
            let top = 50 + state.windowCount * 20;
            let left = 50 + state.windowCount * 20;

            const clampNumber = (value, min, max) => {
                if (!Number.isFinite(value)) return min;
                if (max !== null && value > max) return max;
                if (min !== null && value < min) return min;
                return value;
            };

            const viewportWidth = window.innerWidth || 1280;
            const viewportHeight = window.innerHeight || 720;
            const margin = 20;

            const rawAvailableWidth = Math.max(viewportWidth - margin * 2, 0);
            const rawAvailableHeight = Math.max(viewportHeight - margin * 2, 0);
            const minWidth = Math.min(320, Math.max(rawAvailableWidth, Math.min(240, viewportWidth - margin)));
            const minHeight = Math.min(220, Math.max(rawAvailableHeight, Math.min(200, viewportHeight - margin)));
            const availableWidth = Math.max(rawAvailableWidth, minWidth);
            const availableHeight = Math.max(rawAvailableHeight, minHeight);

            if (persistWindows && windowStates[type]) {
                const saved = windowStates[type];
                winWidth = saved.width;
                winHeight = saved.height;
                top = saved.top;
                left = saved.left;
            }

            winWidth = clampNumber(winWidth, minWidth, availableWidth);
            winHeight = clampNumber(winHeight, minHeight, availableHeight);

            const maxLeft = Math.max(margin, viewportWidth - winWidth - margin);
            const maxTop = Math.max(margin, viewportHeight - winHeight - margin);

            top = clampNumber(top, margin, maxTop);
            left = clampNumber(left, margin, maxLeft);

            const windowHtml = `
                <div class="window" id="${id}" data-window-type="${type}"
                     data-init-width="${winWidth}"
                     data-init-height="${winHeight}"
                     data-init-top="${top}"
                     data-init-left="${left}"
                     style="top: ${top}px; left: ${left}px; width: ${winWidth}px; height: ${winHeight}px; z-index: ${state.zIndex}">
                    <div class="window-header">
                        <div class="window-title">${windowConfig.title}</div>
                        <div class="window-controls">
                            <div class="window-btn" onclick="minimizeWindow('${id}')">_</div>
                            <div class="window-btn" onclick="maximizeWindow('${id}')">‚ñ°</div>
                            <div class="window-btn" onclick="closeWindow('${id}')">√ó</div>
                        </div>
                    </div>
                    <div class="window-content">
                        ${windowConfig.content}
                    </div>
                </div>
            `;
            
            desktop.insertAdjacentHTML('beforeend', windowHtml);
            const winEl = document.getElementById(id);
            winEl.classList.add('zoom-init');
            winEl.dataset.minimized = 'false';
            winEl.dataset.initWidth = winEl.offsetWidth;
            winEl.dataset.initHeight = winEl.offsetHeight;
            winEl.dataset.initTop = winEl.offsetTop;
            winEl.dataset.initLeft = winEl.offsetLeft;
            requestAnimationFrame(() => winEl.classList.remove('zoom-init'));
            makeDraggable(id);
            state.windows.push(id);
            updateTaskBar();
            saveWindowState(type, winEl);
            const iframe = winEl.querySelector('iframe');
            let embeddedIframeContent = null;
            if (iframe) {
                const contentEl = winEl.querySelector('.window-content');
                contentEl?.classList.add('window-content--framed');
                const loader = document.createElement('div');
                loader.className = 'loading-overlay';
                loader.innerHTML = `
                    <div class="zx-loader" role="status" aria-live="polite">
                        <div class="zx-loader-title">Orbit OS loading‚Ä¶</div>
                        <div class="zx-loader-bar">
                            <div class="zx-loader-fill"></div>
                            <div class="zx-loader-glow"></div>
                        </div>
                        <div class="zx-loader-status">Please wait</div>
                    </div>
                `;
                loader.setAttribute('aria-busy', 'true');
                contentEl?.appendChild(loader);
                const removeLoader = () => loader.remove();
                iframe.addEventListener('load', () => {
                    removeLoader();
                    if (type === 'document-editor') {
                        docuBridge.frameWindow = iframe.contentWindow;
                        docuBridge.ready = false;
                    }
                    if (type === 'scanx') {
                        scanxFrames.add(iframe.contentWindow);
                    }
                }, { once: true });
                iframe.addEventListener('error', removeLoader, { once: true });
                if (iframe.dataset.orbitSrc && window.ORBIT_IFRAME_CONTENT) {
                    embeddedIframeContent = window.ORBIT_IFRAME_CONTENT[iframe.dataset.orbitSrc] || null;
                }
                if (embeddedIframeContent) {
                    iframe.srcdoc = embeddedIframeContent;
                    iframe.removeAttribute('data-orbit-src');
                }
                if (type === 'document-editor') {
                    docuBridge.frameWindow = iframe.contentWindow;
                    docuBridge.ready = false;
                    docuBridge.lastWindowId = id;
                }
                if (type === 'scanx') {
                    scanxFrames.add(iframe.contentWindow);
                }
            }
            if (type === 'console-log') {
                // lazily load console log handler and keep restore callback
                consoleLogsModulePromise.then(({ initConsoleLogs }) => {
                    const el = document
                        .getElementById(id)
                        ?.querySelector('.console-log-window');
                    if (el) {
                        const { restore } = initConsoleLogs({ container: el, removeAfter: null });
                        // store restore handler on the window element so we can clean up on close
                        winEl._restoreConsole = restore;
                    }
                });
            }
            // App specific initialization can be handled by each module
            return id;
        }
        
        function getWindowConfig(type) {
            if (!appData) return null;
            const now = new Date();
            const cfg = appData.windows[type];
            if (!cfg) return null;
            let calDays = '';
            if (typeof generateCalendarDays === 'function') {
                try {
                    calDays = generateCalendarDays(now);
                } catch {}
            }
            let content = cfg.content
                .replace(/\{DATE\}/g, now.toLocaleDateString())
                .replace(/\{TIME\}/g, now.toLocaleTimeString())
                .replace(/\{MONTH_YEAR\}/g, now.toLocaleString('default', { month: 'long', year: 'numeric' }))
                .replace(/\{CALENDAR_DAYS\}/g, calDays);
            content = content.replace(/<iframe([^>]*?)src="([^"]+)"([^>]*)>/g, '<iframe$1data-orbit-src=\"$2\"$3>');
            return { title: cfg.title, content, width: cfg.width, height: cfg.height };
        }

        function getDocuMonsterIframe() {
            return document.querySelector('.window[data-window-type="document-editor"] iframe');
        }

        function ensureDocuMonsterWindow() {
            const existingFrame = getDocuMonsterIframe();
            if (existingFrame && existingFrame.contentWindow) {
                docuBridge.frameWindow = existingFrame.contentWindow;
                const hostWindow = existingFrame.closest('.window');
                if (hostWindow) {
                    hostWindow.style.display = 'flex';
                    hostWindow.dataset.minimized = 'false';
                    hostWindow.style.zIndex = ++state.zIndex;
                }
                return docuBridge.frameWindow;
            }
            const newId = openWindow('document-editor');
            if (!newId) return null;
            docuBridge.lastWindowId = newId;
            const winEl = document.getElementById(newId);
            const frame = winEl ? winEl.querySelector('iframe') : null;
            if (frame && frame.contentWindow) {
                docuBridge.frameWindow = frame.contentWindow;
            }
            return frame ? frame.contentWindow : null;
        }

        function flushDocuMonsterQueue() {
            if (!docuBridge.ready || !docuBridge.frameWindow) return;
            while (docuBridge.queue.length) {
                const factory = docuBridge.queue.shift();
                if (typeof factory !== 'function') continue;
                try {
                    docuBridge.frameWindow.postMessage(factory(), '*');
                } catch (err) {
                    console.error('Failed to deliver message to Docu Monster', err);
                }
            }
        }

        function sendToDocuMonster(factory) {
            const target = ensureDocuMonsterWindow();
            if (!target) return;
            if (docuBridge.ready) {
                try {
                    target.postMessage(factory(), '*');
                } catch (err) {
                    console.error('Docu Monster communication error', err);
                }
            } else {
                docuBridge.queue.push(factory);
            }
        }

        function handleScanxDocument(payload) {
            if (!payload || !payload.document) return;
            try {
                localStorage.setItem(DOCUMONSTER_STORAGE_KEY, JSON.stringify(payload.document));
            } catch (err) {
                console.warn('Unable to persist ScanX document', err);
            }
            const statusBar = document.getElementById('status-bar');
            const pageTotal = typeof payload.pageCount === 'number' && Number.isFinite(payload.pageCount)
                ? payload.pageCount
                : (Array.isArray(payload.document?.pages) ? payload.document.pages.length : 0);
            if (statusBar) {
                const name = payload.name || 'a document';
                statusBar.textContent = `ScanX prepared ${name} for Docu Monster${pageTotal ? ` (${pageTotal} pages)` : ''}‚Ä¶`;
            }
            sendToDocuMonster(() => ({
                type: 'documonster:load-document',
                payload: {
                    document: payload.document,
                    pageCount: pageTotal,
                    meta: {
                        source: 'ScanX',
                        name: payload.name || 'scanx-import.dx',
                        status: 'ScanX document loaded.',
                        transient: false,
                        persistToStorage: true,
                        pageCount: pageTotal
                    }
                }
            }));
        }

        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || typeof data !== 'object') return;
            if (data.type === 'documonster:ready') {
                if (event.source) {
                    docuBridge.frameWindow = event.source;
                }
                docuBridge.ready = true;
                flushDocuMonsterQueue();
            } else if (data.type === 'documonster:document-loaded') {
                if (data.payload && data.payload.source === 'ScanX') {
                    scanxFrames.forEach(frame => {
                        try {
                            frame.postMessage({ type: 'scanx:documonster-confirm', payload: data.payload }, '*');
                        } catch (err) {
                            console.warn('Failed to notify ScanX frame', err);
                        }
                    });
                    const statusBar = document.getElementById('status-bar');
                    if (statusBar) {
                        const name = data.payload.name || 'the document';
                        const pages = data.payload.pageCount != null ? data.payload.pageCount : '?';
                        statusBar.textContent = `Docu Monster opened ${name} from ScanX (${pages} pages).`;
                    }
                }
            } else if (data.type === 'scanx:open-document') {
                if (event.source) {
                    scanxFrames.add(event.source);
                }
                handleScanxDocument(data.payload || {});
            }
        });
        
        function closeWindow(id) {
            const win = document.getElementById(id);
            if (!win) return;
            const type = win.dataset.windowType;
            if (type === 'document-editor') {
                docuBridge.ready = false;
                docuBridge.frameWindow = null;
                docuBridge.lastWindowId = null;
                docuBridge.queue.length = 0;
            }
            if (type === 'scanx') {
                const frame = win.querySelector('iframe');
                if (frame && frame.contentWindow) {
                    scanxFrames.delete(frame.contentWindow);
                }
            }
            if (persistWindows && type) {
                delete windowStates[type];
                localStorage.setItem('windowStates', JSON.stringify(windowStates));
            }
            if (win._restoreConsole) {
                win._restoreConsole();
            }

            let cleaned = false;
            const cleanup = () => {
                if (cleaned) return;
                cleaned = true;
                if (win.isConnected) {
                    win.remove();
                }
                console.log('Window closed:', id);
            };

            state.windows = state.windows.filter(winId => winId !== id);
            updateTaskBar();

            const style = getComputedStyle(win);
            const parseTimeList = value => value.split(',').map(part => {
                const trimmed = part.trim();
                if (!trimmed) return 0;
                if (trimmed.endsWith('ms')) return parseFloat(trimmed) || 0;
                if (trimmed.endsWith('s')) return (parseFloat(trimmed) || 0) * 1000;
                const numeric = parseFloat(trimmed);
                return Number.isFinite(numeric) ? numeric * 1000 : 0;
            });
            const durations = parseTimeList(style.transitionDuration || '0s');
            const delays = parseTimeList(style.transitionDelay || '0s');
            const count = Math.max(durations.length, delays.length);
            let maxDuration = 0;
            for (let i = 0; i < count; i++) {
                const duration = durations[i] ?? durations[durations.length - 1] ?? 0;
                const delay = delays[i] ?? delays[delays.length - 1] ?? 0;
                maxDuration = Math.max(maxDuration, duration + delay);
            }

            const finish = () => {
                cleanup();
            };

            if (!win.classList.contains('zoom-out')) {
                win.classList.add('zoom-out');
            }

            if (maxDuration > 0) {
                const fallback = setTimeout(finish, maxDuration + 50);
                win.addEventListener('transitionend', event => {
                    if (event.target === win) {
                        clearTimeout(fallback);
                        finish();
                    }
                }, { once: true });
            } else {
                finish();
            }
        }

       function minimizeWindow(id) {
           const window = document.getElementById(id);
           if (window) {
               window.style.display = 'none';
                window.dataset.minimized = 'true';
                console.log('Window minimized:', id);
                updateTaskBar();
            }
        }

        function updateTaskBar() {
            const bar = document.getElementById('task-bar');
            bar.innerHTML = '';
            state.windows.forEach(id => {
                const win = document.getElementById(id);
                if (!win) return;
                const btn = document.createElement('div');
                btn.className = 'task-btn';
                const isMinimized = win.style.display === 'none' || win.dataset.minimized === 'true';
                if (!isMinimized) btn.classList.add('active');
                btn.textContent = win.querySelector('.window-title').textContent;
                btn.onclick = () => {
                    const minimized = win.style.display === 'none' || win.dataset.minimized === 'true';
                    if (minimized) {
                        win.style.display = 'flex';
                        win.dataset.minimized = 'false';
                        win.style.zIndex = ++state.zIndex;
                        saveWindowState(win.dataset.windowType, win);
                    } else {
                        minimizeWindow(id);
                    }
                    updateTaskBar();
                };
                bar.appendChild(btn);
            });
        }

        function initTaskBarMenu() {
            const bar = document.getElementById('task-bar');
            const menu = document.getElementById('taskbar-menu');
            menu.innerHTML = '';
            const pin = document.createElement('div');
            pin.textContent = 'Pin Mini App';
            pin.onclick = () => {
                openWindow('mini-app');
                menu.style.display = 'none';
            };
            menu.appendChild(pin);

            bar.addEventListener('contextmenu', e => {
                e.preventDefault();
                menu.style.left = e.clientX + 'px';
                menu.style.display = 'block';
            });

            document.addEventListener('click', () => {
                menu.style.display = 'none';
            });
        }
        
       function maximizeWindow(id) {
           const window = document.getElementById(id);
           if (window) {
                if (window.dataset.maximized === 'true') {
                    window.style.width = window.dataset.initWidth + 'px';
                    window.style.height = window.dataset.initHeight + 'px';
                    window.style.top = window.dataset.initTop + 'px';
                    window.style.left = window.dataset.initLeft + 'px';
                    window.dataset.maximized = 'false';
                    console.log('Window restored:', id);
                } else {
                    window.dataset.initWidth = window.offsetWidth;
                    window.dataset.initHeight = window.offsetHeight;
                    window.dataset.initTop = window.offsetTop;
                    window.dataset.initLeft = window.offsetLeft;
                    window.style.width = '95%';
                    window.style.height = '85%';
                    window.style.top = '30px';
                    window.style.left = '10px';
                    window.dataset.maximized = 'true';
                    console.log('Window maximized:', id);
                }
                window.dataset.minimized = 'false';
                window.style.zIndex = ++state.zIndex;
                updateTaskBar();
                saveWindowState(window.dataset.windowType, window);
            }
        }
        
        // Draggable windows
        function makeDraggable(windowId) {
            const window = document.getElementById(windowId);
            const header = window.querySelector('.window-header');

            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            header.style.touchAction = 'none';
            header.onpointerdown = dragPointerDown;

            function dragPointerDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onpointerup = closeDragElement;
                document.onpointermove = elementDrag;
                window.style.zIndex = ++state.zIndex;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                window.style.top = (window.offsetTop - pos2) + "px";
                window.style.left = (window.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onpointerup = null;
                document.onpointermove = null;
                saveWindowState(window.dataset.windowType, window);
            }
        }
        
        function closeDialog(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // Initialize everything
        const consoleLogsModulePromise = Promise.resolve({ initConsoleLogs });

        async function init() {
            const { initConsoleLogs } = await consoleLogsModulePromise;
            if (!window.__orbitConsoleMonitor) {
                const buffer = document.createElement('div');
                initConsoleLogs({
                    container: buffer,
                    removeAfter: null,
                    filter: ['log', 'info', 'warn', 'error']
                });
                window.__orbitConsoleMonitor = true;
            }
            console.info('Orbit OS boot sequence starting‚Ä¶');
            showBootLoader('Initializing video BIOS‚Ä¶');
            setBootProgress(0.08, 'Initializing video BIOS‚Ä¶');
            console.info('Video BIOS initialized.');

            setTheme('retro');
            setBootProgress(0.18, 'Calibrating color palette‚Ä¶');
            console.info('Theme set to retro.');
            const appDataEl = document.getElementById('orbit-app-data');
            const iframeDataEl = document.getElementById('orbit-iframe-data');
            const appScriptsEl = document.getElementById('orbit-app-scripts');
            window.ORBIT_SINGLE_FILE = true;
            window.ORBIT_IFRAME_CONTENT = iframeDataEl ? JSON.parse(iframeDataEl.textContent) : {};
            window.ORBIT_APP_SCRIPTS = appScriptsEl ? JSON.parse(appScriptsEl.textContent) : {};
            setBootProgress(0.38, 'Loading system manifest‚Ä¶');
            appData = appDataEl ? JSON.parse(appDataEl.textContent) : null;
            window.ORBIT_TERMINAL_CONFIG = appData.terminal || {};
            console.info('System manifest loaded.');
            setBootProgress(0.5, 'Mounting creative drives‚Ä¶');

            persistWindows = appData.settings && appData.settings.persistWindows !== false;
            buildMenus(appData.menus);
            setBootProgress(0.62, 'Configuring menu system‚Ä¶');
            console.info('Menus configured.');
            buildIcons(appData.icons);
            buildIconTypeMap();
            setBootProgress(0.74, 'Arranging desktop icons‚Ä¶');
            preloadAppScripts();
            document.getElementById('status-bar').textContent = appData.status;
            initClock(appData.settings && appData.settings.clockFormat);
            initMenus();
            updateTaskBar();
            initTaskBarMenu();
            setBootProgress(0.9, 'Starting essential services‚Ä¶');
            console.info('Core services started.');

            await delay(220);
            setBootProgress(1, 'Orbit OS ready!');
            await delay(280);
            await hideBootLoader();

            buildWelcome(appData.welcome);
            openWindow('console-log');
            bootLoaderBusy = false;
            console.info('Desktop ready.');
            console.log('App1 initialized');
        }

        function updateViewportHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
        }

        window.addEventListener('resize', updateViewportHeight);
        window.addEventListener('orientationchange', updateViewportHeight);
        updateViewportHeight();

        window.onload = init;
    </script>

    <script>
(function(){
    const loaded=new Set();
    function loadApp(name){
        const safe=name.toLowerCase().replace(/\s+/g,'');
        if(loaded.has(safe)){
            const type=window.appTypeMap && window.appTypeMap[name.toLowerCase()];
            if(type && window.openWindow) window.openWindow(type);
            return;
        }
        const appScripts = window.ORBIT_APP_SCRIPTS || {};
        const normalized = safe.replace(/[^a-z0-9]/g, '');
        const scriptContent = appScripts[safe] || appScripts[normalized];
        if (scriptContent) {
            const script=document.createElement('script');
            script.text = scriptContent + "\n//# sourceURL=orbit-" + safe + ".js";
            document.body.appendChild(script);
            loaded.add(safe);
            return;
        }
        const script=document.createElement('script');
        const base=(window.ORBIT_BASE_PATH||'');
        script.src=`${base}app-js/${safe}.js`;
        script.onload=()=>loaded.add(safe);
        document.body.appendChild(script);
    }
    function createWindow(type){
        if(window.openWindow) return window.openWindow(type);
    }
    function closeWin(id){ if(window.closeWindow) window.closeWindow(id); }
    function minimizeWin(id){ if(window.minimizeWindow) window.minimizeWindow(id); }
    function maximizeWin(id){ if(window.maximizeWindow) window.maximizeWindow(id); }
    window.loadApp=loadApp;
    window.WinAPI={
        createWindow,
        closeWindow:closeWin,
        minimizeWindow:minimizeWin,
        maximizeWindow:maximizeWin
    };
})();

    </script>
</body>
</html>
